<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-01-25 Thu 16:04 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SP REST API Cookbook  <br> SP v8.3  <br> API v3 </title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Arbor Networks" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">SP REST API Cookbook  <br> SP v8.3  <br> API v3 </h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgc41615d">1. Introduction</a>
<ul>
<li><a href="#org20f53fc">1.1. Conventions Used in this Book</a></li>
<li><a href="#org307939b">1.2. SP APIs</a></li>
<li><a href="#orge1491c4">1.3. Guiding Principles of the SP REST API</a>
<ul>
<li><a href="#org4864eb1">1.3.1. JSON API</a></li>
<li><a href="#orgc5c2568">1.3.2. Useful Errors for Humans and Computers</a></li>
<li><a href="#orgb4a2c53">1.3.3. Backward compatibility</a></li>
<li><a href="#orgdf4e0eb">1.3.4. Discoverability</a></li>
</ul>
</li>
<li><a href="#orgd221578">1.4. Online Reference Manual</a></li>
</ul>
</li>
<li><a href="#org3db51ae">2. Set-up</a>
<ul>
<li><a href="#org24040ed">2.1. Permissions, Access Tokens, and SSL Certificates</a>
<ul>
<li><a href="#org9c536e4">2.1.1. Access Tokens</a></li>
<li><a href="#org18702f9">2.1.2. SSL Certificates</a></li>
</ul>
</li>
<li><a href="#orgbb2e57b">2.2. Useful Tools</a>
<ul>
<li><a href="#org75a0727">2.2.1. Any web browser</a></li>
<li><a href="#org983d45a">2.2.2. cURL</a></li>
<li><a href="#orgf769ff2">2.2.3. HTTPie</a></li>
<li><a href="#orgebfcbfb">2.2.4. Postman</a></li>
<li><a href="#org962c323">2.2.5. <code>jq</code></a></li>
</ul>
</li>
<li><a href="#orgd541acf">2.3. The Python Environment</a>
<ul>
<li><a href="#org14b6c33">2.3.1. The <code>requests</code> library</a></li>
</ul>
</li>
<li><a href="#orgddd9410">2.4. Summary</a></li>
</ul>
</li>
<li><a href="#orgc94c973">3. Reports</a>
<ul>
<li><a href="#org045f106">3.1. Example: Time between an Alert and a Mitigation</a></li>
<li><a href="#org400aae1">3.2. Example: The Collector with the most system alerts</a></li>
<li><a href="#org23bd1a6">3.3. Example: Plotting Alert Data</a></li>
</ul>
</li>
<li><a href="#org7da7022">4. Configuration</a>
<ul>
<li><a href="#orgb5ad129">4.1. Example: Adding a Managed Object using business information</a></li>
<li><a href="#org81e95d2">4.2. Example: Setting Appliance Monitoring Limits</a></li>
</ul>
</li>
<li><a href="#org10a0774">5. Operations</a>
<ul>
<li><a href="#orgf393fb9">5.1. Example: Starting a Mitigation</a></li>
<li><a href="#org6f7227d">5.2. Example: Adding an annotation</a></li>
</ul>
</li>
<li><a href="#org3afbc0b">6. Examples in Languages other than Python</a>
<ul>
<li><a href="#orge1d0610">6.1. Java</a></li>
<li><a href="#org810dbea">6.2. bash</a></li>
<li><a href="#orgf3b2f9c">6.3. PHP</a></li>
<li><a href="#orgfe0b57a">6.4. C</a></li>
</ul>
</li>
<li><a href="#org94a5d57">7. Appendices</a>
<ul>
<li><a href="#orga6e892c">7.1. License</a></li>
<li><a href="#org3287bfe">7.2. Versioning</a></li>
<li><a href="#org6921ad0">7.3. Reference Manual</a></li>
<li><a href="#org63ebd39">7.4. Reporting Errors to Arbor</a></li>
<li><a href="#org17cecff">7.5. Acknowledgments</a></li>
<li><a href="#orgf624cd4">7.6. Contributing and other technical details</a>
<ul>
<li><a href="#org8b77b41">7.6.1. Contributing</a></li>
<li><a href="#org8b6728b">7.6.2. Technical details</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgc41615d" class="outline-2">
<h2 id="orgc41615d"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
Arbor Networks SP is a very sophisticated piece of software that
gives visibility into the network traffic on networks ranging up to
those that are massively large; SP support hundreds of configuration
parameters for defining what exactly visibility means and the
reported data from SP is very rich and very broad.  Almost no
network operators who use SP make use of the entire range of its
capabilities.
</p>

<p>
The configuration of SP and the management of its data is done in
two ways: the SP web-based UI and the web-based API interfaces to
SP.  While SP has had APIs for many versions, the versions starting
with 8.1 have had a REST API as one of the options for configuration
and data retrieval.
</p>

<p>
This book describes how to programmatically configure SP and get
data about your network from SP using a json:api-based REST API to
SP.
</p>

<p>
REST is a common, HTTP-based protocol that defines web-based
services that allow clients (sometimes called &ldquo;requesting systems&rdquo;)
to access and manipulate textual representations (in the case of SP,
JSON representations) of SP configuration and reporting data
(generically called &ldquo;Web resources&rdquo;) using a uniform and predefined
set of stateless, from the client&rsquo;s perspective, operations.  All of
the state, configuration and data, is maintained within SP, not by
the API client.  The API described here is the SP REST API.  SP has
other APIs (SOAP and WebServices) that are documented in other SP
documentation.  The intent of the SP REST API is to, over time,
include all of the functionality of the SOAP and WebServices API, at
which point those will be deprecated.
</p>

<p>
The SP REST API uses a particular API-focused JavaScript Object
Notation (JSON) format to represent its data.  JSON is a textual
representation of data in collections (Python calls these
dictionaries, C calls them structures, Go calls them maps, Ruby and
Perl call them hashes) and lists (Python and Perl also calls them
lists, Go calls them slices, C and Ruby call them arrays).  The
elements in collections and lists are other collections, other
lists, Boolean values, numeric values, or string values as
described by the JSON specification (<a href="http://www.json.org/">http://www.json.org/</a>).  The
particular JSON representation that the SP REST API adheres to is
called json:api (<a href="http://jsonapi.org/">http://jsonapi.org/</a>); the rules and guidelines
described in Version 1.0 of the json:api specification are
implemented for the SP REST API.
</p>

<p>
The SP REST API is under development.  Each release of Arbor
Networks SP after version 8.0 includes a REST API that has more
features than the prior release.  Arbor Networks expects that the
REST API will not be complete for several years, but incremental
steps will be included in each version of SP.  This book describes
Version 3 of the API that is included in SP 8.3.  (The versioning
mechanism is described in more detail in the section <a href="#orge1491c4">1.3</a>.)
</p>

<p>
This book is intended for the SP administrator or advanced user who
has some programming or shell scripting experience and who wants to
automate network management or reporting tasks, or combine SP data
with other sources of data for reporting, configuration, or decision
making.
</p>
</div>


<div id="outline-container-org20f53fc" class="outline-3">
<h3 id="org20f53fc"><span class="section-number-3">1.1</span> Conventions Used in this Book</h3>
<div class="outline-text-3" id="text-1-1">
<p>
Things in a fixed-width font are either input or output, for the
most part.
</p>

<p>
See the section <a href="#org63ebd39">7.4</a> for advice on how to
provide feedback.
</p>

<p>
This is a collaborative document, feedback, additions, edits,
changes, modifications, etc. are all greatly appreciated.  Please
see the section <a href="#orgf624cd4">7.6</a> for advice
on ways to contribute.
</p>
</div>
</div>

<div id="outline-container-org307939b" class="outline-3">
<h3 id="org307939b"><span class="section-number-3">1.2</span> SP APIs</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Arbor Networks SP has three officially supported types of APIs: the
SOAP API, the WebServices API, and the REST API.
</p>

<p>
The SOAP and WebServices API are documented in the online SP
documentation and in the API software development kit available
from the SP web UI at the Administration &gt; Download Arbor API SDK
menu item.
</p>

<p>
Arbor Networks has decided to focus on the REST API (the topic of
this book) for its future development with the goal of encompassing
the functionality of the other APIs, the SP command-line interface,
and all of the functionality provided by the web-based UI that is
the most familiar to SP users.
</p>

<p>
As you develop clients for SP&rsquo;s APIs, keep in mind that the REST
API is the officially preferred API for SP.  However, in this
version (and, likely, several upcoming versions), the REST API does
not provide all of the functionality of the SOAP and WebServices
APIs.  Arbor recommends using the REST API where you can in your
clients, and augmenting it with API requests to the other APIs,
replacing those requests as the REST API gains functionality.
</p>
</div>
</div>

<div id="outline-container-orge1491c4" class="outline-3">
<h3 id="orge1491c4"><span class="section-number-3">1.3</span> Guiding Principles of the SP REST API</h3>
<div class="outline-text-3" id="text-1-3">
<p>
As Arbor Networks develops the REST API, we abide by some standards
and principles that you can rely on as you you create API clients.
</p>
</div>
<div id="outline-container-org4864eb1" class="outline-4">
<h4 id="org4864eb1"><span class="section-number-4">1.3.1</span> JSON API</h4>
<div class="outline-text-4" id="text-1-3-1">
<p>
The first of these guidelines is that the structure of the JSON
that is used for input and output from the API follows the JSON
API specification (<a href="http://jsonapi.org/">http://jsonapi.org/</a>).  While you don&rsquo;t need to
understand the specification to use the SP REST API, it may help
answer some questions about why things are the way they are in the
API, and how Arbor is likely to handle future additions to the
API.
</p>
</div>
</div>
<div id="outline-container-orgc5c2568" class="outline-4">
<h4 id="orgc5c2568"><span class="section-number-4">1.3.2</span> Useful Errors for Humans and Computers</h4>
<div class="outline-text-4" id="text-1-3-2">
<p>
The second guideline is that the SP REST API should provide you
with useful error messages that can be interpreted by both a human
and a computer program.  Arbor makes use of a combination of HTTP
response codes as described in Section 10 of RFC 2616
(<a href="https://www.ietf.org/rfc/rfc2616.txt">https://www.ietf.org/rfc/rfc2616.txt</a>) and error objects that
contain some or all of an error title string, an error detail
string, an HTTP status code string, and a pointer to the error in
the input.  An example error object that resulted from the REST
client requesting a nonexistent endpoint is:
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Error Example</label><pre class="src src-json" id="orge5b3245">{
    <span style="color: #81A1C1;">"detail"</span>: <span style="color: #A3BE8C;">"Resource https://leader.example.com/api/sp/asdf could not be found."</span>,
    <span style="color: #81A1C1;">"meta"</span>: {
        <span style="color: #81A1C1;">"api"</span>: <span style="color: #A3BE8C;">"SP"</span>,
        <span style="color: #81A1C1;">"api_version"</span>: <span style="color: #A3BE8C;">"2"</span>,
        <span style="color: #81A1C1;">"sp_build_id"</span>: <span style="color: #A3BE8C;">"HGRD"</span>,
        <span style="color: #81A1C1;">"sp_version"</span>: <span style="color: #A3BE8C;">"8.3"</span>
    },
    <span style="color: #81A1C1;">"status"</span>: <span style="color: #A3BE8C;">"404"</span>,
    <span style="color: #81A1C1;">"title"</span>: <span style="color: #A3BE8C;">"Missing resource error."</span>
}
</pre>
</div>
<p>
This error object contains the error detail, status code, and
title along with the standard <code>"meta"</code> section which gives
information about the API itself.  Error objects are further
described in the JSON API specification in the <i>Errors</i> section
(<a href="http://jsonapi.org/format/#errors">http://jsonapi.org/format/#errors</a>).
</p>
</div>
</div>

<div id="outline-container-orgb4a2c53" class="outline-4">
<h4 id="orgb4a2c53"><span class="section-number-4">1.3.3</span> Backward compatibility</h4>
<div class="outline-text-4" id="text-1-3-3">
<p>
Another guideline is that the REST API will maintain
backward-compatibility as it increases in version.  The version for
the API is a combination of the SP version and the API version
number; in the example above the API version would be reported as
&ldquo;SP v8.3, API v2&rdquo;.  It is possible that there will be an API v2
for SP v8.2.3 that is different from the API v2 for SP v8.3.
Arbor Networks will retain at least one prior version of the API
in each version of SP so if you have written clients that use v3
of the API in SP v8.4 and upgrade to SP v8.5 that defaults API v4,
you can still access API v3 in SP v8.5 with your clients while you
work to migrate them to the latest version.  API version increases
will happen when Arbor Networks introduces a change in the API
that could potentially break existing clients; this includes
things like changing the name of an API key, changing the type of
an API value, or removing an API endpoint.  Adding keys and
endpoints is not considered breaking, as well-written API clients
should ignore extra data returned to them.
</p>
</div>
</div>
<div id="outline-container-orgdf4e0eb" class="outline-4">
<h4 id="orgdf4e0eb"><span class="section-number-4">1.3.4</span> Discoverability</h4>
<div class="outline-text-4" id="text-1-3-4">
<p>
Arbor Networks makes every effort to ensure the SP REST API is
fully discoverable from the root URL, <code>/api/sp/</code>.  Starting there,
every response you receive may contain an object called
<code>relationships</code> that will lead you to the related objects.  There
are no detached nodes of the API tree.  This is called Hypermedia
as the Engine of Application State (HATEOAS) and is defined<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
by Roy T. Fielding (the inventor of REST) as:
</p>
<blockquote>
<p>
A REST API should be entered with no prior knowledge beyond the
initial URI (bookmark) and set of standardized media types that
are appropriate for the intended audience (i.e., expected to be
understood by any client that might use the API). From that point
on, all application state transitions must be driven by client
selection of server-provided choices that are present in the
received representations or implied by the user’s manipulation of
those representations. The transitions may be determined (or
limited by) the client’s knowledge of media types and resource
communication mechanisms, both of which may be improved on-the-fly
(e.g., code-on-demand).
</p>
</blockquote>
<p>
In the case of the SP REST API, the &ldquo;initial URI&rdquo; is
<a href="https://sp-leader.example.com/api/sp/">https://sp-leader.example.com/api/sp/</a> and following that
the elements in the <code>links</code> objects provide connectivity to the
rest of the API.
</p>
</div>
</div>
</div>

<div id="outline-container-orgd221578" class="outline-3">
<h3 id="orgd221578"><span class="section-number-3">1.4</span> Online Reference Manual</h3>
<div class="outline-text-3" id="text-1-4">
<p>
The SP REST API includes a reference manual for each endpoint with
a description of each key in that endpoint; there are very few
examples of using the API in the reference manual (hence this
book), but all of the endpoints and their properties are listed for
all of the versions of the API supported on the installed version
of SP.
</p>

<p>
In addition, changes between versions are in the Deprecation Policy
section of the reference manual.
</p>

<p>
This book will often make reference to the online reference manual;
having access to that manual will be helpful as you develop
clients.  The online reference manual is available from the Arbor
SP UI by selecting the &ldquo;REST API Documentation&rdquo; from the
&ldquo;Administration&rdquo; menu.  A PDF copy of this is available from your
local engineer or from the Arbor Technical Assistance Center.
</p>
</div>
</div>
</div>

<div id="outline-container-org3db51ae" class="outline-2">
<h2 id="org3db51ae"><span class="section-number-2">2</span> Set-up</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org24040ed" class="outline-3">
<h3 id="org24040ed"><span class="section-number-3">2.1</span> Permissions, Access Tokens, and SSL Certificates</h3>
<div class="outline-text-3" id="text-2-1">
<p>
The current version of the SP REST API does not support
authorization.  That is, granting someone an API access token is
the same as granting them &ldquo;<code>admin</code>&rdquo; access to the SP deployment.
</p>
</div>
<div id="outline-container-org9c536e4" class="outline-4">
<h4 id="org9c536e4"><span class="section-number-4">2.1.1</span> Access Tokens</h4>
<div class="outline-text-4" id="text-2-1-1">
<p>
SP REST API tokens are created from the SP command line interface
with the command:
</p>
<div class="org-src-container">
<pre class="src src-sh">/ services aaa local apitoken generate admin <span style="color: #A3BE8C;">"comment"</span>
</pre>
</div>
<p>
where <code>admin</code> is the username of the administrative user and
<code>"comment"</code> is a useful comment for you.  Arbor recommends the
local name of the user and the date the token is created, for
example:
</p>
<div class="org-src-container">
<pre class="src src-sh">/ services aaa local apitoken generate admin <span style="color: #A3BE8C;">"fred@example.com 2017-07-01"</span>
</pre>
</div>

<p>
You can list the tokens that have been created with the command:
</p>
<div class="org-src-container">
<pre class="src src-sh">/ services aaa local apitoken show
</pre>
</div>
<p>
which will result in a list of API tokens and their associated
comments, something like this:
</p>
<pre class="example">
admin:
 wz8SmDeJRSkz_0kNbdSajSQ_Jk82EVOqRU6CPU_O  susy@example.com - 2017-06-01
 YK3va5ATpXdmTWwfgzZPBckrj7zue205CzjLBtK5  fred@example.com - 2017-07-01
</pre>
<p>
To remove the token <code>YK3va5ATpXdmTWwfgzZPBckrj7zue205CzjLBtK5</code> type
the command:
</p>
<div class="org-src-container">
<pre class="src src-sh">/ services aaa local apitoken remove YK3va5ATpXdmTWwfgzZPBckrj7zue205CzjLBtK5
</pre>
</div>
</div>
</div>
<div id="outline-container-org18702f9" class="outline-4">
<h4 id="org18702f9"><span class="section-number-4">2.1.2</span> SSL Certificates</h4>
<div class="outline-text-4" id="text-2-1-2">
<p>
All SP REST API requests should use the secure HTTP transport
(<code>https</code>).  This will ensure that your API key and the contents of
requests and responses are encrypted.  In addition, SP will
attempt to redirect unencrypted HTTP requests to the encrypted
port, but that can affect the use of the POST and PATCH options.
</p>

<p>
SP comes with its own SSL certificate, and your organization may
also add their own; to verify that your communications are secure,
you will need a copy of that certificate.  The person who
maintains your SP deployment should be able to provide that to
you; if you have shell access to the SP leader, the file
containing the certificates is at <code>/etc/ca-bundle.crt</code>.  Copying
that file to your API client&rsquo;s environment will allow you to refer
to it.  In the examples in this book that file is referred to at
<code>certfile</code> in most places.
</p>
</div>
</div>
</div>
<div id="outline-container-orgbb2e57b" class="outline-3">
<h3 id="orgbb2e57b"><span class="section-number-3">2.2</span> Useful Tools</h3>
<div class="outline-text-3" id="text-2-2">
<p>
When working with REST APIs there are several common actions that
you will take: getting data from the API, processing retrieved
data, and sending data to the API.  There are many free programs
that can help you do this in an interactive way.  This can be
useful during development of more complicated programs, for quick
API queries that don&rsquo;t require a whole program, for use in a shell
script, or for interactively working the SP REST API.
</p>

<p>
Examples later in this book will make use of at least some of these
tools.
</p>
</div>

<div id="outline-container-org75a0727" class="outline-4">
<h4 id="org75a0727"><span class="section-number-4">2.2.1</span> Any web browser</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
The SP API is available via any web browser by simply going to a
URL of the form <code>https//spleader.example.com/api/sp/</code>; this
will present a nicely formatted web page showing the request and
the results.  It&rsquo;s not as convenient as other tools (cURL or
HTTPie, see the following section) for actions other than GET, but
as a quick test of an API request, it can be very handy.  An
example of how it looks is in Figure <a href="#orgdcace42">1</a>.
</p>

<div id="orgdcace42" class="figure">
<p><img src="./images/api-results-web-browser.png" alt="api-results-web-browser.png" />
</p>
<p><span class="figure-number">Figure 1: </span>The SP REST API can be accessed using a web browser and the query and results are displayed nicely.</p>
</div>
</div>
</div>

<div id="outline-container-org983d45a" class="outline-4">
<h4 id="org983d45a"><span class="section-number-4">2.2.2</span> cURL</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
cURL is a classic program (dating back to 1997) for accessing HTTP
services from the command line.  It is open source and available
for free from the main cURL website <a href="http://curl.haxx.se">http://curl.haxx.se</a> or via
package managers for your platform.  cURL is available for 34
different operating systems, so should work in almost all
scenarios.  There are more modern and feature-rich tools for
accessing REST APIs (or other HTTP services), but cURL is nearly
ubiquitous.
</p>
</div>
<ol class="org-ol">
<li><a id="orgab0f558"></a>Getting data with cURL<br />
<div class="outline-text-5" id="text-2-2-2-1">
<p>
An example of using cURL to get data from SP via the SP REST API
is:
</p>
<div class="org-src-container">
<pre class="src src-sh">curl --cacert certfile --ssl -X GET -H <span style="color: #A3BE8C;">"Content-Type:application/vnd.api+json"</span> -H <span style="color: #A3BE8C;">"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</span> https://leader.example.com/api/sp/
</pre>
</div>

<p>
In order of appearance, the options used in the <code>curl</code> command
above are:
</p>
<ul class="org-ul">
<li><code>--cacert certfile</code> tells <code>curl</code> to use the SSL certificate
called <code>certfile</code> (more on this later)</li>
<li><code>--ssl</code> tells <code>curl</code> to use Secure Sockets Layer (SSL) for its
connection</li>
<li><code>-X GET</code> tells <code>curl</code> to issue an HTTP <code>GET</code> command (more on
this later, too)</li>
<li><code>-H "Content-Type:application/vnd.api+json"</code> sends the HTTP
header <code>Content-Type</code> set to the value of
<code>application/vnd.api+json</code>.  Other than the endpoints at
<code>/insight/</code>, all of the SP API uses this content type</li>
<li><code>-H
	"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</code>
sends the HTTP header <code>X-Arbux-APIToken</code> set to the value of
the API key that was set via the SP command line</li>
<li><code>https://leader.example.com/api/sp/</code> which is the URL
(hostname and endpoint) that is requested.  In this case, it is
the index endpoint for the API.</li>
</ul>

<p>
The output of this particular command is the index of the SP REST
API represented as a JSON object (defined by the outer-most curly
braces) with two JSON objects in it, <code>meta</code> and <code>links</code>.
</p>

<p>
Successful requests for data from the SP REST API will return the
requested data along with the HTTP status code <code>200 OK</code>.
</p>
</div>
</li>
<li><a id="orgb2f8454"></a>Sending data with cURL<br />
<div class="outline-text-5" id="text-2-2-2-2">
<p>
An example of using cURL to send data to SP via the SP REST API
is:
</p>
<div class="org-src-container">
<pre class="src src-sh">curl --cacert certfile --ssl -X POST -H <span style="color: #A3BE8C;">"Content-Type:application/vnd.api+json"</span> -H <span style="color: #A3BE8C;">"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</span> -d @input.json https://leader.example.com/api/sp/alerts/12519/annotations/
</pre>
</div>

<p>
In order of appearance, the options used in the <code>curl</code> command
above are:
</p>
<ul class="org-ul">
<li><code>--cacert certfile</code> tells <code>curl</code> to use the SSL certificate
called <code>certfile</code> (more on this later)</li>
<li><code>--ssl</code> tells <code>curl</code> to use Secure Sockets Layer (SSL) for its
connection</li>
<li><code>-X POST</code> tells <code>curl</code> to issue an HTTP <code>POST</code> command (more
on this later, too)</li>
<li><code>-H "Content-Type:application/vnd.api+json"</code> sends the HTTP
header <code>Content-Type</code> set to the value of
<code>application/vnd.api+json</code>.  Other than the endpoints at
<code>/insight/</code>, all of the SP API uses this content type</li>
<li><code>-H
	"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</code>
sends the HTTP header <code>X-Arbux-APIToken</code> set to the value of
the API key that was set via the SP command line</li>
<li><code>-d @input.json</code> tells cURL that the data to be sent can be
found in the file named <code>input.json</code></li>
<li><p>
<code>https://leader.example.com/api/sp/alerts/12519/annotations/</code>
</p>
<p>
which is the URL (hostname and endpoint) to which the data
will be sent.  In this case, it is an alert annotation for the
alert with id 12519.
</p></li>
</ul>

<p>
Although this will be discussed in more depth later in this book,
the format of the data for an alert annotation (in this example,
the contents of the file <code>input.json</code>) is:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"data"</span>: {
        <span style="color: #81A1C1;">"attributes"</span>: {
            <span style="color: #81A1C1;">"author"</span>: <span style="color: #A3BE8C;">"The name of the author"</span>,
            <span style="color: #81A1C1;">"text"</span>: <span style="color: #A3BE8C;">"The text of the annotation"</span>
        }
    }
}
</pre>
</div>

<p>
Using the HTTP verb <code>PATCH</code> to change data is very similar to how
the <code>POST</code> verb is used.
</p>

<p>
Successful API <code>POST</code> and <code>PATCH</code> requests will return all of the
data for the object that was created or modified along with
either a <code>200 OK</code> or <code>201 Created</code> status code.
</p>
</div>
</li>

<li><a id="orgca2acdd"></a>Deleting data with cURL<br />
<div class="outline-text-5" id="text-2-2-2-3">
<p>
An example of using cURL to delete data from SP via the SP REST
API is:
</p>
<div class="org-src-container">
<pre class="src src-sh">curl --cacert certfile --ssl -X DELETE -H <span style="color: #A3BE8C;">"Content-Type:application/vnd.api+json"</span> -H <span style="color: #A3BE8C;">"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</span> https://leader.example.com/api/sp/routers/132
</pre>
</div>

<p>
In order of appearance, the options used in the <code>curl</code> command
above are:
</p>
<ul class="org-ul">
<li><code>--cacert certfile</code> tells <code>curl</code> to use the SSL certificate
called <code>certfile</code> (more on this later)</li>
<li><code>--ssl</code> tells <code>curl</code> to use Secure Sockets Layer (SSL) for its
connection</li>
<li><code>-X DELETE</code> tells <code>curl</code> to issue an HTTP <code>DELETE</code> command
(more on this later, too)</li>
<li><code>-H "Content-Type:application/vnd.api+json"</code> sends the HTTP
header <code>Content-Type</code> set to the value of
<code>application/vnd.api+json</code>.  Other than the endpoints at
<code>/insight/</code>, all of the SP API uses this content type</li>
<li><code>-H
	"X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O"</code>
sends the HTTP header <code>X-Arbux-APIToken</code> set to the value of
the API key that was set via the SP command line</li>
<li><p>
<code>https://leader.example.com/api/sp/routers/132</code> which is the
</p>
<p>
URL (hostname and endpoint) that identifies what resource in
SP will be deleted.  In this case, it is the router with
id 132.
</p></li>
</ul>

<p>
API delete requests do not return any data, since the SP object
you were acting on is now gone.  The HTTP status code that will
be returned for successfully deletions is <code>204 No Content</code>.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgf769ff2" class="outline-4">
<h4 id="orgf769ff2"><span class="section-number-4">2.2.3</span> HTTPie</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
HTTPie is a Python program that is much newer than cURL (although
has still seen a lot of development; the initial commit to Github
was on 25 February 2012) and has some conveniences that cURL
doesn&rsquo;t.  The biggest convenience, in my opinion, is the ability
to save configuration data for a host, and select which host
configuration to use when the the command is run.
</p>

<p>
HTTPie is open source and available for free from
<a href="https://httpie.org/">https://httpie.org/</a> or via package managers for your platform.
HTTPie is based on Python, so is available for any platform that
supports Python.  There are installation instructions for MacOS,
Linux, and Windows at <a href="https://httpie.org/doc#installation">https://httpie.org/doc#installation</a>.
</p>

<p>
Among the Arbor Networks engineers, HTTPie is widely used.
</p>
</div>

<ol class="org-ol">
<li><a id="orgdb5c367"></a>Configuring HTTPie<br />
<div class="outline-text-5" id="text-2-2-3-1">
<p>
There is much more information on the configuration of HTTPie in
its online documentation, but the two things that might be useful
are setting the defaults and creating some sessions.
</p>

<p>
HTTPie&rsquo;s configuration is kept in a simple JSON-formatted file
called <code>config.json</code> (see
<a href="https://httpie.org/doc#config-file-location">https://httpie.org/doc#config-file-location</a> for more); a good
start for configuration is:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"__meta__"</span>: {
        <span style="color: #81A1C1;">"about"</span>: <span style="color: #A3BE8C;">"HTTPie configuration file"</span>,
        <span style="color: #81A1C1;">"help"</span>: <span style="color: #A3BE8C;">"https://github.com/jkbrzt/httpie#config"</span>,
        <span style="color: #81A1C1;">"httpie"</span>: <span style="color: #A3BE8C;">"0.9.4"</span>
    },
    <span style="color: #81A1C1;">"default_options"</span>: [
        <span style="color: #A3BE8C;">"--verify=/path/to/a/ssl/certfile"</span>,
        <span style="color: #A3BE8C;">"--session=spleader.my.example.com"</span>,
        <span style="color: #A3BE8C;">"--timeout=60"</span>,
        <span style="color: #A3BE8C;">"--follow"</span>
    ]
}
</pre>
</div>
<p>
The <code>"__meta__"</code> section comes with HTTPie, and the default
options set:
</p>
<ul class="org-ul">
<li>the path to a SSL certificate file bundle</li>
<li>the default connection information (what HTTPie calls a
session)</li>
<li>a useful timeout value of 60 seconds</li>
<li>the option to follow HTTP redirects</li>
</ul>

<p>
Once you have created <code>config.json</code> you can add some information
to the saved session by typing all of the information once on the
command line.  The information the SP REST API needs is the
<code>Content-Type</code> and <code>X-Arbux-APIToken</code> headers; this is entered by
typing:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://spleader.example.com/api/sp X-Arbux-APIToken:wz8SmD3JRSKz_0kNbdSejSQ_Jk92EVOqRU6CPU_O Content-Type:application/vnd.api+json
</pre>
</div>
<p>
(replacing, of course, the hostname and API token in that example
with your own hostname and API token).  After you do that once,
you can then type:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://spleader.my.comany.com/api/sp
</pre>
</div>
<p>
and the configuration will read the data from the saved file.
Save session information is in the <code>.httpie/sessions/</code> directory
and are JSON files in directories named after the host.
</p>
</div>
</li>

<li><a id="org27b3187"></a>Getting data with HTTPie<br />
<div class="outline-text-5" id="text-2-2-3-2">
<p>
Replicating the cURL example from earlier, getting the SP REST
API index using HTTPie, after following the configuration steps,
is done using the command:
</p>
<div class="org-src-container">
<pre class="src src-sh">http GET https://spleader.example.com/api/sp/
</pre>
</div>

<p>
When HTTPie detects that is is writing to the terminal, it will
include additional information that might look about like:
</p>
<p class="verse">
HTTP/1.1 200 OK<br />
Connection: Keep-Alive<br />
Content-Length: 1593<br />
Content-Security-Policy: default-src &rsquo;self&rsquo; &rsquo;unsafe-inline&rsquo; &rsquo;unsafe-eval&rsquo;<br />
Content-Type: application/vnd.api+json<br />
Date: Tue, 01 Aug 2017 00:55:31 GMT<br />
Keep-Alive: timeout=15, max=10000<br />
P3P: policyref=&ldquo;/w3c/p3p.xml&rdquo;, CP=&ldquo;NOI DSP COR TAIa OUR NOR UNI&rdquo;<br />
Server: Apache<br />
Strict-Transport-Security: max-age=1261440000<br />
Via: 1.1 127.0.0.1<br />
X-Frame-Options: SAMEORIGIN<br />
</p>
<p>
when HTTPie thinks it is directing its output somewhere else, it
will not print this information; if you want to override HTTPie&rsquo;s
decisions about this, there are command-line options to do so.
</p>
</div>
</li>

<li><a id="org4e1bc8b"></a>Sending data with HTTPie<br />
<div class="outline-text-5" id="text-2-2-3-3">
<p>
An example of using HTTPie to send the same data to SP we sent
via the SP REST API is using cURL earlier is (see <code>input.json</code>
in the cURL example of sending data to SP):
</p>
<div class="org-src-container">
<pre class="src src-sh">cat input.json | http POST http https://spleader.example.com/api/sp/alerts/12519/annotations/
</pre>
</div>

<p>
The two differences between getting and sending data to SP via
the REST API using HTTPie are:
</p>
<ul class="org-ul">
<li>using the <code>POST</code> verb instead of the <code>GET</code> verb before the URL</li>
<li>the data you want to send to SP via the REST API is in the
same format as in the cURL example, but it is piped into the
<code>http</code> command</li>
</ul>

<p>
To make changes to SP via the REST API, you can use the <code>PATCH</code>
verb to HTTPie instead of <code>POST</code>.  There will be more examples of
this later.
</p>
</div>
</li>

<li><a id="org39f0270"></a>Deleting data with HTTPie<br />
<div class="outline-text-5" id="text-2-2-3-4">
<p>
Repeating the example of deleting data from the cURL section, the
syntax for using HTTPie to delete data from SP via the SP REST
API is:
</p>
<div class="org-src-container">
<pre class="src src-sh">http DELETE https://spleader.example.com/api/sp/routers/132
</pre>
</div>

<p>
The SP REST API will return the HTTP status code <code>204 No Content</code>
and HTTPie will print this if you aren&rsquo;t piping or redirecting
the output somewhere else.
</p>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgebfcbfb" class="outline-4">
<h4 id="orgebfcbfb"><span class="section-number-4">2.2.4</span> Postman</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Postman is an application that provides a graphical user interface
for working with REST APIs.  It is free to use the basic version,
with the versions more suitable for development enterprises
costing money.  Postman is available from
<a href="https://www.getpostman.com/">https://www.getpostman.com/</a> for MacOS, Linux, and Windows.  It is
also available in the Chrome App Store as a plug-in for the Google
Chrome web browser<sup><a id="fnr.2" class="footref" href="#fn.2">2</a></sup>.
</p>

<p>
Among the Arbor Networks engineers, Postman is widely used.
</p>
</div>

<ol class="org-ol">
<li><a id="org07d0aff"></a>Configuring Postman<br />
<div class="outline-text-5" id="text-2-2-4-1">
<p>
If you are installing the Postman client there are three
configuration settings you need to make before using it with the
SP REST API; adding the certificate bundle and adding the
<code>Content-Type</code> and <code>X-Arbux-APIToken</code> headers.  If you are using
the Postman Chrome app, you don&rsquo;t need to add the certificates;
Postman will use those in your browser, but you may still have to
add them to your browser.
</p>

<p>
To add the SP certificate bundle to the Postman application,
select the wrench icon in the upper right part of the Postman
window and choose Settings from the menu.  In the resulting
window, choose the Certificates option from the top row of
options, then click Add Certificate. In the Host text entry
field, type <code>*.mydomain.com</code> (replacing <code>mydomain.com</code> with the
domain where your SP leader is), and in the CRT File text entry
field type the path to the certificate bundle for your SP
environment.  It should look something like what is shown in
Figure <a href="#org6235df8">2</a>.
</p>

<div id="org6235df8" class="figure">
<p><img src="./images/postman-cert-config.png" alt="postman-cert-config.png" />
</p>
<p><span class="figure-number">Figure 2: </span>The Postman certificate configuration window should look similar to this, with your information filled in; if you are using the Chrome app, you won&rsquo;t see the Certificates option in the top row; Postman will use your browser&rsquo;s certificates.</p>
</div>

<p>
For both the application and Chrome app you will need to set the
<code>Content-Type</code> and <code>X-Arbux-APIToken</code> headers.  This is done in
the Headers section that is immediately below the URL entry field
(after making a request, there will be another Headers section
for the response).  You simply type in each key and the values
for them.  For all of the SP REST API endpoints <i>except</i> those
under <code>/insight/</code> you must set <code>Content-Type</code> to
<code>application/vnd+api.json</code>; for the endpoints under <code>/insight/</code>
you must set <code>Content-Type</code> to <code>application/json</code>.
</p>
</div>
</li>

<li><a id="orge4040b7"></a>Getting data with Postman<br />
<div class="outline-text-5" id="text-2-2-4-2">
<p>
Following the cURL and HTTPie examples, to get the SP REST API
index using Postman you make sure that <code>GET</code> is selected to the
left of the text entry box that says &ldquo;Enter request URL&rdquo;, then
enter the URL for the index endpoint
(<code>https://spleader.example.com/api/sp/</code>) and press the Send
button. The results (the body, cookies, and headers) will appear
in the bottom pane.  It will look something like what is shown in
Figure <a href="#org473f54e">3</a>.
</p>

<div id="org473f54e" class="figure">
<p><img src="./images/postman-GET-index.png" alt="postman-GET-index.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Retrieving data from the SP REST API using Postman is done by setting the two headers shown, entering a URL, and pressing the Send button.  The data retrieved is displayed in the lower pane.</p>
</div>
</div>
</li>

<li><a id="orgb4564ca"></a>Sending data with Postman<br />
<div class="outline-text-5" id="text-2-2-4-3">
<p>
Once again using the same <code>input.json</code> file from earlier, we will
set an annotation on an alert, this time using Postman.
</p>

<p>
The steps in Postman to get ready to send date are:
</p>
<ul class="org-ul">
<li>change the HTTP verb to the left of the URL from <code>GET</code> to
<code>POST</code></li>
<li>enter the URL to which you are sending the data in the text
entry box that says &ldquo;Enter request URL&rdquo;</li>
<li>select Body from the items below the URL</li>
<li>select raw from the items above the text entry box</li>
<li>select JSON from the dropdown to the right of type selections</li>
<li>enter the JSON body you are sending in the text box.</li>
</ul>

<p>
Having done all of those steps, you should have something that
looks like Figure <a href="#org76b731a">4</a>.
</p>

<div id="org76b731a" class="figure">
<p><img src="./images/postman-POST-annotation.png" alt="postman-POST-annotation.png" />
</p>
<p><span class="figure-number">Figure 4: </span>Sending data to SP using the REST API and Postman is done by setting the HTTP verb to POST, filling in the URL, selecting the Body option, then the raw option and the JSON type, and filling in the JSON body.  Once that is complete, press the Send button.</p>
</div>

<p>
After sending the body with the correct settings, the results
will appear in the bottom text area in Postman.
</p>
</div>
</li>

<li><a id="orga2d9e36"></a>Deleting data with Postman<br />
<div class="outline-text-5" id="text-2-2-4-4">
<p>
Repeating the example of deleting data from the cURL and HTTPie
sections, the method for using Postman to delete data from SP via
the SP REST API is to enter the URL for the object you want to
delete, change the HTTP verb to Delete, and press the Send
button.
</p>

<p>
The SP REST API will return the HTTP status code <code>204 No Content</code>
and no body content.
</p>

<p>
After a successful DELETE operation you should have something
that looks like Figure <a href="#org996a3e6">5</a>.
</p>

<div id="org996a3e6" class="figure">
<p><img src="./images/postman-DELETE-router.png" alt="postman-DELETE-router.png" />
</p>
<p><span class="figure-number">Figure 5: </span>Deleting data from SP using the REST API and Postman is done by selecting the <code>DELETE</code> HTTP verb from the menu, entering the URL of the item to be deleted and pressing Send.  There will be no content in returned but on the right side just above the (empty) returned data box the status will read <code>204 NO CONTENT</code>.</p>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org962c323" class="outline-4">
<h4 id="org962c323"><span class="section-number-4">2.2.5</span> <code>jq</code></h4>
<div class="outline-text-4" id="text-2-2-5">
<p>
<code>jq</code> is a JSON parsing and manipulation tool in the spirit of
what <code>sed</code><sup><a id="fnr.3" class="footref" href="#fn.3">3</a></sup> and <code>awk</code><sup><a id="fnr.4" class="footref" href="#fn.4">4</a></sup> are for text.
</p>

<p>
<code>jq</code> is free and open-source; it is available at
<a href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a> for MacOS, Linux, and Windows or
via package managers for your platform.  The C source code and
build instructions are available at <a href="https://github.com/stedolan/jq">https://github.com/stedolan/jq</a>
for other platforms.
</p>

<p>
<code>jq</code> is very powerful, but complicated.  It can be used to extract
subsets of data from JSON input, search for keys or values in JSON
data and only print the objects that match the search criteria,
select and recast data from JSON input into different JSON
output.  The complete manual is available at the <code>jq</code> website, but
we will provide a few examples of using <code>jq</code> with the JSON from
the SP REST API.
</p>
</div>

<ol class="org-ol">
<li><a id="org9ae54df"></a>Extracting only names, descriptions, and ids of routers into a new JSON format<br />
<div class="outline-text-5" id="text-2-2-5-1">
<p>
The HTTPie command to get the router information from SP using
the REST API is:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/routers/
</pre>
</div>
<p>
but on a system with 12 routers this results in 503 lines of JSON
output.  If all you need is the id, name, and description of each
router, that is a lot of information to deal with.
</p>

<p>
Using <code>jq</code> we can extract the 36 pieces of data that we need.
</p>

<p>
Looking at the original output from the <code>/routers/</code> endpoint, we
need to make note of two things: the information we want is in a
list of objects in the <code>"data"</code> object; the fields we want are at
the top level of each data object (<code>"id"</code>) and in the
<code>"attributes"</code> sub-object for each data object.
</p>

<p>
The first thing we can do is have <code>jq</code> print each object in the
<code>"data"</code> list by giving it the filter <code>.data[]</code> which means &ldquo;from
the top level (<code>.</code>) print every element <code>[]</code> in the <code>"data"</code>
array&rdquo;.  In practice this looks like:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/routers/ | jq <span style="color: #A3BE8C;">'.data[]'</span>
</pre>
</div>
<p>
The <code>jq</code> filter is in single-quotes to prevent the square
brackets from being interpreted by the shell.
</p>

<p>
<code>jq</code> uses periods to denote the JSON hierarchy (that&rsquo;s why
<code>.data</code> starts with a period, it is the root of the JSON tree),
the pipe (<code>|</code>) character to chain together its filters, and
commas to group elements together for selection.
</p>

<p>
So the next thing we can do is extract one element from the JSON
output of the SP REST API by adding it to the <code>.data[]</code> filter.
To get the names of the routers we can add <code>.attributes.name</code>
(remember, <code>"name"</code> is in the <code>"attributes"</code> subobject of data.
On the command line this looks like:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/routers/ | jq <span style="color: #A3BE8C;">'.data[].attributes.name'</span>
</pre>
</div>
<p>
This will print a list of the names of all of the routers
configured in SP.  This is part of our original goal, but we
still also want the id and description of the routers.
</p>

<p>
To select more than one element, <code>jq</code> supports sending each list
item over which it is iterating to a group of elements for
selection.  To get the router id and description along with the
name, we can type:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/routers/ | jq <span style="color: #A3BE8C;">'.data[] | .id,.attributes.name,.attributes.description'</span>
</pre>
</div>
<p>
This will then print a list that is something like:
</p>
<pre class="example">
"121"
"rtr1.nyc"
"a router in New York"
"122"
"rtr2.chi"
"a router in Chicago"
"123"
"rtr3.lax"
"a router in Los Angeles"
"124"
"pigeon.net"
"See RFC 1149"
</pre>
<p>
where the order of the elements is the same order as they were
requested in the filter.  But this isn&rsquo;t very easy to read, and
is not very useful as input to computer programs.  <code>jq</code> can do
better.
</p>

<p>
To make JSON-compliant output that is easy to read and easy for
another computer program to ingest, <code>jq</code> needs to know how things
should be grouped.
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/routers/ | jq <span style="color: #A3BE8C;">'{"routers": [.data[] | {id:.id,name:.attributes.name,description:.attributes.description}]}'</span>
</pre>
</div>
<p>
will print a list that looks something like:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"routers"</span>: [
        {
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"121"</span>,
            <span style="color: #81A1C1;">"name"</span>: <span style="color: #A3BE8C;">"rtr1.nyc"</span>,
            <span style="color: #81A1C1;">"description"</span>: <span style="color: #A3BE8C;">"a router in New York"</span>
        },
        {
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"122"</span>,
            <span style="color: #81A1C1;">"name"</span>: <span style="color: #A3BE8C;">"rtr2.chi"</span>,
            <span style="color: #81A1C1;">"description"</span>: <span style="color: #A3BE8C;">"a router in Chicago"</span>
        },
        {
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"123"</span>,
            <span style="color: #81A1C1;">"name"</span>: <span style="color: #A3BE8C;">"rtr3.lax"</span>,
            <span style="color: #81A1C1;">"description"</span>: <span style="color: #A3BE8C;">"a router in Los Angeles"</span>
        },
        {
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"124"</span>,
            <span style="color: #81A1C1;">"name"</span>: <span style="color: #A3BE8C;">"pigeon.net"</span>,
            <span style="color: #81A1C1;">"description"</span>: <span style="color: #A3BE8C;">"See RFC 1149"</span>
        }
    ]
}
</pre>
</div>

<p>
While this example is for four routers, with the original example
of 12 routers we have gone from 503 lines of JSON output to 64
lines, removing the 87% of the data we didn&rsquo;t need using one
filter in <code>jq</code>.
</p>
</div>
</li>

<li><a id="org2f5a308"></a>Extracting alerts that have a severity percentage above 200<br />
<div class="outline-text-5" id="text-2-2-5-2">
<p>
<code>jq</code> can also look for certain properties of objects and print
only the objects that have those properties.
</p>

<p>
For example, a typical alert from the SP REST API looks like:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"data"</span>: {
        <span style="color: #81A1C1;">"attributes"</span>: {
            <span style="color: #81A1C1;">"alert_class"</span>: <span style="color: #A3BE8C;">"dos"</span>,
            <span style="color: #81A1C1;">"alert_type"</span>: <span style="color: #A3BE8C;">"dos_host_detection"</span>,
            <span style="color: #81A1C1;">"classification"</span>: <span style="color: #A3BE8C;">"Possible Attack"</span>,
            <span style="color: #81A1C1;">"importance"</span>: <span style="color: #81A1C1;">2</span>,
            <span style="color: #81A1C1;">"ongoing"</span>: <span style="color: #81A1C1;">true</span>,
            <span style="color: #81A1C1;">"start_time"</span>: <span style="color: #A3BE8C;">"2017-08-01T19:44:45+00:00"</span>,
            <span style="color: #81A1C1;">"subobject"</span>: {
                <span style="color: #81A1C1;">"fast_detected"</span>: <span style="color: #81A1C1;">false</span>,
                <span style="color: #81A1C1;">"host_address"</span>: <span style="color: #A3BE8C;">"192.168.12.203"</span>,
                <span style="color: #81A1C1;">"impact_boundary"</span>: <span style="color: #A3BE8C;">"rtr1.nyc"</span>,
                <span style="color: #81A1C1;">"impact_bps"</span>: <span style="color: #81A1C1;">8251040</span>,
                <span style="color: #81A1C1;">"impact_pps"</span>: <span style="color: #81A1C1;">3010</span>,
                <span style="color: #81A1C1;">"ip_version"</span>: <span style="color: #81A1C1;">4</span>,
                <span style="color: #81A1C1;">"misuse_types"</span>: [
                    <span style="color: #A3BE8C;">"icmp"</span>,
                    <span style="color: #A3BE8C;">"total"</span>,
                    <span style="color: #A3BE8C;">"dns"</span>,
                    <span style="color: #A3BE8C;">"udp"</span>
                ],
                <span style="color: #81A1C1;">"severity_percent"</span>: <span style="color: #81A1C1;">153</span>,
                <span style="color: #81A1C1;">"severity_threshold"</span>: <span style="color: #81A1C1;">1000</span>,
                <span style="color: #81A1C1;">"severity_unit"</span>: <span style="color: #A3BE8C;">"bps"</span>,
                <span style="color: #81A1C1;">"summary_url"</span>: <span style="color: #A3BE8C;">"/page?id=profile_summary&amp;gid=154"</span>
            }
        },
        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"799318"</span>,
        <span style="color: #81A1C1;">"links"</span>: {
            <span style="color: #81A1C1;">"self"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318"</span>
        },
        <span style="color: #81A1C1;">"relationships"</span>: {
            <span style="color: #81A1C1;">"annotations"</span>: {
                <span style="color: #81A1C1;">"data"</span>: [
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492098"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    },
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492097"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    },
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492096"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    },
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492095"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    },
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492094"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    },
                    {
                        <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"1492093"</span>,
                        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>
                    }
                ],
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318/annotations/"</span>
                }
            },
            <span style="color: #81A1C1;">"device"</span>: {
                <span style="color: #81A1C1;">"data"</span>: {
                    <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"115"</span>,
                    <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"device"</span>
                },
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/devices/115"</span>
                }
            },
            <span style="color: #81A1C1;">"managed_object"</span>: {
                <span style="color: #81A1C1;">"data"</span>: {
                    <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"154"</span>,
                    <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"managed_object"</span>
                },
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/managed_objects/154"</span>
                }
            },
            <span style="color: #81A1C1;">"packet_size_distribution"</span>: {
                <span style="color: #81A1C1;">"data"</span>: {
                    <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"packet-size-distribution-799318"</span>,
                    <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_packet_size_distribution"</span>
                },
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318/packet_size_distribution"</span>
                }
            },
            <span style="color: #81A1C1;">"patterns"</span>: {
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318/patterns/"</span>
                }
            },
            <span style="color: #81A1C1;">"router_traffic"</span>: {
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318/router_traffic/"</span>
                }
            },
            <span style="color: #81A1C1;">"traffic"</span>: {
                <span style="color: #81A1C1;">"data"</span>: {
                    <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"alert-traffic-799318"</span>,
                    <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_traffic"</span>
                },
                <span style="color: #81A1C1;">"links"</span>: {
                    <span style="color: #81A1C1;">"related"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318/traffic"</span>
                }
            }
        },
        <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert"</span>
    },
    <span style="color: #81A1C1;">"links"</span>: {
        <span style="color: #81A1C1;">"self"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/799318"</span>
    },
    <span style="color: #81A1C1;">"meta"</span>: {
        <span style="color: #81A1C1;">"api"</span>: <span style="color: #A3BE8C;">"SP"</span>,
        <span style="color: #81A1C1;">"api_version"</span>: <span style="color: #A3BE8C;">"2"</span>,
        <span style="color: #81A1C1;">"sp_build_id"</span>: <span style="color: #A3BE8C;">"HHAB"</span>,
        <span style="color: #81A1C1;">"sp_version"</span>: <span style="color: #A3BE8C;">"8.3"</span>
    }
}
</pre>
</div>
<p>
which is a lot of information to parse; using <code>jq</code> you can filter
the data after the API returns it to you (there is some filtering
available via the API that happens on the SP side before
returning data to you, but it is limited; this will be discussed
later).
</p>

<p>
If you want only the alerts out of the most recent 50 that have
severity percents (in <code>jq</code> path representation,
<code>.data[].attributes.subobject.severity_percent</code> greater than 200,
<code>jq</code> can select those alerts.
</p>

<p>
The first step is the same as it was in the previous example, get
each object out of the data list:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/alerts/ | jq <span style="color: #A3BE8C;">'.data[]'</span>
</pre>
</div>

<p>
The second step is to make the selection using <code>jq</code>&rsquo;s pipe
functionality and put the results into a list by adding square
brackets around the whole statement:
</p>
<div class="org-src-container">
<pre class="src src-sh">http https://leader.example.com/api/sp/alerts/ | jq <span style="color: #A3BE8C;">'[.data[] | select(.attributes.subobject.severity_percent&gt;200)]'</span>
</pre>
</div>

<p>
To verify that this is returning only alerts with a severity
percent greater than 200 we can add <code>|
     .[].attributes.subobject.severity_percent</code> to the query
</p>
<div class="org-src-container">
<pre class="src src-sh">http GET https://leader.example.com/api/sp/alerts/ | jq <span style="color: #A3BE8C;">'[.data[] | select(.attributes.subobject.severity_percent&gt;200)] | .[].attributes.subobject.severity_percent'</span>
</pre>
</div>

<pre class="example">
301
374
262
342
374
402
342
443
373

</pre>

<p>
These are only two examples of what <code>jq</code> can help you with when
you are faced with a lot of JSON data, the manual and some
experimentation will be very useful in using <code>jq</code> in your
particular environment.
</p>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgd541acf" class="outline-3">
<h3 id="orgd541acf"><span class="section-number-3">2.3</span> The Python Environment</h3>
<div class="outline-text-3" id="text-2-3">
<p>
Most of the examples in this book will be in the Python
(<a href="http://www.python.org">http://www.python.org</a>) programming language&#x2014;it is an
easy-to-read language even if you aren&rsquo;t familiar with it; Python
is available for nearly every operating system; and it includes
nearly everything you need (&ldquo;The Python source distribution has
long maintained the philosophy of &rdquo;batteries included&ldquo; &#x2013; having a
rich and versatile standard library which is immediately available,
without making the user download separate packages. This gives the
Python language a head start in many projects.&rdquo;).
</p>

<p>
A standard Python installation includes everything you need to
access the SP REST API and process data from it&#x2014;an HTTP library
(<code>httplib</code>) and a JSON library (<code>json</code>).  However, the <code>httplib</code>
documentation (at <a href="https://docs.python.org/2/library/httplib.html">https://docs.python.org/2/library/httplib.html</a>)
says &ldquo;The Requests package is recommended for a higher-level HTTP
client interface.&rdquo;
</p>

<p>
The examples in this book will make significant use of the Requests
library; you will be able to follow along with nearly all of the
examples using only that additional library.  If we use other
libraries (for example, for accessing databases, creating web
pages, etc.) we will go into more depth about those at the time.
</p>
</div>

<div id="outline-container-org14b6c33" class="outline-4">
<h4 id="org14b6c33"><span class="section-number-4">2.3.1</span> The <code>requests</code> library</h4>
<div class="outline-text-4" id="text-2-3-1">
<p>
The Python Requests library documentation at
<a href="https://requests.readthedocs.io/">https://requests.readthedocs.io/</a> purports:
</p>
<blockquote>
<p>
Requests is the only Non-GMO HTTP library for Python, safe for
human consumption.
</p>
</blockquote>
<p>
and warns:
</p>
<blockquote>
<p>
Recreational use of the Python standard library for HTTP may
result in dangerous side-effects, including: security
vulnerabilities, verbose code, reinventing the wheel, constantly
reading documentation, depression, headaches, or even death.
</p>
</blockquote>

<p>
Installation instructions for the <code>requests</code> library are at the
<code>readthedocs</code> site at
<a href="https://requests.readthedocs.io/en/master/user/install/">https://requests.readthedocs.io/en/master/user/install/</a>, but
mostly comprise <code>pip install requests</code>.  (And if you haven&rsquo;t got
<code>pip</code>, see
<a href="http://docs.python-guide.org/en/latest/starting/installation/">http://docs.python-guide.org/en/latest/starting/installation/</a> for
installing it and a few other useful things).
</p>

<p>
Once you think you have the <code>requests</code> library installed, a simple
test is to follow the steps in this example (<code>%</code> is a Mac or Linux
shell prompt, and <code>&gt;&gt;&gt;</code> is the interactive Python prompt):
</p>
<pre class="example">
% python
Python 2.7 (blah blah blah)
Type "help", "copyright", "credits" or "license" for more information.
&gt;&gt;&gt; import requests
&gt;&gt;&gt; rg = requests.get("http://www.google.com")
&gt;&gt;&gt; rg
&gt;&gt;&gt; &lt;Response [200]&gt;
&gt;&gt;&gt; rg.headers
&gt;&gt;&gt; {'Content-Length': '4740', 'X-XSS-Protection': '1; mode=block',
    'Content-Encoding': 'gzip', 'Set-Cookie':
    'NID=110=BXSpW6kxChyqif9p3Q0yFhL75QRsh0-C3vjFY_uTwpS-ANLlJsTjpC_9LypwgClOwL36COwCH6oAIBPfgcP-vZ4mwhpSqwM_UuG0pOpEGfDMDSKEtpK0mdHDaIqsEjR7;
    expires=Sat, 24-Feb-2018 05:12:11 GMT; path=/;
    domain=.google.co.nz; HttpOnly', 'Expires': '-1', 'Server': 'gws',
    'Cache-Control': 'private, max-age=0', 'Date': 'Fri, 25 Aug 2017
    05:12:11 GMT', 'P3P': 'CP="This is not a P3P policy! See
    https://www.google.com/support/accounts/answer/151657?hl=en for
    more info."', 'Content-Type': 'text/html; charset=ISO-8859-1',
    'X-Frame-Options': 'SAMEORIGIN'}
</pre>
<p>
If you get an error after you type <code>import requests</code> you haven&rsquo;t
installed requests correctly, and may want to consult a local
expert for help. If you get a response other than <code>&lt;Response
    [200]&gt;</code> after typing the <code>requests.get</code> line, you may not have
access to either <a href="http://www.google.com">http://www.google.com</a> or to the Internet, both of
which would be a little odd, frankly, but that&rsquo;s where you should
start looking.
</p>
</div>
</div>
</div>

<div id="outline-container-orgddd9410" class="outline-3">
<h3 id="orgddd9410"><span class="section-number-3">2.4</span> Summary</h3>
<div class="outline-text-3" id="text-2-4">
<p>
At this point, you should be able to access your SP Leader&rsquo;s REST
API using at least one of <code>curl</code>, <code>httpie</code>, or <code>postman</code>.  You
might also be able to extract some sort of useful information using
the <code>jq</code> tool.
</p>

<p>
You should be able to make a simple HTTP request using Python and
the Requests library.
</p>

<p>
The rest of this book will be examples of using these tools (and
some examples in other programming languages) demonstrating how to
do things with the SP REST API that will hopefully be a useful
starting point for your own uses of the API.
</p>
</div>
</div>
</div>

<div id="outline-container-orgc94c973" class="outline-2">
<h2 id="orgc94c973"><span class="section-number-2">3</span> Reports</h2>
<div class="outline-text-2" id="text-3">
<p>
The chapter describes how to produce reports from the data available
from the SP REST API.  This certainly isn&rsquo;t an exhaustive list of
reports you can produce, and the most interesting reports will be
those you create by combining data from SP with data from other
sources.
</p>

<p>
The difference between a report program and either configuration or
operational programs is that a report program only fetches data from
SP, it doesn&rsquo;t not change the state of SP in any way (in
programmatic terms, the only HTTP verb used in these examples is
<code>GET</code>).
</p>
</div>

<div id="outline-container-org045f106" class="outline-3">
<h3 id="org045f106"><span class="section-number-3">3.1</span> Example: Time between an Alert and a Mitigation</h3>
<div class="outline-text-3" id="text-3-1">
<p>
Arbor Networks SP can alert you to various kinds of network
attacks by monitoring the network traffic across hundreds of
routers and looking for anomalous behavior.  In combination with
Arbor Networks TMS applicances, these attacks can be mitigated by
directing the odd traffic through a TMS for inspection and, if
needed, cleaning.
</p>

<p>
SP and TMS support mitigating the anomalous traffic manually, where
a network operator notices the alert, applies some other metrics to
it, and then either decides to direct that traffic to a TMS or
not.  Monitoring the time between an alert and the manual
mitigation can be useful.  In addition, SP and TMS support
automatic mitigation of traffic that generates an alert.
Monitoring the time between the alert and the automatic mitigation
can also be useful.
</p>

<p>
The steps to look at this are:
</p>
<ul class="org-ul">
<li>establish a time period over which you want to produce this
report</li>
<li>collect the mitigations that were started in that time frame
using the REST API</li>
<li>extract from the mitigation information the related alerts</li>
<li>collect the alert information about those specific alerts using
the REST API</li>
<li>for the group of manually started mitigations, collect the
difference in start times for each mitigation</li>
<li>do the same for the group of automatically started mitigations</li>
</ul>

<p>
Python supports command-line options very gracefully using the
included <code>argparse</code> library
(<a href="https://docs.python.org/2.7/library/argparse.html">https://docs.python.org/2.7/library/argparse.html</a>) but, for the
purpose of this example, we will simply hard-code what would
normally be options.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">import</span> requests
<span style="color: #81A1C1;">from</span> datetime <span style="color: #81A1C1;">import</span> datetime, timedelta
<span style="color: #81A1C1;">from</span> sys <span style="color: #81A1C1;">import</span> stderr
<span style="color: #81A1C1;">from</span> time <span style="color: #81A1C1;">import</span> mktime, strptime
<span style="color: #81A1C1;">from</span> urllib <span style="color: #81A1C1;">import</span> urlencode
<span style="color: #81A1C1;">from</span> urlparse <span style="color: #81A1C1;">import</span> urlparse, parse_qs

<span style="color: #D8DEE9;">CERT_FILE</span> = <span style="color: #A3BE8C;">"./certfile"</span>
<span style="color: #D8DEE9;">TIMEFMT</span> = <span style="color: #A3BE8C;">"%a %b %d %H:%M:%S %Y"</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_mitigations</span>(leader, key, start,
                    end, page=1, perPage=50):
    <span style="color: #4c566a;">"""Recursively get pages of mitigations until</span>
<span style="color: #4c566a;">    the start date is reached or the last page is</span>
<span style="color: #4c566a;">    reached</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">set up the query string keys and values</span>
    <span style="color: #D8DEE9;">qs</span> = <span style="color: #81A1C1;">dict</span>()
    <span style="color: #81A1C1;">if</span> page:
        <span style="color: #D8DEE9;">qs</span>[<span style="color: #A3BE8C;">'page'</span>] = page
    <span style="color: #81A1C1;">if</span> perPage:
        <span style="color: #D8DEE9;">qs</span>[<span style="color: #A3BE8C;">'perPage'</span>] = perPage

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">build the URL</span>
    <span style="color: #D8DEE9;">MITIGATION_URI</span> = <span style="color: #A3BE8C;">'/api/sp/mitigations/?'</span>
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + MITIGATION_URI
    <span style="color: #D8DEE9;">URL</span> += urlencode(qs)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">make the API request</span>
    <span style="color: #D8DEE9;">api_response</span> = requests.get(
        URL,
        headers={<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>:
                 key},
        verify=CERT_FILE)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">check the API response</span>
    <span style="color: #81A1C1;">if</span> api_response.status_code != requests.codes.ok:
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"[ERROR] API responded with this error: "</span>
              <span style="color: #A3BE8C;">"{}\n(url: {})"</span>.
              <span style="color: #81A1C1;">format</span>(api_response.reason, URL),
              <span style="color: #81A1C1;">file</span>=stderr)
        <span style="color: #81A1C1;">return</span> []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">convert the response to JSON and</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">get the 'data' element</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #D8DEE9;">data</span> = api_response[<span style="color: #A3BE8C;">'data'</span>]

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">check if we're done or if we need</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">to call ourselves again</span>
    <span style="color: #D8DEE9;">specified_start</span> = string_to_date(start)
    <span style="color: #D8DEE9;">oldest_mit_on_this_page</span> = <span style="color: #81A1C1;">None</span>
    <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'start'</span> <span style="color: #81A1C1;">in</span> data[-1][<span style="color: #A3BE8C;">'attributes'</span>]:
        <span style="color: #D8DEE9;">oldest_mit_on_this_page</span> = data[-1][<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'start'</span>]
        <span style="color: #D8DEE9;">oldest_mit_on_this_page</span> = string_to_date(
            oldest_mit_on_this_page)

    <span style="color: #81A1C1;">if</span> (oldest_mit_on_this_page <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">None</span>
        <span style="color: #81A1C1;">or</span> oldest_mit_on_this_page &gt; specified_start):
        <span style="color: #4c566a;">#</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">parse out the last page from the links section</span>
        <span style="color: #4c566a;">#</span>
        <span style="color: #D8DEE9;">last_page</span> = <span style="color: #81A1C1;">None</span>
        <span style="color: #81A1C1;">if</span> (<span style="color: #A3BE8C;">'links'</span> <span style="color: #81A1C1;">in</span> api_response <span style="color: #81A1C1;">and</span>
            <span style="color: #A3BE8C;">'last'</span> <span style="color: #81A1C1;">in</span> api_response[<span style="color: #A3BE8C;">'links'</span>]):
            <span style="color: #D8DEE9;">last_page</span> = <span style="color: #81A1C1;">int</span>(
                parse_qs(
                    urlparse(
                        api_response[<span style="color: #A3BE8C;">'links'</span>][<span style="color: #A3BE8C;">'last'</span>]).query
                )[<span style="color: #A3BE8C;">'page'</span>][0]
            )
        <span style="color: #81A1C1;">if</span> last_page <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">None</span> <span style="color: #81A1C1;">and</span> page &lt; last_page:
            <span style="color: #D8DEE9;">page</span> += 1
            <span style="color: #4c566a;"># </span><span style="color: #4c566a;">call ourselves again to get the next page</span>
            <span style="color: #D8DEE9;">d</span> = get_mitigations(leader, key, start, end, page)
            <span style="color: #D8DEE9;">data</span> += d

    <span style="color: #81A1C1;">return</span> data


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alerts_from_mits</span>(mits):
    <span style="color: #4c566a;">"""Not all mitigations have alerts, those</span>
<span style="color: #4c566a;">    will just be skipped, otherwise the alerts</span>
<span style="color: #4c566a;">    will be retrieved and a dictionary with</span>
<span style="color: #4c566a;">    mitigation information and alert start</span>
<span style="color: #4c566a;">    time will be populated and returned</span>

<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">alerts</span> = {}

    <span style="color: #81A1C1;">for</span> mit <span style="color: #81A1C1;">in</span> mits:
        <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'relationships'</span> <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> mit <span style="color: #81A1C1;">or</span> <span style="color: #A3BE8C;">'alert'</span> <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> mit[<span style="color: #A3BE8C;">'relationships'</span>]:
            <span style="color: #81A1C1;">continue</span>  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">there is no alert related to this mitigation</span>
        <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'start'</span> <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> mit[<span style="color: #A3BE8C;">'attributes'</span>]:
            <span style="color: #81A1C1;">continue</span>  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">mitigation was created but never started</span>
        <span style="color: #D8DEE9;">alert_id</span> = mit[
            <span style="color: #A3BE8C;">'relationships'</span>][<span style="color: #A3BE8C;">'alert'</span>][<span style="color: #A3BE8C;">'data'</span>][<span style="color: #A3BE8C;">'id'</span>]
        <span style="color: #81A1C1;">if</span> alert_id <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> alerts:
            <span style="color: #D8DEE9;">alerts</span>[alert_id] = {}
            <span style="color: #D8DEE9;">mit_start_time</span> = string_to_date(
                mit[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'start'</span>])

            alerts[alert_id][
                <span style="color: #A3BE8C;">'mit_start_time'</span>] = mit_start_time
            alerts[alert_id][
                <span style="color: #A3BE8C;">'mit_type'</span>] = mit[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'subtype'</span>]
            alerts[alert_id][
                <span style="color: #A3BE8C;">'started_by'</span>] = mit[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'user'</span>]

    <span style="color: #81A1C1;">return</span> alerts


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">print_report</span>(alerts, mitigations, sp_leader, start, end):
    <span style="color: #4c566a;">""" print a simplistic report with a table of alerts """</span>

    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"The time range for the report is"</span>)
    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"                 from:"</span>,
           start.strftime(TIMEFMT))
    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"                   to:"</span>,
           end.strftime(TIMEFMT))

    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"Out of {} mitigations on {}, "</span>
           <span style="color: #A3BE8C;">"{} have associated alerts"</span>.
           <span style="color: #81A1C1;">format</span>(
               <span style="color: #81A1C1;">len</span>(mitigations),
               sp_leader,
               <span style="color: #81A1C1;">len</span>(alerts.keys())
           ))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">re-organize alerts for printing</span>
    <span style="color: #D8DEE9;">by_user_type_time</span> = {}
    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:
        <span style="color: #D8DEE9;">started_by</span> = alerts[alert][<span style="color: #A3BE8C;">'started_by'</span>]
        <span style="color: #D8DEE9;">mit_type</span> = alerts[alert][<span style="color: #A3BE8C;">'mit_type'</span>]
        <span style="color: #D8DEE9;">a_to_m_secs</span> = alerts[alert][<span style="color: #A3BE8C;">'alert_to_mit_seconds'</span>]
        <span style="color: #81A1C1;">if</span> started_by <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> by_user_type_time:
            <span style="color: #D8DEE9;">by_user_type_time</span>[started_by] = {}
        <span style="color: #81A1C1;">if</span> mit_type <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> by_user_type_time[started_by]:
            by_user_type_time[started_by][mit_type] = {}
        <span style="color: #81A1C1;">if</span> a_to_m_secs <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> by_user_type_time[started_by][mit_type]:
            by_user_type_time[started_by][mit_type][a_to_m_secs] = []

        by_user_type_time[started_by][mit_type][a_to_m_secs].append(alert)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">print the header row</span>
    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"{0:&gt;20} | {1:&lt;10} | {2:11} | {3}"</span>.<span style="color: #81A1C1;">format</span>(
        <span style="color: #A3BE8C;">"Mit. Started By"</span>,
        <span style="color: #A3BE8C;">"Mit. Type"</span>,
        <span style="color: #A3BE8C;">"Secs to Mit"</span>,
        <span style="color: #A3BE8C;">"Alert Ids"</span>)
    )
    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"{0:&gt;20} | {1:&lt;10} | {2:11} | {3}"</span>.<span style="color: #81A1C1;">format</span>(
        <span style="color: #A3BE8C;">"-"</span>*20,
        <span style="color: #A3BE8C;">"-"</span>*10,
        <span style="color: #A3BE8C;">"-"</span>*11,
        <span style="color: #A3BE8C;">"-"</span>*18)
    )
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Step through the re-organized data and print it</span>
    <span style="color: #81A1C1;">for</span> started_by <span style="color: #81A1C1;">in</span> <span style="color: #81A1C1;">sorted</span>(by_user_type_time):
        <span style="color: #D8DEE9;">tmp_user</span> = started_by
        <span style="color: #81A1C1;">for</span> mit_type <span style="color: #81A1C1;">in</span> <span style="color: #81A1C1;">sorted</span>(by_user_type_time[started_by]):
            <span style="color: #D8DEE9;">tmp_mit_type</span> = mit_type
            <span style="color: #81A1C1;">for</span> a_to_m_secs <span style="color: #81A1C1;">in</span> <span style="color: #81A1C1;">sorted</span>(
                    by_user_type_time[started_by][mit_type]):
                <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"{0:&gt;20} | {1:&lt;10} | {2:11} | {3}"</span>.
                       <span style="color: #81A1C1;">format</span>(
                           tmp_user,
                           tmp_mit_type,
                           a_to_m_secs,
                           <span style="color: #A3BE8C;">", "</span>.join(by_user_type_time[
                               started_by][
                                   mit_type][
                                       a_to_m_secs])))
                <span style="color: #D8DEE9;">tmp_mit_type</span> = <span style="color: #A3BE8C;">''</span>
                <span style="color: #D8DEE9;">tmp_user</span> = <span style="color: #A3BE8C;">''</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alert_start_time</span>(leader, key, alert):
    <span style="color: #4c566a;">"""Get an individual alert via the API and return its start time in</span>
<span style="color: #4c566a;">    python datetime format</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">ALERT_URI</span> = <span style="color: #A3BE8C;">'/api/sp/alerts/'</span>
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + ALERT_URI + alert

    <span style="color: #D8DEE9;">api_response</span> = requests.get(
        URL,
        headers={<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>:
                 key},
        verify=CERT_FILE)

    <span style="color: #81A1C1;">if</span> api_response.status_code != requests.codes.ok:
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"[WARNING] In retrieving information "</span>
              <span style="color: #A3BE8C;">"about alert {}, the API responded `{}'"</span>.
              <span style="color: #81A1C1;">format</span>(api_response.reason, alert),
              <span style="color: #81A1C1;">file</span>=stderr)
        <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">None</span>

    <span style="color: #D8DEE9;">api_response</span> = api_response.json()

    <span style="color: #D8DEE9;">alert_start_time</span> = string_to_date(
        api_response[<span style="color: #A3BE8C;">'data'</span>][<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'start_time'</span>])

    <span style="color: #81A1C1;">return</span> alert_start_time


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">string_to_date</span>(date_string):
    <span style="color: #4c566a;">"""Convert a string in the format YYYY-MM-DDThh:mm:ss to a Python</span>
<span style="color: #4c566a;">    datetime format</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">type</span>(date_string) <span style="color: #81A1C1;">is</span> datetime:
        <span style="color: #81A1C1;">return</span> date_string
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">drop the time offset; if you are using different time zones,</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">don't do this</span>
    <span style="color: #D8DEE9;">date_string</span> = date_string.split(<span style="color: #A3BE8C;">'+'</span>)[0]
    <span style="color: #D8DEE9;">date_string</span> = date_string.split(<span style="color: #A3BE8C;">'.'</span>)[0]
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">convert the time string into a Python datetime object</span>
    <span style="color: #D8DEE9;">date_string</span> = strptime(date_string,
                           <span style="color: #A3BE8C;">"%Y-%m-%dT%H:%M:%S"</span>)
    <span style="color: #D8DEE9;">date_string</span> = datetime.fromtimestamp(
        mktime(date_string)
    )
    <span style="color: #81A1C1;">return</span> date_string


<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">'__main__'</span>:
    <span style="color: #4c566a;">#</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Set the start time to two weeks ago</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">and the end time to now</span>
    <span style="color: #4c566a;">#</span>
    <span style="color: #D8DEE9;">END_TIME</span> = datetime.now()
    <span style="color: #D8DEE9;">START_TIME</span> = END_TIME + timedelta(-14)

    <span style="color: #4c566a;">#</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">set the SP leader hostname and API key</span>
    <span style="color: #4c566a;">#</span>
    <span style="color: #D8DEE9;">SP_LEADER</span> = <span style="color: #A3BE8C;">'leader.example.com'</span>
    <span style="color: #D8DEE9;">API_KEY</span> = <span style="color: #A3BE8C;">'eFvokphdyGHA_M4oLlLtfDnlIf9bpjFnn0mWlDqw'</span>

    <span style="color: #D8DEE9;">mitigations</span> = get_mitigations(SP_LEADER, API_KEY,
                                  START_TIME, END_TIME)
    <span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">not</span> mitigations:
        <span style="color: #81A1C1;">exit</span>

    <span style="color: #4c566a;">#</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a dictionary of alert IDs that contains mitigation start</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">time and (later) the alert start time, the JSON of which would</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">look like:</span>
    <span style="color: #4c566a;">#   </span><span style="color: #4c566a;">{ "&lt;alert_id&gt;":</span>
    <span style="color: #4c566a;">#      </span><span style="color: #4c566a;">{ "mit_start_time": "&lt;mitigation_start_time&gt;",</span>
    <span style="color: #4c566a;">#        </span><span style="color: #4c566a;">"alert_start_time": "&lt;alert_start_time&gt;",</span>
    <span style="color: #4c566a;">#        </span><span style="color: #4c566a;">"mit_type": "{tms,blackhole,flowspec}"</span>
    <span style="color: #4c566a;">#      </span><span style="color: #4c566a;">}</span>
    <span style="color: #4c566a;">#   </span><span style="color: #4c566a;">}</span>
    <span style="color: #4c566a;">#</span>
    <span style="color: #D8DEE9;">alerts</span> = get_alerts_from_mits(mitigations)

    <span style="color: #D8DEE9;">alerts_to_remove</span> = <span style="color: #81A1C1;">list</span>()

    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Get the alert start time for each alert that appears in a</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">mitigation</span>
        alerts[alert][<span style="color: #A3BE8C;">'alert_start_time'</span>] = get_alert_start_time(
            SP_LEADER,
            API_KEY,
            alert
        )
        <span style="color: #D8DEE9;">alert_start_time</span> = alerts[alert][<span style="color: #A3BE8C;">'alert_start_time'</span>]
        <span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">not</span> alert_start_time:
            alerts[alert][<span style="color: #A3BE8C;">'alert_to_mit_seconds'</span>] = <span style="color: #A3BE8C;">'n/a'</span>
            <span style="color: #81A1C1;">continue</span>
        <span style="color: #D8DEE9;">alert_start_time</span> = string_to_date(alert_start_time)
        <span style="color: #81A1C1;">if</span> alert_start_time &lt; START_TIME <span style="color: #81A1C1;">or</span> alert_start_time &gt; END_TIME:
            alerts_to_remove.append(alert)
            <span style="color: #4c566a;"># </span><span style="color: #4c566a;">alerts[alert]['alert_to_mit_seconds'] = 'n/a'</span>
            <span style="color: #81A1C1;">continue</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Get the different in seconds between the</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">alert start and the mitigation start</span>
        alerts[alert][<span style="color: #A3BE8C;">'alert_to_mit_seconds'</span>] = (
            alerts[alert][<span style="color: #A3BE8C;">'mit_start_time'</span>] -
            alerts[alert][<span style="color: #A3BE8C;">'alert_start_time'</span>]
        ).total_seconds()

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">delete alerts from the list that are outside of the specific</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">time; this is needed because the mitigations come back in pages,</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">not necessarily scoped to the specified time frame</span>
    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts_to_remove:
        <span style="color: #81A1C1;">del</span> alerts[alert]

    print_report(alerts,
                 mitigations,
                 SP_LEADER,
                 START_TIME,
                 END_TIME)
</pre>
</div>
<pre class="example">
The time range for the report is
                 from: Tue Aug 29 10:45:05 2017
                   to: Tue Sep 12 10:45:05 2017
Out of 27 mitigations on leader.example.com, 24 have associated alerts
     Mit. Started By | Mit. Type  | Secs to Mit | Alert Ids
-------------------- | ---------- | ----------- | ------------------
               admin | tms        |       211.0 | 71
                     |            |       213.0 | 72
                     |            |       372.0 | 77
                     |            |       481.0 | 65
                     |            |       488.0 | 66
                     |            |       497.0 | 67
                     |            |       504.0 | 68
                     |            |       551.0 | 1913
                     |            |       558.0 | 1912
                     |            |       740.0 | 75
                     |            |       744.0 | 388
                     |            |       819.0 | 387
                     |            |       843.0 | 1910
                     |            |      1255.0 | 1909
                     |            |      1338.0 | 38
                     |            |      1354.0 | 37
                     |            |      1363.0 | 36
                     |            |      1373.0 | 35
                     |            |      2527.0 | 381
                     |            |      4366.0 | 1865
                     |            |     25051.0 | 294
                     |            |     25058.0 | 295
                     |            |     25065.0 | 292
                     |            |     25072.0 | 293
</pre>
</div>
</div>

<div id="outline-container-org400aae1" class="outline-3">
<h3 id="org400aae1"><span class="section-number-3">3.2</span> Example: The Collector with the most system alerts</h3>
<div class="outline-text-3" id="text-3-2">
<p>
When operating an Arbor SP/TMS deployment, looking at system errors
can helpful in diagnosing performance problems.  The following
Python program will gather a list of alerts in the alert class
&ldquo;system&rdquo; and group them by appliance, then print them sorted by the
number of alerts for each appliance.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #4c566a;">"""Example SP API script to retrieve and summarize device system alerts."""</span>
<span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">import</span> arrow     <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 0.10.0</span>
<span style="color: #81A1C1;">import</span> sys
<span style="color: #81A1C1;">import</span> re
<span style="color: #81A1C1;">import</span> requests  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.18.4</span>
<span style="color: #81A1C1;">import</span> urllib    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 1.17</span>

<span style="color: #D8DEE9;">CERT_FILE</span> = <span style="color: #A3BE8C;">'./https_active.crt'</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_page_from_link</span>(link):
    <span style="color: #4c566a;">"""Extract a page number from an API link."""</span>
    <span style="color: #D8DEE9;">match</span> = re.search(r<span style="color: #A3BE8C;">'page=(\d+)'</span>, link)
    <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">int</span>(match.group(1)) <span style="color: #81A1C1;">if</span> match <span style="color: #81A1C1;">else</span> <span style="color: #81A1C1;">None</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_request</span>(url, key, body=<span style="color: #81A1C1;">None</span>):
    <span style="color: #4c566a;">"""General function for making GET and POST requests.</span>

<span style="color: #4c566a;">    Response codes falling within 'requests.codes.ok' are assumed</span>
<span style="color: #4c566a;">    to have completed successfully. Supplying the optional 'body'</span>
<span style="color: #4c566a;">    parameter will change the request type to POST.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        url (str): Valid URL to make request to.</span>
<span style="color: #4c566a;">        key (str): API key generated on the given SP leader.</span>
<span style="color: #4c566a;">        body (str): JSON formatted string containing</span>
<span style="color: #4c566a;">            post body content.</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        dict: 'data' keyvalue of a requests.Response object.</span>
<span style="color: #4c566a;">        dict: 'meta' keyvalue of a requests.Response object.</span>
<span style="color: #4c566a;">        dict: 'links' keyvalue of a requests.Response object.</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">headers</span> = {<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>: key,
               <span style="color: #A3BE8C;">'Content-Type'</span>: <span style="color: #A3BE8C;">'application/vnd.api+json'</span>}
    <span style="color: #81A1C1;">if</span> body <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">None</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.get(
            url,
            headers=headers,
            verify=CERT_FILE)
    <span style="color: #81A1C1;">else</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.post(
            url,
            data=body,
            headers=headers,
            verify=CERT_FILE)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API error responses.</span>
    <span style="color: #81A1C1;">if</span> (api_response.status_code != requests.codes.ok):
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"API responded with this error: \n{}"</span>.<span style="color: #81A1C1;">format</span>(
            api_response.text),
            <span style="color: #81A1C1;">file</span>=sys.stderr)
        <span style="color: #81A1C1;">return</span> ([], {}, {})

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Convert the response to JSON and return it</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #81A1C1;">return</span> (api_response[<span style="color: #A3BE8C;">'data'</span>], api_response[<span style="color: #A3BE8C;">'meta'</span>], api_response[<span style="color: #A3BE8C;">'links'</span>])


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alerts</span>(leader, key, start_time):
    <span style="color: #4c566a;">"""Retrieve alerts from an SP leader.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader (str): SP leader from which the alerts originated</span>
<span style="color: #4c566a;">        key (str): API key generated on the given SP leader</span>
<span style="color: #4c566a;">        start_time (obj): arrow time object to be used</span>
<span style="color: #4c566a;">            a start_time filter for alerts.</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        list: Alerts from the SP leader.</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">alerts</span> = <span style="color: #81A1C1;">list</span>()

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Retrieve the first page of data.</span>
    (first_page, meta, links) = get_alerts_page(leader, key, start_time, 1)
    alerts.extend(first_page)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Retrieve first and last page numbers from the returned links.</span>
    <span style="color: #D8DEE9;">last_page_number</span> = get_page_from_link(links[<span style="color: #A3BE8C;">"last"</span>])
    <span style="color: #D8DEE9;">current_page_number</span> = get_page_from_link(links[<span style="color: #A3BE8C;">"self"</span>])

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Get all remaining pages, add the data</span>
    <span style="color: #81A1C1;">while</span> (current_page_number != last_page_number):
        <span style="color: #D8DEE9;">current_page_number</span> = current_page_number + 1
        (current_page, meta, links) = get_alerts_page(leader, key,
                                                      start_time,
                                                      current_page_number)
        alerts.extend(current_page)

    <span style="color: #81A1C1;">return</span> alerts


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alerts_page</span>(leader, key, start_time, page=1):
    <span style="color: #4c566a;">"""Retrieve a specific page of alerts from an SP leader.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader (str): SP leader from which the alerts originated</span>
<span style="color: #4c566a;">        key (str): API key generated on the given SP leader</span>
<span style="color: #4c566a;">        start_time (obj): arrow time object to be used</span>
<span style="color: #4c566a;">            a start_time filter for alerts.</span>
<span style="color: #4c566a;">        page (int): The specific page of alerts to request.</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        list: A specific page of alerts from the leader.</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Craft the URL components. Filter on alert class and starting time.</span>
    <span style="color: #D8DEE9;">alert_uri</span> = <span style="color: #A3BE8C;">'/api/sp/v3/alerts/'</span>
    <span style="color: #D8DEE9;">filter_value</span> = (<span style="color: #A3BE8C;">"/data/attributes/alert_class = system AND "</span>
                    <span style="color: #A3BE8C;">"/data/attributes/start_time &gt; {0}"</span>.<span style="color: #81A1C1;">format</span>(
                        start_time.<span style="color: #81A1C1;">format</span>(<span style="color: #A3BE8C;">'YYYY-MM-DD:HH:mm:ss'</span>)))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Percent-encode our filter query.</span>
    <span style="color: #D8DEE9;">filter_value</span> = urllib.quote(filter_value, safe=<span style="color: #A3BE8C;">''</span>)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Add the parameters to the request url.</span>
    <span style="color: #D8DEE9;">params</span> = <span style="color: #81A1C1;">list</span>()
    <span style="color: #D8DEE9;">filter_param</span> = <span style="color: #A3BE8C;">"filter={0}"</span>.<span style="color: #81A1C1;">format</span>(filter_value)
    <span style="color: #D8DEE9;">page_param</span> = <span style="color: #A3BE8C;">"page={0}"</span>.<span style="color: #81A1C1;">format</span>(page)
    <span style="color: #D8DEE9;">params</span> = [filter_param, page_param]

    <span style="color: #D8DEE9;">url</span> = <span style="color: #A3BE8C;">"https://{0}{1}?{2}"</span>.<span style="color: #81A1C1;">format</span>(leader, alert_uri, <span style="color: #A3BE8C;">"&amp;"</span>.join(params))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make the api request and return its results.</span>
    <span style="color: #81A1C1;">return</span> api_request(url, key)


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_devices</span>(leader, key):
    <span style="color: #4c566a;">"""Retrieve devices from an SP leader.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader (str): SP leader to retrieve devices from.</span>
<span style="color: #4c566a;">        key (str): API key generated on the given SP leader</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        list: Device data from the leader.</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">device_uri</span> = <span style="color: #A3BE8C;">'/api/sp/v3/devices/'</span>

    <span style="color: #D8DEE9;">url</span> = <span style="color: #A3BE8C;">"https://{0}{1}"</span>.<span style="color: #81A1C1;">format</span>(leader, device_uri)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make the api request and return its results.</span>
    (devices, meta, links) = api_request(url, key)
    <span style="color: #81A1C1;">return</span> devices


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">main</span>():
    <span style="color: #4c566a;">"""Print a list of devices sorted by system alert count."""</span>
    <span style="color: #D8DEE9;">SP_LEADER</span> = <span style="color: #A3BE8C;">'leader.example.com'</span>
    <span style="color: #D8DEE9;">API_KEY</span> = <span style="color: #A3BE8C;">'jrqRzJBV5Ua4t88YWuoTJ8TJsnHBe4qR1phcCvcD'</span>

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a start date one week before the current time.</span>
    <span style="color: #D8DEE9;">arrow_now</span> = arrow.utcnow()
    <span style="color: #D8DEE9;">start_time</span> = arrow_now.shift(weeks=-1)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Get a list of all the system alerts starting later than</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">one week ago.</span>
    <span style="color: #D8DEE9;">alerts</span> = get_alerts(SP_LEADER, API_KEY, start_time)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Get a list of all devices on the leader.</span>
    <span style="color: #D8DEE9;">devices</span> = get_devices(SP_LEADER, API_KEY)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Transform the list into a dictionary keyed by device id.</span>
    <span style="color: #D8DEE9;">device_dict</span> = {device[<span style="color: #A3BE8C;">"id"</span>]: device[<span style="color: #A3BE8C;">"attributes"</span>] <span style="color: #81A1C1;">for</span> device <span style="color: #81A1C1;">in</span> devices}

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a dict keyed by device id containing a count</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">of system errors associated with that device.</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">We will use this data when displaying our list of collectors.</span>
    <span style="color: #D8DEE9;">alert_counts</span> = {}
    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:
        <span style="color: #81A1C1;">try</span>:
            <span style="color: #D8DEE9;">device_id</span> = alert[<span style="color: #A3BE8C;">"relationships"</span>][<span style="color: #A3BE8C;">"device"</span>][<span style="color: #A3BE8C;">"data"</span>][<span style="color: #A3BE8C;">"id"</span>]
        <span style="color: #81A1C1;">except</span> <span style="color: #8FBCBB;">KeyError</span>:
            <span style="color: #81A1C1;">continue</span>

        <span style="color: #D8DEE9;">alert_counts</span>[device_id] = (
            alert_counts[device_id] + 1 <span style="color: #81A1C1;">if</span> device_id <span style="color: #81A1C1;">in</span> alert_counts <span style="color: #81A1C1;">else</span> 1)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Transform the dict into list of dicts containing id</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">and alert_count for each device.</span>
    <span style="color: #D8DEE9;">alert_count_list</span> = [{<span style="color: #A3BE8C;">"id"</span>: key, <span style="color: #A3BE8C;">"alert_count"</span>: value}
                        <span style="color: #81A1C1;">for</span> key, value <span style="color: #81A1C1;">in</span> alert_counts.iteritems()]

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Sort the list in decending order by alert count.</span>
    alert_count_list.sort(reverse=<span style="color: #81A1C1;">True</span>,
                          <span style="color: #81A1C1;">cmp</span>=<span style="color: #81A1C1;">lambda</span> x, y: <span style="color: #81A1C1;">cmp</span>(x[<span style="color: #A3BE8C;">"alert_count"</span>],
                                               y[<span style="color: #A3BE8C;">"alert_count"</span>]))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Display a report of collectors sorted by the number of system alerts</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">found on each collector.</span>
    <span style="color: #D8DEE9;">header_format_string</span> = (
        <span style="color: #A3BE8C;">"==== {alert_count:=&lt;24} {name:=&lt;20} "</span>
        <span style="color: #A3BE8C;">"{device_type:=&lt;20} {ip_address:=&lt;20}"</span>)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Display a header.</span>
    <span style="color: #81A1C1;">print</span>(header_format_string.<span style="color: #81A1C1;">format</span>(alert_count=<span style="color: #A3BE8C;">"System Alert Count "</span>,
                                      name=<span style="color: #A3BE8C;">"Device Name "</span>,
                                      device_type=<span style="color: #A3BE8C;">"Device Type "</span>,
                                      ip_address=<span style="color: #A3BE8C;">"IP Address "</span>))

    <span style="color: #D8DEE9;">format_string</span> = (
        <span style="color: #A3BE8C;">"     {alert_count:&lt;24} {name:20} "</span>
        <span style="color: #A3BE8C;">"{device_type:20} {ip_address:20}"</span>)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Display a row for each device with alerts.</span>
    <span style="color: #81A1C1;">for</span> device <span style="color: #81A1C1;">in</span> alert_count_list:
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Roll in our previously retrieved device data.</span>
        device.update(device_dict[device[<span style="color: #A3BE8C;">"id"</span>]])
        <span style="color: #81A1C1;">print</span>(format_string.<span style="color: #81A1C1;">format</span>(**device))

<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">"__main__"</span>:
    main()
</pre>
</div>

<p>
The output from this is a list of SP appliances with the most
system alerts, that looks something like:
</p>

<pre class="example">
==== System Alert Count ===== Device Name ======== Device Type ======== IP Address =========
     79                       my-leader            pi                   192.168.3.14
     42                       my-tra1              cp                   192.168.3.15
     19                       my-tra2              cp                   192.168.3.16
     14                       my-tms               tms                  192.168.3.17
     7                        my-backupleader      pi                   192.168.26.32
</pre>
</div>
</div>
<div id="outline-container-org23bd1a6" class="outline-3">
<h3 id="org23bd1a6"><span class="section-number-3">3.3</span> Example: Plotting Alert Data</h3>
<div class="outline-text-3" id="text-3-3">
<p>
The SOAP API can give you PNG files that you can use in your
reports.  The REST API does not do that, but you can make your own
using Python and the additional library <code>matplotlib</code><sup><a id="fnr.5" class="footref" href="#fn.5">5</a></sup>.  This example
also introduces the <code>arrow</code> Python package<sup><a id="fnr.6" class="footref" href="#fn.6">6</a></sup>, which makes it easier
to deal with dates and time; it claims to offer &ldquo;a sensible,
human-friendly approach to creating, manipulating, formatting and
converting dates, times, and timestamps&rdquo; and, in this author&rsquo;s
opinion, it delivers on that.
</p>

<p>
The steps to look at this are:
</p>
<ul class="org-ul">
<li>choose an alert for which the traffic across the router is
interesting</li>
<li>get the <code>router_traffic</code> data from the API buy replacing the <code>X</code>
in this URL fragment with the alert ID you are interested in:
<ul class="org-ul">
<li><code>/api/sp/alerts/X/router_traffic/</code></li>
</ul></li>
<li>extract from the alert information the time-series data for
router traffic</li>
<li>turn the data into a time-series that <code>matplotlib</code> can consume
and write out a file for each router involved</li>
</ul>

<p>
This Python program demonstrates reading alert data and using
<code>matplotlib</code> to make a plot of that data.  The plot it creates
using the sample data monitored by SP is in Figure
<a href="#orgf54cdfc">6</a>.
</p>

<div id="orgf54cdfc" class="figure">
<p><img src="./images/alert-data-plot.png" alt="alert-data-plot.png" />
</p>
<p><span class="figure-number">Figure 6: </span>The SOAP API to SP can produce PNG files containing plots of alert traffic data.  The REST API does not offer that exact functionality, but creating plots using Python and the <code>matplotlib</code> library isn&rsquo;t too difficult and offers many more output format and styling options for the plots.</p>
</div>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">from</span> sys <span style="color: #81A1C1;">import</span> stderr
<span style="color: #81A1C1;">import</span> requests  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version 2.18.4</span>
<span style="color: #81A1C1;">import</span> arrow  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version 0.10.0</span>
<span style="color: #81A1C1;">import</span> datetime
<span style="color: #81A1C1;">import</span> matplotlib  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version 2.0.2</span>
matplotlib.use(<span style="color: #A3BE8C;">'Agg'</span>)
<span style="color: #81A1C1;">from</span> matplotlib <span style="color: #81A1C1;">import</span> pyplot <span style="color: #81A1C1;">as</span> plt
<span style="color: #81A1C1;">from</span> matplotlib.dates <span style="color: #81A1C1;">import</span> DayLocator, HourLocator, DateFormatter, drange

<span style="color: #D8DEE9;">ALERT_ID</span> = 870


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">render_matplotlib_png</span>(alert_router_id, points, start, end, step):
    <span style="color: #4c566a;">"""Render a graph PNG based on timeseries data using matplotlib.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        alert_router_id: a alert_id-router_gid string</span>
<span style="color: #4c566a;">        points: timeseries traffic data points</span>
<span style="color: #4c566a;">        start: arrow object representing the start time of the alert</span>
<span style="color: #4c566a;">        end: arrow object reprsenting the end time of the alert</span>
<span style="color: #4c566a;">        step: the time period each entry in the timeseries data spans</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">every day</span>
    <span style="color: #D8DEE9;">days</span> = DayLocator()
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">every hour</span>
    <span style="color: #D8DEE9;">hours</span> = HourLocator(interval=9)
    <span style="color: #D8DEE9;">delta</span> = datetime.timedelta(seconds=step)
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">calculate x axis points based on step and start time</span>
    <span style="color: #D8DEE9;">dates</span> = drange(start, end, delta)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">using AGG</span>
    <span style="color: #D8DEE9;">fig</span> = plt.figure(figsize=(10, 6))
    <span style="color: #D8DEE9;">ax</span> = fig.add_subplot(111)
    ax.plot_date(dates, points, <span style="color: #A3BE8C;">'.-'</span>)
    ax.grid(<span style="color: #81A1C1;">True</span>)
    ax.xaxis.set_major_locator(days)
    ax.xaxis.set_minor_locator(hours)
    ax.xaxis.set_major_formatter(DateFormatter(<span style="color: #A3BE8C;">'%a'</span>))
    ax.xaxis.set_minor_formatter(DateFormatter(<span style="color: #A3BE8C;">'%H:%M'</span>))
    ax.set_xlabel(<span style="color: #A3BE8C;">'time'</span>)
    ax.set_ylabel(<span style="color: #A3BE8C;">'bps'</span>)
    ax.set_title(<span style="color: #A3BE8C;">'Router Traffic - {}'</span>.<span style="color: #81A1C1;">format</span>(alert_router_id))
    fig.autofmt_xdate()
    fig.savefig(<span style="color: #A3BE8C;">'{}.png'</span>.<span style="color: #81A1C1;">format</span>(alert_router_id))


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_get_request</span>(url, api_key):
    <span style="color: #4c566a;">"""Build an API GET request.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        url: a valid SP box url to make the request</span>
<span style="color: #4c566a;">        api_key: API token used to access and use the SP API</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        Dict value for 'data' entry of JSON response</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">api_response</span> = <span style="color: #81A1C1;">None</span>
    <span style="color: #D8DEE9;">api_response</span> = requests.get(
            url,
            headers={
                <span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>: api_key,
                <span style="color: #A3BE8C;">'Content-Type'</span>: <span style="color: #A3BE8C;">'application/vnd.api+json'</span>
            },
            verify=<span style="color: #81A1C1;">False</span>
        )

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle API error responses</span>
    <span style="color: #81A1C1;">if</span> (api_response.status_code &lt; requests.codes.ok <span style="color: #81A1C1;">or</span>
            api_response.status_code &gt;= requests.codes.multiple_choices):
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"API responded with this error: \n{}"</span>.<span style="color: #81A1C1;">format</span>(api_response.text),
              <span style="color: #81A1C1;">file</span>=stderr)
        <span style="color: #81A1C1;">return</span> []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Convert the response to JSON and return</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #81A1C1;">return</span> api_response[<span style="color: #A3BE8C;">'data'</span>]


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alert_traffic_data_router</span>(sp_leader, api_key, alert_id):
    <span style="color: #4c566a;">"""Get router interface Traffic for alert.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        sp_leader: a valid SP box domain name</span>
<span style="color: #4c566a;">        api_key: API token used to access and use the SP API</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        The API response</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #D8DEE9;">alert_uri</span> = <span style="color: #A3BE8C;">"/api/sp/alerts/{}/router_traffic/"</span>.<span style="color: #81A1C1;">format</span>(alert_id)
    <span style="color: #D8DEE9;">url</span> = <span style="color: #A3BE8C;">"https://"</span> + sp_leader + alert_uri

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make API request and reutrn results</span>
    <span style="color: #D8DEE9;">api_response</span> = api_get_request(url, api_key)
    <span style="color: #81A1C1;">return</span> api_response


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">graph_timeseries_data_per_router</span>(router_traffic):
    <span style="color: #4c566a;">"""Grab appropriate data from API response then build graph.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        router_traffic: the dict value for 'data' entry of JSON response</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">not</span> router_traffic:
        <span style="color: #81A1C1;">return</span>

    <span style="color: #81A1C1;">for</span> router <span style="color: #81A1C1;">in</span> router_traffic:
        <span style="color: #D8DEE9;">data</span> = router[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'view'</span>][<span style="color: #A3BE8C;">'network'</span>][<span style="color: #A3BE8C;">'unit'</span>][<span style="color: #A3BE8C;">'bps'</span>]

        <span style="color: #D8DEE9;">step</span> = data[<span style="color: #A3BE8C;">'step'</span>]
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Find the end time. Create arrow datetime objects for start and end.</span>
        <span style="color: #D8DEE9;">start_time</span> = arrow.get(data[<span style="color: #A3BE8C;">'timeseries_start'</span>])
        <span style="color: #D8DEE9;">seconds_after</span> = (step * <span style="color: #81A1C1;">len</span>(data[<span style="color: #A3BE8C;">'timeseries'</span>]))
        <span style="color: #D8DEE9;">start</span>, <span style="color: #D8DEE9;">end</span> = start_time.span(<span style="color: #A3BE8C;">'second'</span>, count=seconds_after)

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Build timeseries graph</span>
        render_matplotlib_png(router[<span style="color: #A3BE8C;">'id'</span>], data[<span style="color: #A3BE8C;">'timeseries'</span>], start, end,
                              step)
    <span style="color: #81A1C1;">return</span>


<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">'__main__'</span>:
    <span style="color: #D8DEE9;">sp_leader</span> = <span style="color: #A3BE8C;">'leader.example.com'</span>
    <span style="color: #D8DEE9;">api_key</span> = <span style="color: #A3BE8C;">'JskW5QLVUMkNn4ruVwXOM0hQdyXCtOwnpkOjOev4'</span>
    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Getting traffic data for alert {} ..."</span>.<span style="color: #81A1C1;">format</span>(ALERT_ID))
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">get router traffic timeseries</span>
    <span style="color: #D8DEE9;">router_traffic</span> = get_alert_traffic_data_router(sp_leader, api_key, ALERT_ID)
    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Rendering graph PNGs..."</span>)
    graph_timeseries_data_per_router(router_traffic)
    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Done."</span>)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7da7022" class="outline-2">
<h2 id="org7da7022"><span class="section-number-2">4</span> Configuration</h2>
<div class="outline-text-2" id="text-4">
<p>
This chapter describes how to configure SP using the SP REST API.
The difference between configuration and operations is that
configuration doesn&rsquo;t assume that SP is collecting flow from any
routers.  While the example programs in this chapter will change the
state of your SP deployment, they can do so without having any
information about or effect on the traffic on your network.
</p>
</div>

<div id="outline-container-orgb5ad129" class="outline-3">
<h3 id="orgb5ad129"><span class="section-number-3">4.1</span> Example: Adding a Managed Object using business information</h3>
<div class="outline-text-3" id="text-4-1">
<p>
The SP REST API can be used to create customer configurations in SP
using data from other business systems (databases, web sites, text
files, etc.) that your company uses to manage its customers.
</p>

<p>
In the example below, the business information is kept in a CSV
file called <code>main.csv</code> that looks like:
</p>
<pre class="example">
name,prefix
test3,192.168.2.71/32
test4,192.168.13.0/24
</pre>
<p>
From this information, we want to create a managed object (MO) in
SP with the MO name coming from the <code>name</code> column and the CIDR
match prefix coming from the <code>prefix</code> column.  In addition, all of
the managed objects will be type <code>customer</code>, will be tagged <code>api</code>,
and will use the mitigation template with the ID 2.
</p>

<p>
The steps to do this are:
</p>
<ul class="org-ul">
<li>read the data from the CSV file</li>
<li>create the managed object JSON with the data that was read and
the data that is constant for all of the managed objects</li>
<li><code>POST</code> the JSON to the <code>managed_objects</code> endpoint</li>
<li>repeat those steps until there isn&rsquo;t any more data in the CSV
file</li>
<li>create a configuration JSON that includes a log message and then
<code>POST</code> that to the <code>config</code> endpoint to write the configuration</li>
</ul>

<p>
When there are no errors, this script simply prints
</p>
<pre class="example">
Committing configuration.
Committed configuration.
</pre>
<p>
to the screen.
</p>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">import</span> csv
<span style="color: #81A1C1;">import</span> json
<span style="color: #81A1C1;">import</span> requests  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.18.4</span>
<span style="color: #81A1C1;">import</span> sys

<span style="color: #D8DEE9;">CERTFILE</span>=<span style="color: #A3BE8C;">"../certfile"</span>

<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_request</span>(URL, key, body=<span style="color: #81A1C1;">None</span>):
    <span style="color: #4c566a;">""" Creates and makes a post request to an SP</span>
<span style="color: #4c566a;">    api service</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        URL: A URL including an SP leader and</span>
<span style="color: #4c566a;">             SP resource</span>
<span style="color: #4c566a;">        key: An api key generated on the given</span>
<span style="color: #4c566a;">             SP leader</span>
<span style="color: #4c566a;">        body: JSON formatted string to be supplied</span>
<span style="color: #4c566a;">              as the request's body</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        'data' value of an SP api response</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">headers</span> = {
        <span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>: key,
        <span style="color: #A3BE8C;">'Content-Type'</span>: <span style="color: #A3BE8C;">'application/vnd.api+json'</span>
    }

    <span style="color: #D8DEE9;">api_response</span> = requests.post(
        URL,
        data=body,
        headers=headers,
        verify=CERTFILE
    )

    <span style="color: #81A1C1;">try</span>:
        api_response.raise_for_status()
    <span style="color: #81A1C1;">except</span> requests.exceptions.HTTPError <span style="color: #81A1C1;">as</span> err:
        <span style="color: #81A1C1;">print</span>(
            <span style="color: #A3BE8C;">'An HTTP {} Error Occured:{}'</span>.<span style="color: #81A1C1;">format</span>(
                <span style="color: #81A1C1;">str</span>(err),
                api_response.text),
            <span style="color: #81A1C1;">file</span>=sys.stderr
        )

        <span style="color: #81A1C1;">return</span> api_response.json()

    <span style="color: #81A1C1;">try</span>:
        <span style="color: #81A1C1;">return</span> api_response.json()[<span style="color: #A3BE8C;">'data'</span>]
    <span style="color: #81A1C1;">except</span> <span style="color: #8FBCBB;">ValueError</span> <span style="color: #81A1C1;">as</span> err:
        <span style="color: #81A1C1;">return</span> {}


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_request_body</span>(managed_object):
    <span style="color: #4c566a;">"""Map a row in a csv to a nested dictionary</span>
<span style="color: #4c566a;">    that SP will accept as a managed object</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        managed_object: flat dictionary from csv</span>
<span style="color: #4c566a;">        representing a single managed object</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        Nested dictionary representing a</span>
<span style="color: #4c566a;">        managed object in SP</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">return</span> {
        <span style="color: #A3BE8C;">'data'</span>: {
            <span style="color: #A3BE8C;">'attributes'</span>: {
                <span style="color: #A3BE8C;">'name'</span>: managed_object[<span style="color: #A3BE8C;">'name'</span>],
                <span style="color: #A3BE8C;">'family'</span>: <span style="color: #A3BE8C;">'customer'</span>,
                <span style="color: #A3BE8C;">'match_type'</span>: <span style="color: #A3BE8C;">'cidr_block'</span>,
                <span style="color: #A3BE8C;">'match'</span>: managed_object[<span style="color: #A3BE8C;">'prefix'</span>],
                <span style="color: #A3BE8C;">'tags'</span>: [<span style="color: #A3BE8C;">'api'</span>]
            },
            <span style="color: #A3BE8C;">'relationships'</span>: {
                <span style="color: #A3BE8C;">'mitigation_template'</span>: {
                    <span style="color: #A3BE8C;">'data'</span>: {
                        <span style="color: #A3BE8C;">'id'</span>: <span style="color: #A3BE8C;">'2'</span>,
                        <span style="color: #A3BE8C;">'type'</span>: <span style="color: #A3BE8C;">'mitigation_template'</span>
                    }
                }
            }
        }
    }


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_managed_objects_from_csv</span>(filename):
    <span style="color: #4c566a;">""" Get a handler for managed object data</span>
<span style="color: #4c566a;">    from a csv file</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        filename: path / name for a csv file</span>
<span style="color: #4c566a;">        containing managed_object configurations.</span>
<span style="color: #4c566a;">        The first line of the csv is a header,</span>
<span style="color: #4c566a;">        containing "name,prefix". Similarly,</span>
<span style="color: #4c566a;">        subsequent lines represent managed objects.</span>
<span style="color: #4c566a;">        E.g., "Wind,74.182.59.3/32".</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        A generator returning managed objects in</span>
<span style="color: #4c566a;">        nested dict form</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">with</span> <span style="color: #81A1C1;">open</span>(filename) <span style="color: #81A1C1;">as</span> listings:
        <span style="color: #81A1C1;">for</span> row <span style="color: #81A1C1;">in</span> csv.DictReader(listings):
            <span style="color: #81A1C1;">yield</span> get_request_body(row)


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">create_managed_object</span>(leader, key, managed_object):
    <span style="color: #4c566a;">""" Crafts and makes an api request to create</span>
<span style="color: #4c566a;">    an SP managed object</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: hostname of an SP leader</span>
<span style="color: #4c566a;">        key: api key, as generated by the</span>
<span style="color: #4c566a;">             SP leader</span>
<span style="color: #4c566a;">        managed_object: nested dict representing</span>
<span style="color: #4c566a;">                        the managed_object being</span>
<span style="color: #4c566a;">                        created</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        Id as string of new managed object, or</span>
<span style="color: #4c566a;">        None if request was unsuccessful</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">object_json</span> = json.dumps(managed_object)

    <span style="color: #D8DEE9;">response</span> = api_request(
        <span style="color: #A3BE8C;">'https://{}/api/sp/managed_objects/'</span>.<span style="color: #81A1C1;">format</span>(leader),
        key,
        object_json
    )

    <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'errors'</span> <span style="color: #81A1C1;">in</span> response:
        <span style="color: #81A1C1;">print</span>(
            <span style="color: #A3BE8C;">'Could not create managed object...'</span>,
            <span style="color: #81A1C1;">file</span>=sys.stderr
        )
        <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">None</span>

    <span style="color: #81A1C1;">return</span> response[<span style="color: #A3BE8C;">"id"</span>]


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">commit_config</span>(leader, key):
    <span style="color: #4c566a;">""" Crafts and makes an api request to commit an</span>
<span style="color: #4c566a;">        SP configuration</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: hostname of an SP leader</span>
<span style="color: #4c566a;">        key: api key, as generated by said SP leader</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        boolean indicating the success of the</span>
<span style="color: #4c566a;">        operation</span>
<span style="color: #4c566a;">    """</span>
    <span style="color: #81A1C1;">print</span> (<span style="color: #A3BE8C;">"Committing configuration."</span>)
    <span style="color: #D8DEE9;">commit_msg</span> = json.dumps({
        <span style="color: #A3BE8C;">'data'</span>: {
            <span style="color: #A3BE8C;">'attributes'</span>: {
                <span style="color: #A3BE8C;">'commit_log_message'</span>:
                    <span style="color: #A3BE8C;">'Added managed objects to deployment via SP API'</span>
            }
        }
    })

    <span style="color: #D8DEE9;">response</span> = api_request(
        <span style="color: #A3BE8C;">'https://{}/api/sp/config/'</span>.<span style="color: #81A1C1;">format</span>(leader),
        key,
        commit_msg
    )

    <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'errors'</span> <span style="color: #81A1C1;">in</span> response:
        <span style="color: #81A1C1;">print</span>(
            <span style="color: #A3BE8C;">"Could not commit configuration..."</span>,
            <span style="color: #81A1C1;">file</span>=sys.stderr
        )
        <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">False</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Committed configuration."</span>)
    <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">True</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">main</span>():
    <span style="color: #D8DEE9;">LEADER</span> = <span style="color: #A3BE8C;">"leader.example.com"</span>
    <span style="color: #D8DEE9;">KEY</span> = <span style="color: #A3BE8C;">"eFvokphdyGHA_M4oLlLtfDnlIf9bpjFnn0mWlDqw"</span>

    <span style="color: #81A1C1;">for</span> listing <span style="color: #81A1C1;">in</span> get_managed_objects_from_csv(<span style="color: #A3BE8C;">'main.csv'</span>):
        create_managed_object(LEADER, KEY, listing)

    commit_config(LEADER, KEY)


<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">"__main__"</span>:
    main()
</pre>
</div>
</div>
</div>

<div id="outline-container-org81e95d2" class="outline-3">
<h3 id="org81e95d2"><span class="section-number-3">4.2</span> Example: Setting Appliance Monitoring Limits</h3>
<div class="outline-text-3" id="text-4-2">
<p>
Starting with SPv8.0 monitoring appliances in your SP/TMS
deployment improved with the addition of the Appliance Monitoring
page (available under the System &gt; Status menu in the web UI).  The
Appliance Monitoring page allows you to configure limits for all of
the metrics it displays; those limits are used to sort the graphs
and to color them relatively more red as the limit is exceeded.
</p>

<p>
Configuring those limits is done from the SP command line.  For
each appliance, you set the limits you want for each metric.  So if
you have 10 appliances in your deployment and want to set the &ldquo;Disk
used %&rdquo; and &ldquo;Items tracked per day&rdquo;, it requires 20 command line
entries.  There are 86 total metrics, so even configuring one
quarter of those would require 20 command line entries per
appliance.
</p>

<p>
A much easier way to do this is to establish the limits outside of
SP, and use the REST API to apply them to all of the appliances.
</p>

<p>
The Python program below sets the <code>items_tracked_per_day</code> metric to
have a limit of 15 for each of the appliances that the leader
knows about.
</p>

<p>
The steps to do this are:
</p>
<ul class="org-ul">
<li>get a list of the appliances</li>
<li>iterate over that list</li>
<li>check that the metric isn&rsquo;t already set (you could also make sure
it was within some limits and correct it if it wasn&rsquo;t, etc.)</li>
<li>if it isn&rsquo;t set, set it</li>
</ul>

<p>
The output from running this script when the limit isn&rsquo;t set looks
like:
</p>
<pre class="example">
Starting appliance-limiting script
Retrieving appliances from leader.example.com
Appliances retrieved. Configuring limits
Device 115: metrics_items_tracked_per_day_limit configured
Device 116: metrics_items_tracked_per_day_limit configured
Device 121: metrics_items_tracked_per_day_limit configured
Device 184: metrics_items_tracked_per_day_limit configured
Done
</pre>
<p>
While when the limits are set, it looks like:
</p>
<pre class="example">
Starting appliance-limiting script
Retrieving appliances from leader.example.com
Appliances retrieved. Configuring limits
Device 115: metrics_items_tracked_per_day_limit is already configured
Device 116: metrics_items_tracked_per_day_limit is already configured
Device 121: metrics_items_tracked_per_day_limit is already configured
Device 184: metrics_items_tracked_per_day_limit is already configured
Done
</pre>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">import</span> sys
<span style="color: #81A1C1;">import</span> requests  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.18.4</span>
<span style="color: #81A1C1;">import</span> json  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.0.9</span>

<span style="color: #D8DEE9;">CERT_FILE</span> = <span style="color: #A3BE8C;">'./https_active.crt'</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_request</span>(URL, key, body=<span style="color: #81A1C1;">None</span>):
    <span style="color: #4c566a;">""" General function for making GET and PATCH requests</span>

<span style="color: #4c566a;">    Response codes falling within 'requests.codes.ok' are assumed</span>
<span style="color: #4c566a;">    to have completed successfully. Supplying the optional 'body'</span>
<span style="color: #4c566a;">    parameter will change the request type to PATCH.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        URL: valid URL to make request to</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>
<span style="color: #4c566a;">        body (optional): JSON formatted string containing</span>
<span style="color: #4c566a;">            patch body content</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        'Data' keyvalue of a requests.Response object</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">headers</span> = {<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>: key,
               <span style="color: #A3BE8C;">'Content-Type'</span>: <span style="color: #A3BE8C;">'application/vnd.api+json'</span>}
    <span style="color: #81A1C1;">if</span> body <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">None</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.get(
            URL,
            headers=headers,
            verify=CERT_FILE)
    <span style="color: #81A1C1;">else</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.patch(
            URL,
            data=body,
            headers=headers,
            verify=CERT_FILE)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API error responses</span>
    <span style="color: #81A1C1;">if</span> (api_response.status_code != requests.codes.ok):
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"API responded with this error: \n{}"</span>.<span style="color: #81A1C1;">format</span>(
            api_response.text),
            <span style="color: #81A1C1;">file</span>=sys.stderr)
        <span style="color: #81A1C1;">return</span> []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Convert the response to JSON and return it</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #81A1C1;">return</span> api_response[<span style="color: #A3BE8C;">'data'</span>]


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_appliances</span>(leader, key):
    <span style="color: #4c566a;">"""Retrieve appliances from an SP leader</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: SP leader from which the appliances exist</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        List of appliances from the SP leader</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Retrieving appliances from {}"</span>.<span style="color: #81A1C1;">format</span>(leader))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Craft the URL components</span>
    <span style="color: #D8DEE9;">APPLIANCE_URI</span> = <span style="color: #A3BE8C;">'/api/sp/devices/'</span>
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + APPLIANCE_URI

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make the api request and return its results</span>
    <span style="color: #D8DEE9;">api_response</span> = api_request(URL, key)
    <span style="color: #81A1C1;">return</span> api_response


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">set_limits</span>(leader, key, appliances):
    <span style="color: #4c566a;">""" Configure the provided appliances with limits</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: SP leader from which the appliances exist</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>
<span style="color: #4c566a;">        appliances: List of appliances</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">for</span> appliance <span style="color: #81A1C1;">in</span> appliances:
        <span style="color: #D8DEE9;">LIMIT</span> = <span style="color: #A3BE8C;">'metrics_items_tracked_per_day_limit'</span>
        <span style="color: #D8DEE9;">LIMIT_VALUE</span> = 15
        <span style="color: #81A1C1;">if</span> LIMIT <span style="color: #81A1C1;">not</span> <span style="color: #81A1C1;">in</span> appliance[<span style="color: #A3BE8C;">'attributes'</span>]:
            <span style="color: #D8DEE9;">patch</span> = {
                <span style="color: #A3BE8C;">"data"</span>: {
                    <span style="color: #A3BE8C;">"attributes"</span>: {
                        LIMIT: LIMIT_VALUE
                    }
                }
            }

            <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a unique URL for the appliance</span>
            <span style="color: #D8DEE9;">DEVICE_URI</span> = (<span style="color: #A3BE8C;">"/api/sp/devices/{}"</span>.<span style="color: #81A1C1;">format</span>(
                appliance[<span style="color: #A3BE8C;">'id'</span>]))
            <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + DEVICE_URI

            <span style="color: #4c566a;"># </span><span style="color: #4c566a;">PATCH the appliance</span>
            <span style="color: #D8DEE9;">api_response</span> = api_request(URL, key, json.dumps(patch))

            <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API response</span>
            <span style="color: #81A1C1;">if</span> api_response:
                <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Device {id}: {limit} configured"</span>.<span style="color: #81A1C1;">format</span>(
                    <span style="color: #81A1C1;">id</span>=appliance[<span style="color: #A3BE8C;">'id'</span>], limit=LIMIT))
            <span style="color: #81A1C1;">else</span>:
                <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Could not configure device {}"</span>.<span style="color: #81A1C1;">format</span>(
                    appliance[<span style="color: #A3BE8C;">'id'</span>]),
                    <span style="color: #81A1C1;">file</span>=sys.stderr)

        <span style="color: #81A1C1;">else</span>:
            <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Device {id}: {limit} is already configured"</span>.<span style="color: #81A1C1;">format</span>(
                <span style="color: #81A1C1;">id</span>=appliance[<span style="color: #A3BE8C;">'id'</span>], limit=LIMIT))


<span style="color: #4c566a;">#####################</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Start the Program #</span>
<span style="color: #4c566a;">#####################</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">main</span>():
    <span style="color: #D8DEE9;">SP_LEADER</span> = <span style="color: #A3BE8C;">'leader.example.com'</span>
    <span style="color: #D8DEE9;">API_KEY</span> = <span style="color: #A3BE8C;">'okw_TF2PLL20ojZ1ptzazGh6TPS0C2MlqpO3LDzv'</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Starting appliance-limiting script'</span>)
    <span style="color: #D8DEE9;">appliances</span> = get_appliances(SP_LEADER, API_KEY)
    <span style="color: #81A1C1;">if</span> appliances:
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Appliances retrieved. Configuring limits'</span>)
        set_limits(SP_LEADER, API_KEY, appliances)

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Done'</span>)

<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">"__main__"</span>:
    main()
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org10a0774" class="outline-2">
<h2 id="org10a0774"><span class="section-number-2">5</span> Operations</h2>
<div class="outline-text-2" id="text-5">
<p>
This chapter will describe how to use the SP REST API
operationally.  The difference between configuration and operations
is that operations requires SP to be receiving and processing
traffic, generating alerts, routing traffic to TMSs, and other
functions that SP provides that help you operate your network.
</p>
</div>

<div id="outline-container-orgf393fb9" class="outline-3">
<h3 id="orgf393fb9"><span class="section-number-3">5.1</span> Example: Starting a Mitigation</h3>
<div class="outline-text-3" id="text-5-1">
<p>
There is no better product than Arbor Networks&rsquo; SP and TMS for
detecting and mitigating distributed denial of service attacks on
networks, and the automatic mitigations started by SP are very
effective.  However, SP provides no facility for additional
decision making when deciding whether or not to mitigation a
suspected DDoS attacks.  Using the SP REST API allows you to
construct your own set of rules around what to mitigate and when to
mitigate it.
</p>

<p>
The example Python program below demonstrates how to read alerts
from an SP leader, make some decisions about whether or not to
mitigate them, and then start the mitigatons.
</p>

<p>
In the case of the example program below, the function
<code>apply_rules</code> takes a list of alerts and their details, filters
them by the rules, and returns the rules and their details that
match the criteria:
</p>
<ul class="org-ul">
<li>the alert importance is High</li>
<li>the alert hasn&rsquo;t ended</li>
<li>the alert is a DoS Host alert</li>
</ul>

<p>
The steps to look at this are:
</p>
<ul class="org-ul">
<li>establish a time period over which you want to consider the
alerts</li>
<li>collect the alerts that were started in that time frame
using the REST API</li>
<li>filter out the alerts that don&rsquo;t match the rules for mitigation</li>
<li>use the REST API to create and start mitigations the alerts that
do match the rules</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">from</span> datetime <span style="color: #81A1C1;">import</span> datetime, timedelta
<span style="color: #81A1C1;">from</span> sys <span style="color: #81A1C1;">import</span> stderr
<span style="color: #81A1C1;">import</span> requests
<span style="color: #81A1C1;">import</span> json
<span style="color: #81A1C1;">import</span> urllib

<span style="color: #D8DEE9;">CERT_FILE</span> = <span style="color: #A3BE8C;">'./certfile'</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_request</span>(URL, key, body=<span style="color: #81A1C1;">None</span>):
    <span style="color: #4c566a;">"""Define a function for making API GET</span>
<span style="color: #4c566a;">    Requests If body is supplied,</span>
<span style="color: #4c566a;">    request type will be POST</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">api_response</span> = <span style="color: #81A1C1;">None</span>
    <span style="color: #81A1C1;">if</span> body <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">None</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.get(
            URL,
            headers={<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>:
                     key,
                     <span style="color: #A3BE8C;">'Content-Type'</span>:
                     <span style="color: #A3BE8C;">'application/vnd.api+json'</span>},
            verify=CERT_FILE)
    <span style="color: #81A1C1;">else</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.post(
            URL,
            data=body,
            headers={<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>:
                     key,
                     <span style="color: #A3BE8C;">'Content-Type'</span>:
                     <span style="color: #A3BE8C;">'application/vnd.api+json'</span>},
            verify=CERT_FILE)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API error responses</span>
    <span style="color: #81A1C1;">if</span> (api_response.status_code &lt; requests.codes.ok <span style="color: #81A1C1;">or</span>
            api_response.status_code &gt;= requests.codes.multiple_choices):
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"API responded with this error: \n{}"</span>
              .<span style="color: #81A1C1;">format</span>(
                  api_response.text),
              <span style="color: #81A1C1;">file</span>=stderr)

        <span style="color: #81A1C1;">return</span> []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Convert the response to JSON and return it</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #81A1C1;">return</span> api_response[<span style="color: #A3BE8C;">'data'</span>]


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alerts</span>(leader, key, period):
    <span style="color: #4c566a;">"""Define a function for retrieving</span>
<span style="color: #4c566a;">    alerts from an SP Leader</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">timefmt</span> = <span style="color: #A3BE8C;">'%a %b %d %H:%M:%S %Y'</span>
    <span style="color: #D8DEE9;">time</span> = period.strftime(timefmt)
    <span style="color: #D8DEE9;">iso_time</span> = period.isoformat()

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Fetching alerts from {} onwards"</span>
          .<span style="color: #81A1C1;">format</span>(time))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Craft the URL components, filtering</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">based on time period</span>

    <span style="color: #D8DEE9;">ALERT_URI</span> = <span style="color: #A3BE8C;">"/api/sp/alerts/?filter="</span>
    <span style="color: #D8DEE9;">FILTER</span> = <span style="color: #A3BE8C;">"/data/attributes/start_time &gt; "</span> + iso_time

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Percent-encode our filter query and combine URL components</span>
    <span style="color: #D8DEE9;">FILTER</span> = urllib.quote(FILTER, safe=<span style="color: #A3BE8C;">''</span>)
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + ALERT_URI + FILTER

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make the api request and return its results</span>
    <span style="color: #D8DEE9;">api_response</span> = api_request(URL, key)
    <span style="color: #81A1C1;">return</span> api_response


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">apply_rules</span>(alerts):
    <span style="color: #4c566a;">"""Define a function for filtering</span>
<span style="color: #4c566a;">    alerts based on rules</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">filtered_alerts</span> = []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Return alerts that match the following rules:</span>
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Importance = High, Ongoing = True, Alert Type = DOS</span>
    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:
        <span style="color: #D8DEE9;">attributes</span> = alert[<span style="color: #A3BE8C;">'attributes'</span>]
        <span style="color: #81A1C1;">if</span> (attributes[<span style="color: #A3BE8C;">'importance'</span>] == 2 <span style="color: #81A1C1;">and</span>
                attributes[<span style="color: #A3BE8C;">'ongoing'</span>] <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">True</span> <span style="color: #81A1C1;">and</span>
                attributes[<span style="color: #A3BE8C;">'alert_type'</span>] == <span style="color: #A3BE8C;">'dos_host_detection'</span>):
            filtered_alerts.append(alert)

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"{} alert(s) match mitigation criterion"</span>
          .<span style="color: #81A1C1;">format</span>(<span style="color: #81A1C1;">len</span>(filtered_alerts)))
    <span style="color: #81A1C1;">return</span> filtered_alerts


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">extract_mitigation_attr</span>(alert):
    <span style="color: #4c566a;">"""Define a function for extracting</span>
<span style="color: #4c566a;">    mitigation attributes from alerts</span>

<span style="color: #4c566a;">    """</span>

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Configure mitigation information for the current alert</span>
    <span style="color: #D8DEE9;">name</span> = <span style="color: #A3BE8C;">"Alert {} Auto-API-Mitigation"</span>.<span style="color: #81A1C1;">format</span>(
        alert[<span style="color: #A3BE8C;">'id'</span>])
    <span style="color: #D8DEE9;">description</span> = <span style="color: #A3BE8C;">"Mitigation triggered by script via REST API"</span>
    <span style="color: #D8DEE9;">ongoing</span> = <span style="color: #81A1C1;">True</span>
    <span style="color: #D8DEE9;">ip_version</span> = alert[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'subobject'</span>][<span style="color: #A3BE8C;">'ip_version'</span>]
    <span style="color: #D8DEE9;">protection_cidr</span> = <span style="color: #A3BE8C;">'/32'</span>
    <span style="color: #81A1C1;">if</span> ip_version == 6:
        <span style="color: #D8DEE9;">protection_cidr</span> = <span style="color: #A3BE8C;">'/128'</span>
    <span style="color: #D8DEE9;">subobject</span> = {
        <span style="color: #A3BE8C;">'bgp_announce'</span>: <span style="color: #81A1C1;">False</span>,
        <span style="color: #A3BE8C;">'protection_prefixes'</span>:
            [alert[<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'subobject'</span>][<span style="color: #A3BE8C;">'host_address'</span>] +
             protection_cidr]
    }
    <span style="color: #D8DEE9;">subtype</span> = <span style="color: #A3BE8C;">'tms'</span>
    <span style="color: #D8DEE9;">attributes</span> = {
        <span style="color: #A3BE8C;">"name"</span>: name,
        <span style="color: #A3BE8C;">"description"</span>: description,
        <span style="color: #A3BE8C;">"ongoing"</span>: ongoing,
        <span style="color: #A3BE8C;">"ip_version"</span>: ip_version,
        <span style="color: #A3BE8C;">"subobject"</span>: subobject,
        <span style="color: #A3BE8C;">"subtype"</span>: subtype
    }

    <span style="color: #81A1C1;">return</span> attributes


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">mitigate</span>(leader, key, alerts):
    <span style="color: #4c566a;">"""Define a function for mitigating alerts"""</span>

    <span style="color: #D8DEE9;">mitigations</span> = []
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a POST body for each mitigation to make</span>
    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:
        <span style="color: #D8DEE9;">attributes</span> = extract_mitigation_attr(alert)
        <span style="color: #D8DEE9;">post</span> = {
            <span style="color: #A3BE8C;">"data"</span>: {
                <span style="color: #A3BE8C;">"attributes"</span>: attributes,
                <span style="color: #A3BE8C;">"alert"</span>: {
                    <span style="color: #A3BE8C;">"data"</span>: {
                        <span style="color: #A3BE8C;">"id"</span>: alert[<span style="color: #A3BE8C;">'id'</span>],
                        <span style="color: #A3BE8C;">"type"</span>: <span style="color: #A3BE8C;">"alert"</span>
                    }
                },
                <span style="color: #A3BE8C;">"relationships"</span>: {
                    <span style="color: #A3BE8C;">"tms_group"</span>: {
                        <span style="color: #A3BE8C;">"data"</span>: {
                            <span style="color: #A3BE8C;">"id"</span>: <span style="color: #A3BE8C;">"3"</span>,
                            <span style="color: #A3BE8C;">"type"</span>: <span style="color: #A3BE8C;">"tms_group"</span>
                        }
                    }
                }
            }
        }
        mitigations.append(post)

    <span style="color: #D8DEE9;">MIT_URI</span> = <span style="color: #A3BE8C;">'/api/sp/mitigations/'</span>
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + MIT_URI
    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">POST mitigations for each POST body created</span>
    <span style="color: #81A1C1;">for</span> mitigation <span style="color: #81A1C1;">in</span> mitigations:
        <span style="color: #D8DEE9;">api_response</span> = api_request(URL,
                                   key,
                                   json.dumps(mitigation))

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API responses</span>
        <span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">len</span>(api_response) &gt; 0:
            <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"{} started"</span>
                  .<span style="color: #81A1C1;">format</span>(mitigation[<span style="color: #A3BE8C;">'data'</span>][<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'name'</span>]))
        <span style="color: #81A1C1;">else</span>:
            <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Could not start mitigation: {}"</span>
                  .<span style="color: #81A1C1;">format</span>(mitigation[<span style="color: #A3BE8C;">'data'</span>][<span style="color: #A3BE8C;">'attributes'</span>][<span style="color: #A3BE8C;">'name'</span>]))

<span style="color: #4c566a;">###################</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Start the program #</span>
<span style="color: #4c566a;">###################</span>
<span style="color: #D8DEE9;">SP_LEADER</span> = <span style="color: #A3BE8C;">'leader.example.com</span>
<span style="color: #A3BE8C;">API_KEY = '</span>viZqKYlEPKSWSpvzftr3Bs8Lqu_7u7_l8yiwxaD9<span style="color: #A3BE8C;">'</span>

<span style="color: #A3BE8C;">TIMEFRAME = datetime.now() - timedelta(minutes=15)</span>

<span style="color: #A3BE8C;">print("Starting auto-mitigation script")</span>
<span style="color: #A3BE8C;">alerts = get_alerts(SP_LEADER, API_KEY, TIMEFRAME)</span>
<span style="color: #A3BE8C;">if len(alerts) &gt; 0:</span>
<span style="color: #A3BE8C;">    print("Alerts retrieved. Filtering on configured ruleset")</span>
<span style="color: #A3BE8C;">    target_alerts = apply_rules(alerts)</span>

<span style="color: #A3BE8C;">    if len(target_alerts) &gt; 0:</span>
<span style="color: #A3BE8C;">        print("Mitigating alerts")</span>
<span style="color: #A3BE8C;">        mitigate(SP_LEADER, API_KEY, target_alerts)</span>
<span style="color: #A3BE8C;">        print("Done")</span>
<span style="color: #A3BE8C;">else:</span>
<span style="color: #A3BE8C;">    print("No alerts were found in the requested period")</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6f7227d" class="outline-3">
<h3 id="org6f7227d"><span class="section-number-3">5.2</span> Example: Adding an annotation</h3>
<div class="outline-text-3" id="text-5-2">
<p>
SP will automatically add annotations to alerts in many cases,
including changes in the severity of an alert and when a mitigation
is started for the alert.  Each set of annotations for an alert can
then be viewed in the SP web UI or retrieved via the SP REST API
to follow the progress of an alert over time.
</p>

<p>
Your organization may want to automatically add annotations to make
the annotation history of an alert more useful.
</p>

<p>
The following Python program adds the alert impact information (the
impact in bits-per-second and packets-per-second and the impact
boundary) to all of the running alerts every time it is run.
Running this every 4 hours would give a nice history of the impact
of an alert over time.
</p>

<p>
When run, this program prints out:
</p>
<pre class="example">
Starting auto-annotation script
Fetching ongoing alerts from leader.example.com
Alerts retrieved. Auto-annotating impact data
Annotating 11 ongoing alerts with impact data
Alert 8067 annotated
Alert 8066 annotated
Alert 8063 annotated
Alert 8062 annotated
Alert 8061 annotated
Alert 8060 annotated
Alert 8055 annotated
Alert 7814 annotated
Alert 5913 annotated
Alert 5912 annotated
Alert 5904 annotated
Done
</pre>

<p>
And the annotation text, via the API looks like:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"meta"</span>: {
        <span style="color: #81A1C1;">"sp_version"</span>: <span style="color: #A3BE8C;">"8.3"</span>,
        <span style="color: #81A1C1;">"api"</span>: <span style="color: #A3BE8C;">"SP"</span>,
        <span style="color: #81A1C1;">"api_version"</span>: <span style="color: #A3BE8C;">"3"</span>,
        <span style="color: #81A1C1;">"sp_build_id"</span>: <span style="color: #A3BE8C;">"HIT4"</span>
    },
    <span style="color: #81A1C1;">"data"</span>: [
        {
            <span style="color: #81A1C1;">"attributes"</span>: {
                <span style="color: #81A1C1;">"text"</span>: <span style="color: #A3BE8C;">"Impact on boundary 'rtr1.nyc'; Impact in bps: 10558611; Impact in pps: 1707;"</span>,
                <span style="color: #81A1C1;">"added"</span>: <span style="color: #A3BE8C;">"2017-09-25T19:34:12+00:00"</span>,
                <span style="color: #81A1C1;">"author"</span>: <span style="color: #A3BE8C;">"API-Client"</span>
            },
            <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>,
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"21168"</span>
        },
        {
            <span style="color: #81A1C1;">"attributes"</span>: {
                <span style="color: #81A1C1;">"text"</span>: <span style="color: #A3BE8C;">"Impact on boundary 'rtr1.nyc'; Impact in bps: 10558611; Impact in pps: 1707;"</span>,
                <span style="color: #81A1C1;">"added"</span>: <span style="color: #A3BE8C;">"2017-09-25T19:33:34+00:00"</span>,
                <span style="color: #81A1C1;">"author"</span>: <span style="color: #A3BE8C;">"API-Client"</span>
            },
            <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>,
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"21157"</span>
        },
        {
            <span style="color: #81A1C1;">"attributes"</span>: {
                <span style="color: #81A1C1;">"text"</span>: <span style="color: #A3BE8C;">"The \"TCP NULL\" host alert signature severity rate configured for \"Customer\" has been exceeded for 2 minutes, changing Severity Level from medium to high  (expected rate: 1.00 Kpps, observed rate: 1.70 Kpps)"</span>,
                <span style="color: #81A1C1;">"added"</span>: <span style="color: #A3BE8C;">"2017-09-25T19:18:45+00:00"</span>,
                <span style="color: #81A1C1;">"author"</span>: <span style="color: #A3BE8C;">"auto-annotation"</span>
            },
            <span style="color: #81A1C1;">"type"</span>: <span style="color: #A3BE8C;">"alert_annotation"</span>,
            <span style="color: #81A1C1;">"id"</span>: <span style="color: #A3BE8C;">"21155"</span>
        }
    ],
    <span style="color: #81A1C1;">"links"</span>: {
        <span style="color: #81A1C1;">"self"</span>: <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/v3/alerts/8067/annotations/"</span>
    }
}
</pre>
</div>

<p>
The source code for the Python program that generates this follows,
and the steps are:
</p>

<ul class="org-ul">
<li>gather the alerts that match the filter</li>
<li>for each alert extract the impact data from its <code>attributes</code>
section in the returned JSON</li>
<li>create annotation text</li>
<li>annotate the alert with the new annotation text containing the
impact information (<code>POST</code> to the <code>/alert/&lt;id&gt;/annotations/</code>
endpoint)</li>
</ul>

<div class="org-src-container">
<pre class="src src-python"><span style="color: #81A1C1;">from</span> __future__ <span style="color: #81A1C1;">import</span> print_function
<span style="color: #81A1C1;">from</span> datetime <span style="color: #81A1C1;">import</span> datetime, timedelta
<span style="color: #81A1C1;">import</span> sys
<span style="color: #81A1C1;">import</span> requests  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.18.4</span>
<span style="color: #81A1C1;">import</span> json  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 2.0.9</span>
<span style="color: #81A1C1;">import</span> urllib  <span style="color: #4c566a;"># </span><span style="color: #4c566a;">version: 1.17</span>

<span style="color: #D8DEE9;">CERT_FILE</span> = <span style="color: #A3BE8C;">'./https_active.crt'</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">api_request</span>(URL, key, body=<span style="color: #81A1C1;">None</span>):
    <span style="color: #4c566a;">""" General function for making GET and POST requests</span>

<span style="color: #4c566a;">    Response codes falling within 'requests.codes.ok' are assumed</span>
<span style="color: #4c566a;">    to have completed successfully. Supplying the optional 'body'</span>
<span style="color: #4c566a;">    parameter will change the request type to POST.</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        URL: valid URL to make request to</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>
<span style="color: #4c566a;">        body (optional): JSON formatted string containing</span>
<span style="color: #4c566a;">            post body content</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        'Data' keyvalue of a requests.Response object</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #D8DEE9;">headers</span> = {<span style="color: #A3BE8C;">'X-Arbux-APIToken'</span>: key,
               <span style="color: #A3BE8C;">'Content-Type'</span>: <span style="color: #A3BE8C;">'application/vnd.api+json'</span>}
    <span style="color: #81A1C1;">if</span> body <span style="color: #81A1C1;">is</span> <span style="color: #81A1C1;">None</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.get(
            URL,
            headers=headers,
            verify=CERT_FILE)
    <span style="color: #81A1C1;">else</span>:
        <span style="color: #D8DEE9;">api_response</span> = requests.post(
            URL,
            data=body,
            headers=headers,
            verify=CERT_FILE)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API error responses</span>
    <span style="color: #81A1C1;">if</span> (api_response.status_code != requests.codes.ok):
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"API responded with this error: \n{}"</span>.<span style="color: #81A1C1;">format</span>(
            api_response.text),
            <span style="color: #81A1C1;">file</span>=sys.stderr)
        <span style="color: #81A1C1;">return</span> []

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Convert the response to JSON and return it</span>
    <span style="color: #D8DEE9;">api_response</span> = api_response.json()
    <span style="color: #81A1C1;">return</span> api_response[<span style="color: #A3BE8C;">'data'</span>]


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">get_alerts</span>(leader, key):
    <span style="color: #4c566a;">""" Retrieve alerts from an SP leader</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: SP leader from which the alerts originated</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        List of impact data containing alerts</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Fetching ongoing alerts from {}"</span>.<span style="color: #81A1C1;">format</span>(leader))

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Craft the URL components, filtering based on ongoing dos alerts</span>
    <span style="color: #D8DEE9;">ALERT_URI</span> = <span style="color: #A3BE8C;">'/api/sp/alerts/?filter='</span>
    <span style="color: #D8DEE9;">FILTER</span> = (<span style="color: #A3BE8C;">"/data/attributes/ongoing = true AND "</span> +
              <span style="color: #A3BE8C;">"/data/attributes/alert_class = dos"</span>)

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Percent-encode our filter query and combine URL components</span>
    <span style="color: #D8DEE9;">FILTER</span> = urllib.quote(FILTER, safe=<span style="color: #A3BE8C;">''</span>)
    <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + ALERT_URI + FILTER

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Make the api request and return its results</span>
    <span style="color: #D8DEE9;">api_response</span> = api_request(URL, key)
    <span style="color: #81A1C1;">return</span> api_response


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">create_annotation_msg</span>(impact_data):
    <span style="color: #4c566a;">""" Create an annotation message for impact data</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        impact_data: dict containing impact data in the form of,</span>
<span style="color: #4c566a;">        {</span>
<span style="color: #4c566a;">            'bps': bps,</span>
<span style="color: #4c566a;">            'pps': pps,</span>
<span style="color: #4c566a;">            'impact_boundary (optional)': boundary</span>
<span style="color: #4c566a;">        }</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        String describing alert impact</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Add impact rates to annotation message</span>
    <span style="color: #D8DEE9;">msg</span> = (<span style="color: #A3BE8C;">"Impact in bps: {impact_bps}; "</span> +
           <span style="color: #A3BE8C;">"Impact in pps: {impact_pps};"</span>).<span style="color: #81A1C1;">format</span>(
        impact_bps=impact_data[<span style="color: #A3BE8C;">'bps'</span>],
        impact_pps=impact_data[<span style="color: #A3BE8C;">'pps'</span>])

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">If alert data contains boundary info, include that as well</span>
    <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'boundary'</span> <span style="color: #81A1C1;">in</span> impact_data:
        <span style="color: #D8DEE9;">msg</span> = (<span style="color: #A3BE8C;">"Impact on boundary '{}'; {}"</span>).<span style="color: #81A1C1;">format</span>(
            impact_data[<span style="color: #A3BE8C;">'boundary'</span>],
            msg)

    <span style="color: #81A1C1;">return</span> msg


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">extract_impact_info</span>(alert):
    <span style="color: #4c566a;">""" Extract impact information from an alert</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        alert: alert in dict form that contains impact data</span>

<span style="color: #4c566a;">    Returns:</span>
<span style="color: #4c566a;">        dict containing impact data in the form of,</span>
<span style="color: #4c566a;">        {</span>
<span style="color: #4c566a;">            'bps',</span>
<span style="color: #4c566a;">            'pps',</span>
<span style="color: #4c566a;">            'impact_boundary' (depending on alert)</span>
<span style="color: #4c566a;">        }</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Pull impact information out of alert data</span>
    <span style="color: #D8DEE9;">attributes</span> = alert[<span style="color: #A3BE8C;">'attributes'</span>]
    <span style="color: #D8DEE9;">impact</span> = {
        <span style="color: #A3BE8C;">'bps'</span>: attributes[<span style="color: #A3BE8C;">'subobject'</span>][<span style="color: #A3BE8C;">'impact_bps'</span>],
        <span style="color: #A3BE8C;">'pps'</span>: attributes[<span style="color: #A3BE8C;">'subobject'</span>][<span style="color: #A3BE8C;">'impact_pps'</span>]
    }

    <span style="color: #81A1C1;">if</span> <span style="color: #A3BE8C;">'impact_boundary'</span> <span style="color: #81A1C1;">in</span> attributes[<span style="color: #A3BE8C;">'subobject'</span>]:
        <span style="color: #D8DEE9;">impact</span>[<span style="color: #A3BE8C;">'boundary'</span>] = attributes[<span style="color: #A3BE8C;">'subobject'</span>][<span style="color: #A3BE8C;">'impact_boundary'</span>]

    <span style="color: #81A1C1;">return</span> impact


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">annotate</span>(leader, key, alerts):
    <span style="color: #4c566a;">""" Annotate a series of alerts from a given SP leader</span>

<span style="color: #4c566a;">    Each alert is annotated with its own impact data</span>

<span style="color: #4c566a;">    Args:</span>
<span style="color: #4c566a;">        leader: SP leader from which the alerts originated</span>
<span style="color: #4c566a;">        key: API key generated on the given SP leader</span>
<span style="color: #4c566a;">        alerts: list of impact data containing alerts to be annotated</span>
<span style="color: #4c566a;">    """</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Annotating {} ongoing alerts with impact data"</span>.<span style="color: #81A1C1;">format</span>(
        <span style="color: #81A1C1;">len</span>(alerts)))

    <span style="color: #81A1C1;">for</span> alert <span style="color: #81A1C1;">in</span> alerts:

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create the POST body for each annotation</span>
        <span style="color: #D8DEE9;">impact</span> = extract_impact_info(alert)
        <span style="color: #D8DEE9;">msg</span> = create_annotation_msg(impact)
        <span style="color: #D8DEE9;">post</span> = {
            <span style="color: #A3BE8C;">"data"</span>: {
                <span style="color: #A3BE8C;">"attributes"</span>: {
                    <span style="color: #A3BE8C;">"author"</span>: <span style="color: #A3BE8C;">"API-Client"</span>,
                    <span style="color: #A3BE8C;">"text"</span>: msg
                }
            }
        }

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Create a unique URL for each annotation</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Each one must reference the alert from which impact data</span>
        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">is being retreived</span>
        <span style="color: #D8DEE9;">ALERT_URI</span> = (<span style="color: #A3BE8C;">"/api/sp/alerts/{}/annotations/"</span>).<span style="color: #81A1C1;">format</span>(
            alert[<span style="color: #A3BE8C;">'id'</span>])
        <span style="color: #D8DEE9;">URL</span> = <span style="color: #A3BE8C;">"https://"</span> + leader + ALERT_URI

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">POST annotation</span>
        <span style="color: #D8DEE9;">api_response</span> = api_request(
            URL, key, json.dumps(post))

        <span style="color: #4c566a;"># </span><span style="color: #4c566a;">Handle any API response</span>
        <span style="color: #81A1C1;">if</span> api_response:
            <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Alert {} annotated"</span>.<span style="color: #81A1C1;">format</span>(
                alert[<span style="color: #A3BE8C;">'id'</span>]))
        <span style="color: #81A1C1;">else</span>:
            <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">"Could not annotate Alert {}"</span>.<span style="color: #81A1C1;">format</span>(
                alert[<span style="color: #A3BE8C;">'id'</span>]),
                <span style="color: #81A1C1;">file</span>=sys.stderr)


<span style="color: #4c566a;">#####################</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Start the Program #</span>
<span style="color: #4c566a;">#####################</span>


<span style="color: #81A1C1;">def</span> <span style="color: #88C0D0;">main</span>():
    <span style="color: #D8DEE9;">SP_LEADER</span> = <span style="color: #A3BE8C;">'leader.example.com'</span>
    <span style="color: #D8DEE9;">API_KEY</span> = <span style="color: #A3BE8C;">'okw_TF2PLL20ojZ1ptzazGh6TPS0C2MlqpO3LDzv'</span>

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Starting auto-annotation script'</span>)
    <span style="color: #D8DEE9;">alerts</span> = get_alerts(SP_LEADER, API_KEY)
    <span style="color: #81A1C1;">if</span> alerts:
        <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Alerts retrieved. Auto-annotating impact data'</span>)
        annotate(SP_LEADER, API_KEY, alerts)

    <span style="color: #81A1C1;">print</span>(<span style="color: #A3BE8C;">'Done'</span>)

<span style="color: #81A1C1;">if</span> <span style="color: #81A1C1;">__name__</span> == <span style="color: #A3BE8C;">"__main__"</span>:
    main()
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3afbc0b" class="outline-2">
<h2 id="org3afbc0b"><span class="section-number-2">6</span> Examples in Languages other than Python</h2>
<div class="outline-text-2" id="text-6">
<p>
These examples are intentionally less sophisticated than those
above; they are just intended to demonstrate basic interactions with
the API using languages other than Python.
</p>
</div>

<div id="outline-container-orge1d0610" class="outline-3">
<h3 id="orge1d0610"><span class="section-number-3">6.1</span> Java</h3>
<div class="outline-text-3" id="text-6-1">
<p>
When operating an SP deployment that has many collectors, TMSs,
and is maintained by many network security engineers, it is
convenient to see the system events that SP logs in a concise
format.  System events include configuration changes, system
errors, and other operational details that can help maintain the
stability and availability of your Arbor SP/TMS environment.
</p>

<p>
This example uses a Java program to retrieve the events from an SP
leader that are considered system events, and print those events in
a concise format.
</p>



<p>
Java handles SSL certificate files differently from other languages
(most of which base their HTTP libraries on <code>libcurl</code>, hence their
similarity); the certificate file mentioned in <a href="#org18702f9">2.1.2</a>
needs to be converted to the Java Key Store format.  One way to do
this is to use the <code>keytool</code> command that is part of a standard
Java Development Kit distribution:
</p>
<div class="org-src-container">
<pre class="src src-sh">keytool -import -alias ca -file https_active.crt -keystore cacerts -storepass changeit
</pre>
</div>
<p>
where <code>https_active.crt</code> is the name of the certificate file from
SP and <code>cacerts</code> is the name of the output file that will later be
read by the Java application.
</p>

<p>
This example makes use of the <code>json-simple</code><sup><a id="fnr.7" class="footref" href="#fn.7">7</a></sup> Java library;
after downloading the <code>.jar</code> file for <code>json-simple</code>, and place
it in the same directory as this example.
</p>

<p>
Then set the <code>CLASSPATH</code> environment variable to include the path
to the <code>json-simple</code> JAR file and the current working directory
(denoted by the single period, <code>.</code>) by setting it to
<code>./json-simple-1.1.1.jar:.</code> This way both the Java compiler and
run-time environment can find the libraries included in the
<code>json-simple</code> JAR file and the newly compiled <code>SystemEventClass</code>
program.
</p>

<p>
With <code>CLASSPATH</code> set you can compile <code>SystemEventClass.java</code> with
the command <code>javac -classpath ./json-simple-1.1.1.jar
   SystemEventClient.java</code>.
</p>

<p>
After that, but in the same environment where you have set
<code>CLASSPATH</code> as above, typing <code>java SystemEventClass</code> will run the
Java program and it should result in output that looks like:
</p>
<pre class="example">
+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+
|  ID   | Importance |            Alert            |  User  | Version |        Start_Time         |        End_Time           | Annotations |
+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+
| 55316 | Medium     | System Configuration Update | admin  | 1.121   | 2017-09-21T20:58:27+00:00 | 2017-09-21T20:58:27+00:00 | Example Annotation |
| 55308 | Medium     | System Configuration Update | admin  | 1.120   | 2017-09-21T20:55:55+00:00 | 2017-09-21T20:55:55+00:00 | None        |
| 55307 | Medium     | System Configuration Update | admin  | 1.119   | 2017-09-21T20:55:45+00:00 | 2017-09-21T20:55:45+00:00 | None        |
| 55306 | Medium     | System Configuration Update | admin  | 1.118   | 2017-09-21T20:55:37+00:00 | 2017-09-21T20:55:37+00:00 | None        |
| 55231 | Medium     | System Configuration Update | admin  | 1.117   | 2017-09-21T19:14:48+00:00 | 2017-09-21T19:14:48+00:00 | None        |
| 54669 | Medium     | System Configuration Update | admin  | 1.115   | 2017-09-20T17:28:16+00:00 | 2017-09-20T17:28:16+00:00 | None        |
+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+
</pre>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">io</span>.<span style="color: #8FBCBB;">BufferedReader</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">io</span>.<span style="color: #8FBCBB;">FileInputStream</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">io</span>.<span style="color: #8FBCBB;">InputStream</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">io</span>.<span style="color: #8FBCBB;">InputStreamReader</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">io</span>.<span style="color: #8FBCBB;">IOException</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #8FBCBB;">MalformedURLException</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #8FBCBB;">URL</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">security</span>.<span style="color: #81A1C1;">cert</span>.<span style="color: #8FBCBB;">CertificateException</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">security</span>.<span style="color: #8FBCBB;">KeyStore</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">security</span>.<span style="color: #8FBCBB;">SecureRandom</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">java</span>.<span style="color: #81A1C1;">security</span>.<span style="color: #81A1C1;">cert</span>.<span style="color: #8FBCBB;">X509Certificate</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">javax</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #81A1C1;">ssl</span>.<span style="color: #8FBCBB;">HttpsURLConnection</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">javax</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #81A1C1;">ssl</span>.<span style="color: #8FBCBB;">SSLContext</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">javax</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #81A1C1;">ssl</span>.<span style="color: #8FBCBB;">TrustManager</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">javax</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #81A1C1;">ssl</span>.<span style="color: #8FBCBB;">TrustManagerFactory</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">javax</span>.<span style="color: #81A1C1;">net</span>.<span style="color: #81A1C1;">ssl</span>.<span style="color: #8FBCBB;">X509TrustManager</span>;
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">org</span>.<span style="color: #81A1C1;">json</span>.<span style="color: #81A1C1;">simple</span>.<span style="color: #8FBCBB;">JSONArray</span>;  <span style="color: #4c566a;">// </span><span style="color: #4c566a;">json-simple-1.1.1.jar</span>
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">org</span>.<span style="color: #81A1C1;">json</span>.<span style="color: #81A1C1;">simple</span>.<span style="color: #8FBCBB;">JSONObject</span>;  <span style="color: #4c566a;">// </span><span style="color: #4c566a;">json-simple-1.1.1.jar</span>
<span style="color: #81A1C1;">import</span> <span style="color: #81A1C1;">org</span>.<span style="color: #81A1C1;">json</span>.<span style="color: #81A1C1;">simple</span>.<span style="color: #81A1C1;">parser</span>.<span style="color: #8FBCBB;">JSONParser</span>;  <span style="color: #4c566a;">// </span><span style="color: #4c566a;">json-simple-1.1.1.jar</span>


<span style="color: #81A1C1;">public</span> <span style="color: #81A1C1;">class</span> <span style="color: #8FBCBB;">SystemEventClient</span> {

    <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Format to put data in table format based on how the UI presents the</span>
    <span style="color: #4c566a;">// </span><span style="color: #4c566a;">information</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">alignFormat</span> = <span style="color: #A3BE8C;">"| %-4s | %-10s | %-20s | %-6s | %-7s | %-24s | %-24s | %-11s |%n"</span>;

    <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Key to access the SP Leader</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">token</span> = <span style="color: #A3BE8C;">"bufFhFCg4f01z4iwLtvhtqhhHetVJlwyXdzlJeVl"</span>;

    <span style="color: #4c566a;">/** Get annotation for given alert if it has one. */</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">String</span> <span style="color: #88C0D0;">get_annotation</span>(<span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">obj</span>) <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">Exception</span>{
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">If the given alert has relationships</span>
        <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">relationships</span> = (<span style="color: #8FBCBB;">JSONObject</span>) obj.get(<span style="color: #A3BE8C;">"relationships"</span>);
        <span style="color: #81A1C1;">if</span>(relationships != <span style="color: #81A1C1;">null</span>) {
            <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">annotation_relationship</span> = (
                (<span style="color: #8FBCBB;">JSONObject</span>) relationships.get(<span style="color: #A3BE8C;">"annotations"</span>));

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">If there is a related annotation</span>
            <span style="color: #81A1C1;">if</span>(annotation_relationship != <span style="color: #81A1C1;">null</span>) {
                <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">link</span> = (<span style="color: #8FBCBB;">String</span>) ((<span style="color: #8FBCBB;">JSONObject</span>) (
                    annotation_relationship.get(<span style="color: #A3BE8C;">"links"</span>))).get(<span style="color: #A3BE8C;">"related"</span>);

                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Query the related annotation's link</span>
                <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">response</span> = convert_to_json(request(link));
                <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">temp</span> = (<span style="color: #8FBCBB;">JSONObject</span>) (
                    (<span style="color: #8FBCBB;">JSONArray</span>) response.get(<span style="color: #A3BE8C;">"data"</span>)).get(0);

                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Return the annotation</span>
                <span style="color: #81A1C1;">return</span> (<span style="color: #8FBCBB;">String</span>) ((<span style="color: #8FBCBB;">JSONObject</span>) temp.get(<span style="color: #A3BE8C;">"attributes"</span>)).get(<span style="color: #A3BE8C;">"text"</span>);
            }
        }

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">If there is no annotation return None</span>
        <span style="color: #81A1C1;">return</span> <span style="color: #A3BE8C;">"None"</span>;
    }

    <span style="color: #4c566a;">/** Parse JSON and print it according to how the UI presents it. */</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">print_ui</span>(<span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">json</span>) <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">Exception</span> {
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">For each object in the array of results</span>
        <span style="color: #81A1C1;">for</span> (<span style="color: #8FBCBB;">Object</span> <span style="color: #88C0D0;">raw_json</span> : (<span style="color: #8FBCBB;">JSONArray</span>) json.get(<span style="color: #A3BE8C;">"data"</span>)) {
            <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">obj</span> = (<span style="color: #8FBCBB;">JSONObject</span>) raw_json;
            <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">attributes</span> = (<span style="color: #8FBCBB;">JSONObject</span>) obj.get(<span style="color: #A3BE8C;">"attributes"</span>);

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">If the given alert is a System Event get information</span>
            <span style="color: #81A1C1;">if</span>((attributes.get(<span style="color: #A3BE8C;">"alert_class"</span>)).equals(<span style="color: #A3BE8C;">"system_event"</span>)) {
                <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">stop_time</span> = <span style="color: #A3BE8C;">"Ongoing"</span>;
                <span style="color: #81A1C1;">if</span>(<span style="color: #81A1C1;">!</span>(<span style="color: #8FBCBB;">boolean</span>) attributes.get(<span style="color: #A3BE8C;">"ongoing"</span>)) {
                    stop_time = (<span style="color: #8FBCBB;">String</span>) attributes.get(<span style="color: #A3BE8C;">"stop_time"</span>);
                }

                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Get the subobject for use getting the username and version</span>
                <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">subobject</span> = (
                    (<span style="color: #8FBCBB;">JSONObject</span>) attributes.get(<span style="color: #A3BE8C;">"subobject"</span>));

                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Turn the given integer into a human-readable string for</span>
                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">importance</span>
                <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">human_readable_importance</span>[] = {<span style="color: #A3BE8C;">"Low"</span>, <span style="color: #A3BE8C;">"Medium"</span>, <span style="color: #A3BE8C;">"High"</span>};
                <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">string_importance</span> = human_readable_importance[
                    (<span style="color: #8FBCBB;">int</span>) (<span style="color: #8FBCBB;">long</span>) attributes.get(<span style="color: #A3BE8C;">"importance"</span>)
                ];

                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Format results using alignFormat into table format</span>
                System.out.format(alignFormat,
                    obj.get(<span style="color: #A3BE8C;">"id"</span>),
                    string_importance,
                    <span style="color: #A3BE8C;">"System Configuration Update"</span>,
                    subobject.get(<span style="color: #A3BE8C;">"username"</span>),
                    subobject.get(<span style="color: #A3BE8C;">"version"</span>),
                    attributes.get(<span style="color: #A3BE8C;">"start_time"</span>),
                    stop_time,
                    get_annotation(obj));
            }
        }
    }

    <span style="color: #4c566a;">/** Convert received content from connection to JSONObject. */</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #88C0D0;">convert_to_json</span>(<span style="color: #8FBCBB;">HttpsURLConnection</span> <span style="color: #D8DEE9;">con</span>) <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">Exception</span> {
        <span style="color: #81A1C1;">if</span> (con == <span style="color: #81A1C1;">null</span> || con.getResponseCode() != <span style="color: #81A1C1;">HttpsURLConnection</span>.HTTP_OK) {
            <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">null</span>;
        }

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Get input from connection and parse it into json</span>
        <span style="color: #81A1C1;">try</span> (<span style="color: #8FBCBB;">BufferedReader</span> <span style="color: #D8DEE9;">br</span> = <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">BufferedReader</span>(
                <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">InputStreamReader</span>(con.getInputStream()))) {
            <span style="color: #81A1C1;">final</span> <span style="color: #8FBCBB;">JSONParser</span> <span style="color: #D8DEE9;">parser</span> = <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">JSONParser</span>();
            <span style="color: #81A1C1;">return</span> (<span style="color: #8FBCBB;">JSONObject</span>) parser.parse(br);

        } <span style="color: #81A1C1;">catch</span> (<span style="color: #8FBCBB;">IOException</span> <span style="color: #D8DEE9;">e</span>) {
            e.printStackTrace();
        }
        <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">null</span>;
    }

    <span style="color: #4c566a;">/** Create Empty Trust Manager. */</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #81A1C1;">class</span> <span style="color: #8FBCBB;">DefaultTrustManager</span> <span style="color: #81A1C1;">implements</span> <span style="color: #8FBCBB;">X509TrustManager</span> {
        <span style="color: #D08770;">@Override</span>
        <span style="color: #81A1C1;">public</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">checkClientTrusted</span>(<span style="color: #8FBCBB;">X509Certificate</span>[] <span style="color: #D8DEE9;">arg0</span>, <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">arg1</span>)
            <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">CertificateException</span> {}

        <span style="color: #D08770;">@Override</span>
        <span style="color: #81A1C1;">public</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">checkServerTrusted</span>(<span style="color: #8FBCBB;">X509Certificate</span>[] <span style="color: #D8DEE9;">arg0</span>, <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">arg1</span>)
            <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">CertificateException</span> {}

        <span style="color: #D08770;">@Override</span>
        <span style="color: #81A1C1;">public</span> <span style="color: #8FBCBB;">X509Certificate</span>[] <span style="color: #88C0D0;">getAcceptedIssuers</span>() {
            <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">null</span>;
        }
    }

    <span style="color: #4c566a;">/** Set up Https Connection with given SSL Certificate. */</span>
    <span style="color: #81A1C1;">private</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">HttpsURLConnection</span> <span style="color: #88C0D0;">request</span>(<span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">httpUrl</span>) <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">Exception</span> {
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Pass certificate to connection</span>
        <span style="color: #8FBCBB;">InputStream</span> <span style="color: #D8DEE9;">trustStream</span> = <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">FileInputStream</span>(<span style="color: #A3BE8C;">"./cacerts.jks"</span>);
        <span style="color: #8FBCBB;">char</span>[] <span style="color: #D8DEE9;">password</span> = <span style="color: #81A1C1;">null</span>;
        <span style="color: #8FBCBB;">KeyStore</span> <span style="color: #D8DEE9;">trustStore</span> = KeyStore.getInstance(KeyStore.getDefaultType());
        trustStore.load(trustStream, password);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Set up TrustManager to pass to SSL Context</span>
        <span style="color: #8FBCBB;">TrustManagerFactory</span> <span style="color: #D8DEE9;">trustFactory</span> = TrustManagerFactory.getInstance(
            TrustManagerFactory.getDefaultAlgorithm());
        trustFactory.init(trustStore);
        <span style="color: #8FBCBB;">TrustManager</span>[] <span style="color: #D8DEE9;">trustManagers</span> = { <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">DefaultTrustManager</span>() };

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Set up SSL Context</span>
        <span style="color: #8FBCBB;">SSLContext</span> <span style="color: #D8DEE9;">sslContext</span> = SSLContext.getInstance(<span style="color: #A3BE8C;">"SSL"</span>);
        sslContext.init(<span style="color: #81A1C1;">null</span>, trustManagers, <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">SecureRandom</span>());
        SSLContext.setDefault(sslContext);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Open Connection to given url</span>
        <span style="color: #8FBCBB;">URL</span> <span style="color: #D8DEE9;">url</span>;
        <span style="color: #81A1C1;">try</span> {
            url = <span style="color: #81A1C1;">new</span> <span style="color: #8FBCBB;">URL</span>(httpUrl);
            <span style="color: #8FBCBB;">HttpsURLConnection</span> <span style="color: #D8DEE9;">con</span> = (
                (<span style="color: #8FBCBB;">HttpsURLConnection</span>) url.openConnection());

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Pass API Token and type to accept to the connection</span>
            con.setRequestProperty(<span style="color: #A3BE8C;">"X-Arbux-APIToken"</span>, token);
            con.setRequestProperty(<span style="color: #A3BE8C;">"Accept"</span>, <span style="color: #A3BE8C;">"application/json"</span>);

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Return connection</span>
            <span style="color: #81A1C1;">return</span> con;

        } <span style="color: #81A1C1;">catch</span> (<span style="color: #8FBCBB;">MalformedURLException</span> <span style="color: #D8DEE9;">e</span>) {
            e.printStackTrace();
        } <span style="color: #81A1C1;">catch</span> (<span style="color: #8FBCBB;">IOException</span> <span style="color: #D8DEE9;">e</span>) {
            e.printStackTrace();
        }
        <span style="color: #81A1C1;">return</span> <span style="color: #81A1C1;">null</span>;
    }

    <span style="color: #4c566a;">/** Main: Trigger request for every page. */</span>
    <span style="color: #81A1C1;">public</span> <span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">main</span>(<span style="color: #8FBCBB;">String</span>[] <span style="color: #D8DEE9;">args</span>) <span style="color: #81A1C1;">throws</span> <span style="color: #8FBCBB;">Exception</span> {
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Url to hit</span>
        <span style="color: #8FBCBB;">String</span> <span style="color: #D8DEE9;">httpUrl</span> = <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/alerts/"</span>;

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Print table headers</span>
        System.out.format(<span style="color: #A3BE8C;">"+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+%n"</span>);
        System.out.format(<span style="color: #A3BE8C;">"|  ID   | Importance |            Alert            |  User  | Version |        Start_Time         |        End_Time           | Annotations |%n"</span>);
        System.out.format(<span style="color: #A3BE8C;">"+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+%n"</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Loop through all pages of data</span>
        <span style="color: #8FBCBB;">HttpsURLConnection</span> <span style="color: #D8DEE9;">connection</span>;
        <span style="color: #8FBCBB;">JSONObject</span> <span style="color: #D8DEE9;">json</span>;
        <span style="color: #81A1C1;">while</span> (httpUrl !=  <span style="color: #81A1C1;">null</span>) {
            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Make the query to the API with the given url</span>
            connection = request(httpUrl);

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Convert the response from the API into json</span>
            json = convert_to_json(connection);

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">If there are no results break out of loop</span>
            <span style="color: #81A1C1;">if</span> (json == <span style="color: #81A1C1;">null</span>) {
                <span style="color: #81A1C1;">break</span>;
            }

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Print the results formatted in table format</span>
            print_ui(json);

            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Get `next` link if there is one in the pagination links (there</span>
            <span style="color: #4c566a;">// </span><span style="color: #4c566a;">are more results)</span>
            httpUrl = (<span style="color: #8FBCBB;">String</span>) ((<span style="color: #8FBCBB;">JSONObject</span>) json.get(<span style="color: #A3BE8C;">"links"</span>)).get(<span style="color: #A3BE8C;">"next"</span>);
        }

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Print bottom of table</span>
        System.out.format(<span style="color: #A3BE8C;">"+-------+------------+-----------------------------+--------+---------+---------------------------+---------------------------+-------------+%n"</span>);
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org810dbea" class="outline-3">
<h3 id="org810dbea"><span class="section-number-3">6.2</span> bash</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Using the SP REST API can be done from a <code>sh</code> shell script and some
command line tools.
</p>

<p>
This example uses <code>curl</code> and <code>jq</code> (see the section titled <a href="#orgbb2e57b">2.2</a> for more information on those tools) to get a list of alerts
from SP and print them in either JSON, tab-separated values, or
comma-separate values.
</p>

<p>
This example makes an API request to get the alerts for the last 24
hours, then uses <code>jq</code> to extract and re-render that information for
printing to the screen.
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #4c566a;">#</span><span style="color: #4c566a;">!/usr/bin/</span><span style="color: #81A1C1;">env</span><span style="color: #4c566a;"> bash</span>
<span style="color: #4c566a;">#</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Grabs ongoing SP alerts from the last day and outputs in json form.</span>
<span style="color: #4c566a;">#</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Options:</span>
<span style="color: #4c566a;">#   </span><span style="color: #4c566a;">-t: Output alerts in tsv form</span>
<span style="color: #4c566a;">#   </span><span style="color: #4c566a;">-c: Output alerts in csv form</span>
<span style="color: #4c566a;">#</span>

<span style="color: #4c566a;"># </span><span style="color: #4c566a;">current ISO date - 24 hours</span>
<span style="color: #D8DEE9;">DATE</span>=<span style="color: #fa8072;">`date -v-1d +%Y-%m-%dT%H:%M:%S%z`</span>

<span style="color: #D8DEE9;">LEADER</span>=<span style="color: #A3BE8C;">"leader.example.com"</span>
<span style="color: #D8DEE9;">TOKEN</span>=<span style="color: #A3BE8C;">"i9fESeDtZTnBRI_ruE76K_Zg2FdJRvtwapxkN1_t"</span>
<span style="color: #D8DEE9;">CERTFILE</span>=<span style="color: #A3BE8C;">"../certfile"</span>
<span style="color: #D8DEE9;">QUERY_PARAMS</span>=<span style="color: #A3BE8C;">"?filter=%2Fdata%2Fattributes%2Fongoing%3Dtrue+AND+%2Fdata%2Fattributes%2Fstart_time%3E$DATE"</span>


<span style="color: #4c566a;"># </span><span style="color: #4c566a;">query SP for ongoing alerts from the past 24 hours and filter down to type,</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">start time, and description.</span>
<span style="color: #D8DEE9;">JSON</span>=$(
        curl --cacert $<span style="color: #D8DEE9;">CERTFILE</span> --ssl --silent -X GET <span style="color: #A3BE8C;">\</span>
                https://$<span style="color: #D8DEE9;">LEADER</span>/api/sp/alerts/$<span style="color: #D8DEE9;">QUERY_PARAMS</span> <span style="color: #A3BE8C;">\</span>
                -H <span style="color: #A3BE8C;">"Content-Type: application/vnd.api+json"</span> <span style="color: #A3BE8C;">\</span>
                -H <span style="color: #A3BE8C;">"x-arbux-apitoken: $TOKEN"</span> <span style="color: #A3BE8C;">\</span>
        | jq <span style="color: #A3BE8C;">"[.data[]?.attributes | {\</span>
<span style="color: #A3BE8C;">                                        alert_type: .alert_type,\</span>
<span style="color: #A3BE8C;">                                        start_time: .start_time,\</span>
<span style="color: #A3BE8C;">                                        description: .subobject.description\</span>
<span style="color: #A3BE8C;">                                }]"</span>
)


<span style="color: #4c566a;"># </span><span style="color: #4c566a;">gets a delimeter separated value form of the API return.</span>
<span style="color: #4c566a;">#</span>
<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Arguments:</span>
<span style="color: #4c566a;">#   </span><span style="color: #4c566a;">$1: The original JSON response</span>
<span style="color: #4c566a;">#   </span><span style="color: #4c566a;">$2: 'c' or 't', for comma or tab delimeted values</span>
<span style="color: #88C0D0;">get_dsv</span> () {
  <span style="color: #81A1C1;">echo</span> $<span style="color: #D8DEE9;">1</span> | jq -r <span style="color: #A3BE8C;">"\</span>
<span style="color: #A3BE8C;">    [\"type\", \"start\", \"description\"], \</span>
<span style="color: #A3BE8C;">    (.[] | [.alert_type, .start_time, .description]) \</span>
<span style="color: #A3BE8C;">    | @${2}sv"</span>
}


<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Gather options passed in command line</span>
<span style="color: #81A1C1;">while </span><span style="color: #81A1C1;">getopts</span> <span style="color: #A3BE8C;">":tc"</span> opt; <span style="color: #81A1C1;">do</span>
        <span style="color: #81A1C1;">case</span> $<span style="color: #D8DEE9;">opt</span><span style="color: #81A1C1;"> in</span>
                [tc])
                        get_dsv <span style="color: #A3BE8C;">"$JSON"</span> $<span style="color: #D8DEE9;">opt</span>
                        <span style="color: #81A1C1;">exit</span> 0
                        ;;
                <span style="color: #A3BE8C;">\?</span>)
                        <span style="color: #81A1C1;">echo</span> <span style="color: #A3BE8C;">"Invalid option: -$OPTARG"</span> &gt;&amp;2
                        <span style="color: #81A1C1;">exit</span> 2
                        ;;
        <span style="color: #81A1C1;">esac</span>
<span style="color: #81A1C1;">done</span>


<span style="color: #4c566a;"># </span><span style="color: #4c566a;">Simply return JSON if no options have been passed</span>
<span style="color: #81A1C1;">echo</span> <span style="color: #A3BE8C;">"$JSON"</span>
</pre>
</div>

<p>
Running that script with the <code>-t</code> option produces output that looks
like:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span style="color: #81A1C1;">type</span>    start   description
tms_fault       2017-09-22T16:26:26+00:00       Hardware Sensor <span style="color: #A3BE8C;">'Power Draw (PS2)'</span> is <span style="color: #A3BE8C;">'Critical'</span> (Triggering value: 0 Watts)
tms_fault       2017-09-22T16:25:26+00:00       Hardware Device <span style="color: #A3BE8C;">'Power Supply PS2'</span> is <span style="color: #A3BE8C;">'Error'</span> (Presence detected, Power Supply AC lost)
collector_down  2017-09-21T19:39:21+00:00
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf3b2f9c" class="outline-3">
<h3 id="orgf3b2f9c"><span class="section-number-3">6.3</span> PHP</h3>
<div class="outline-text-3" id="text-6-3">
<p>
A common programming language for web-based applications is PHP.
This example uses PHP to list port names and types, and TMS names,
models, and deployment types for all of the TMSs in your
deployment.
</p>

<p>
The steps to do this are:
</p>
<ul class="org-ul">
<li>query the <code>tms_ports</code> endpoint</li>
<li>for each object in the returned array, print the information
about that TMS port</li>
</ul>

<p>
When this PHP program is run, it produces output that looks like:
</p>
<div class="org-src-container">
<pre class="src src-sh">| Port Name | Port Type | TMS                   | TMS Model | TMS Deployment Type |
| tms0      | physical  | tms002                | TMS-2500  |                     |
| tms1      | physical  | tms002                | TMS-2500  |                     |
| tms2      | physical  | tms002                | TMS-2500  |                     |
| tms3      | physical  | tms002                | TMS-2500  |                     |
| tms4      | physical  | tms002                | TMS-2500  |                     |
| tms5      | physical  | tms002                | TMS-2500  |                     |
| tmsx0.0   | physical  | tms001                | TMS-3100  | inline              |
| tmsx0.1   | physical  | tms001                | TMS-3100  | inline              |
</pre>
</div>

<div class="org-src-container">
<pre class="src src-php"><span style="color: #5E81AC; font-weight: bold;">&lt;?php</span>

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * Make an API request GET or POST (default method GET).</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * @param[in] $url a URL including an SP leader and SP resource</span>
<span style="color: #4c566a;"> * @param[in] $key an api key used to access the SP api</span>
<span style="color: #4c566a;"> * @param[in] $body json post data if any</span>
<span style="color: #4c566a;"> * @param[in] $method HTTP method is GET by default</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * @return json decoded response</span>
<span style="color: #4c566a;"> </span><span style="color: #4c566a;">*/</span>
<span style="color: #81A1C1;">function</span> <span style="color: #88C0D0;">makeRequest</span>($<span style="color: #D8DEE9;">url</span>, $<span style="color: #D8DEE9;">key</span>, $<span style="color: #D8DEE9;">body</span> = <span style="color: #81A1C1;">false</span>, $<span style="color: #D8DEE9;">method</span> = <span style="color: #A3BE8C;">"GET"</span>) {
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Initialize curl handle</span>
        $<span style="color: #D8DEE9;">curl</span> = <span style="color: #D8DEE9; background-color: #2E3440;">curl_init(</span>$<span style="color: #D8DEE9;">url</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Set HTTP headers</span>
        $<span style="color: #D8DEE9;">headers</span> = [
                <span style="color: #A3BE8C;">"X-Arbux-APIToken: "</span> . $<span style="color: #D8DEE9;">key</span>,
                <span style="color: #A3BE8C;">"Content-Type: application/vnd.api+json"</span>
        ];
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_HTTPHEADER</span>, $<span style="color: #D8DEE9;">headers</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Set request type (GET/POST)</span>
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_CUSTOMREQUEST</span>, $<span style="color: #D8DEE9;">method</span>);
        <span style="color: #81A1C1;">if</span> ($<span style="color: #D8DEE9;">body</span>) {
                <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_POSTFIELD</span>);
        }
        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">return result instead of outputting it.</span>
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_RETURNTRANSFER</span>, <span style="color: #81A1C1;">TRUE</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">use arbor cert</span>
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_SSL_VERIFYPEER</span>, <span style="color: #81A1C1;">TRUE</span>);
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_SSL_VERIFYHOST</span>, <span style="color: #D8DEE9; background-color: #2E3440;">2</span>);
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_setopt(</span>$<span style="color: #D8DEE9;">curl</span>, <span style="color: #EBCB8B;">CURLOPT_CAPATH</span>, <span style="color: #D8DEE9; background-color: #2E3440;">getcwd(</span>) . <span style="color: #A3BE8C;">"/https_active.crt"</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Grab result and close cURL session</span>
        $<span style="color: #D8DEE9;">result</span> = <span style="color: #D8DEE9; background-color: #2E3440;">curl_exec(</span>$<span style="color: #D8DEE9;">curl</span>);
        <span style="color: #D8DEE9; background-color: #2E3440;">curl_close(</span>$<span style="color: #D8DEE9;">curl</span>);

        <span style="color: #81A1C1;">return</span> <span style="color: #D8DEE9; background-color: #2E3440;">json_decode(</span>$<span style="color: #D8DEE9;">result</span>, <span style="color: #81A1C1;">TRUE</span>);
}

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * Print a table of information about TMS ports</span>
<span style="color: #4c566a;"> </span><span style="color: #4c566a;">*/</span>
<span style="color: #81A1C1;">function</span> <span style="color: #88C0D0;">listTmsPortsInfo</span>() {
        $<span style="color: #D8DEE9;">api_key</span> = <span style="color: #A3BE8C;">'JskW5QLVUMkNn4ruVwXOM0hQdyXCtOwnpkOjOev4'</span>;
        $<span style="color: #D8DEE9;">sp_leader</span> = <span style="color: #A3BE8C;">'https://leader.example.com/api/sp/tms_ports/'</span>;
        $<span style="color: #D8DEE9;">json</span> = <span style="color: #D8DEE9; background-color: #2E3440;">makeRequest(</span>$<span style="color: #D8DEE9;">sp_leader</span>, $<span style="color: #D8DEE9;">api_key</span>);

        <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Grab data from response and print table</span>
        $<span style="color: #D8DEE9;">table_format</span> = <span style="color: #A3BE8C;">"|%-10s |%-10.50s | %-25s | %-10s | %-20s |\n"</span>;
        <span style="color: #D8DEE9; background-color: #2E3440;">printf(</span>
                $<span style="color: #D8DEE9;">table_format</span>,
                <span style="color: #A3BE8C;">'Port Name'</span>,
                <span style="color: #A3BE8C;">'Port Type'</span>,
                <span style="color: #A3BE8C;">'TMS'</span>,
                <span style="color: #A3BE8C;">'TMS Model'</span>,
                <span style="color: #A3BE8C;">'TMS Deployment Type'</span>
        );

        <span style="color: #81A1C1;">foreach</span> ($<span style="color: #D8DEE9;">json</span>[<span style="color: #A3BE8C;">'data'</span>] <span style="color: #81A1C1;">as</span> $<span style="color: #D8DEE9;">tms_port</span>) {
                $<span style="color: #D8DEE9;">port_attributes</span> = $<span style="color: #D8DEE9;">tms_port</span>[<span style="color: #A3BE8C;">'attributes'</span>];
                $<span style="color: #D8DEE9;">port_name</span> = $<span style="color: #D8DEE9;">port_attributes</span>[<span style="color: #A3BE8C;">'name'</span>];
                $<span style="color: #D8DEE9;">port_type</span> = $<span style="color: #D8DEE9;">port_attributes</span>[<span style="color: #A3BE8C;">'port_type'</span>];
                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Use relationship link to get more information about the related TMS</span>
                $<span style="color: #D8DEE9;">tms_link</span> = $<span style="color: #D8DEE9;">tms_port</span>[<span style="color: #A3BE8C;">'relationships'</span>][<span style="color: #A3BE8C;">'tms'</span>][<span style="color: #A3BE8C;">'links'</span>][<span style="color: #A3BE8C;">'related'</span>];
                $<span style="color: #D8DEE9;">tms_json</span> = <span style="color: #D8DEE9; background-color: #2E3440;">makeRequest(</span>$<span style="color: #D8DEE9;">tms_link</span>, $<span style="color: #D8DEE9;">api_key</span>);
                $<span style="color: #D8DEE9;">tms_attributes</span> = $<span style="color: #D8DEE9;">tms_json</span>[<span style="color: #A3BE8C;">'data'</span>][<span style="color: #A3BE8C;">'attributes'</span>];
                $<span style="color: #D8DEE9;">tms_name</span> = $<span style="color: #D8DEE9;">tms_attributes</span>[<span style="color: #A3BE8C;">'name'</span>];
                $<span style="color: #D8DEE9;">tms_full_model</span> = $<span style="color: #D8DEE9;">tms_attributes</span>[<span style="color: #A3BE8C;">'full_model'</span>];
                $<span style="color: #D8DEE9;">tms_deployment_type</span> = $<span style="color: #D8DEE9;">tms_attributes</span>[<span style="color: #A3BE8C;">'deployment_type'</span>];
                <span style="color: #4c566a;">// </span><span style="color: #4c566a;">Print data table</span>
                <span style="color: #D8DEE9; background-color: #2E3440;">printf(</span>
                        $<span style="color: #D8DEE9;">table_format</span>,
                        $<span style="color: #D8DEE9;">port_name</span>,
                        $<span style="color: #D8DEE9;">port_type</span>,
                        $<span style="color: #D8DEE9;">tms_name</span>,
                        $<span style="color: #D8DEE9;">tms_full_model</span>,
                        $<span style="color: #D8DEE9;">tms_deployment_type</span>
                );
        }
}

<span style="color: #D8DEE9; background-color: #2E3440;">listTmsPortsInfo(</span>);
<span style="color: #5E81AC; font-weight: bold;">?&gt;</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfe0b57a" class="outline-3">
<h3 id="orgfe0b57a"><span class="section-number-3">6.4</span> C</h3>
<div class="outline-text-3" id="text-6-4">
<p>
Most of the software in the world is written in the C programming
language, so an API client for the SP REST API should be no
exception.
</p>

<p>
The example client below uses two libraries to make things easier:
</p>
<ul class="org-ul">
<li>the cURL library to make the HTTPS request to the SP REST API
and retrieve the results; see <a href="https://curl.haxx.se/">https://curl.haxx.se/</a> for more
details</li>
<li>the Jansson library for processing JSON data returned by the SP
REST API; see <a href="http://www.digip.org/jansson/">http://www.digip.org/jansson/</a> for more details</li>
</ul>

<p>
This example retrieves all of the managed objects from the SP REST
API in groups of 10 at a time (note the <code>perPage=10</code> part of the
URL) and prints out a table of a few of the attributes.
</p>

<p>
The output looks like:
</p>
<pre class="example">
|                     Name  | Child? |     Match Type  |                     Match Values  |
--------------------------------------------------------------------------------------------
|                  VPNSite1 |    Yes |     cidr_blocks |      192.168.1.0/24 172.16.1.0/24 |
|                  VPNSite2 |    Yes |     cidr_blocks |      192.168.2.0/24 172.16.2.0/24 |
|                  VPNSite3 |    Yes |     cidr_blocks |      192.168.3.0/24 172.16.3.0/24 |
|                  VPNSite4 |    Yes |     cidr_blocks |      192.168.4.0/24 172.16.4.0/24 |
|                      MPLS |        |     cidr_blocks |                       10.0.0.0/24 |
|                custMisuse |        |     cidr_blocks |                  192.168.137.0/28 |
|                 peer14989 |        |         peer_as |                             14989 |
|                 peer11420 |        |         peer_as |                             11420 |
|                 peer14041 |        |         peer_as |                             14041 |
|                     test2 |        |     cidr_blocks |                     10.11.12.0/24 |
|                     test3 |        |     cidr_blocks |                   192.168.2.71/32 |
|                     test4 |        |     cidr_blocks |                     10.11.13.0/24 |
|                  Internet |        |          (null) |                            (null) |
|           All Subscribers |        |          (null) |                            (null) |
--------------------------------------------------------------------------------------------
                                                            SP REST API version: SP8.3/APIv3
</pre>
<div class="org-src-container">
<pre class="src src-c"><span style="color: #5E81AC; font-weight: bold;">#include</span> <span style="color: #A3BE8C;">&lt;curl/curl.h&gt;</span>
<span style="color: #5E81AC; font-weight: bold;">#include</span> <span style="color: #A3BE8C;">&lt;jansson.h&gt;</span>
<span style="color: #5E81AC; font-weight: bold;">#include</span> <span style="color: #A3BE8C;">&lt;stdio.h&gt;</span>
<span style="color: #5E81AC; font-weight: bold;">#include</span> <span style="color: #A3BE8C;">&lt;string.h&gt;</span>

<span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;"> * Retrieve information on managed objects using the SP REST API and</span>
<span style="color: #4c566a;"> * print a table of some of the fields</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * This program requires two libraries:</span>
<span style="color: #4c566a;"> *  - jansson from http://www.digip.org/jansson/</span>
<span style="color: #4c566a;"> *  - libcurl from https://curl.haxx.se/</span>
<span style="color: #4c566a;"> *  - compile about like:</span>
<span style="color: #4c566a;"> *    gcc -I ... -L ... mo-listing.c -l jansson -l curl -o molisting</span>
<span style="color: #4c566a;"> *    replacing "..." with the include and library paths for your</span>
<span style="color: #4c566a;"> *    system</span>
<span style="color: #4c566a;"> </span><span style="color: #4c566a;">*/</span>

<span style="color: #5E81AC; font-weight: bold;">#define</span> <span style="color: #D8DEE9;">REPORT_WIDTH</span> 92
<span style="color: #5E81AC; font-weight: bold;">#define</span> <span style="color: #D8DEE9;">IS_CHILD_STRLEN</span> 4

<span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> {
  <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">memory</span>;
  <span style="color: #8FBCBB;">size_t</span> <span style="color: #D8DEE9;">size</span>;
};

<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">json_t</span> *<span style="color: #88C0D0;">load_json</span>(<span style="color: #8FBCBB;">char</span> *);
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">print_mo_list</span>(<span style="color: #8FBCBB;">json_t</span> *);
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">do_curl</span>(<span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> *,
                    <span style="color: #81A1C1;">const</span> <span style="color: #8FBCBB;">char</span> *,
                    <span style="color: #8FBCBB;">char</span> *);
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">size_t</span> <span style="color: #88C0D0;">storeCurlData</span>(<span style="color: #8FBCBB;">void</span> *, <span style="color: #8FBCBB;">size_t</span>,
                            <span style="color: #8FBCBB;">size_t</span>, <span style="color: #8FBCBB;">void</span> *);
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">extract_and_print</span>(<span style="color: #8FBCBB;">json_t</span> *);
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">format_mo</span>(<span style="color: #8FBCBB;">json_t</span> *, <span style="color: #8FBCBB;">char</span> *,
                      <span style="color: #8FBCBB;">json_t</span> *, <span style="color: #8FBCBB;">json_t</span> *);

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * take a Jansson JSON data structure and print it out</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] json_t *root; the root of the Jansson data</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> */</span>
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">print_mo_list</span>(<span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">root</span>) {
  <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">data</span>;
  <span style="color: #8FBCBB;">size_t</span> <span style="color: #D8DEE9;">array_index</span>;
  <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">array_value</span>;

  <span style="color: #81A1C1;">if</span> (root == <span style="color: #81A1C1;">NULL</span>) {
    fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] No JSON data processed.\n"</span>);
    <span style="color: #81A1C1;">return</span>;
  }
  data = json_object_get(root, <span style="color: #A3BE8C;">"data"</span>);
  <span style="color: #81A1C1;">if</span> (data == <span style="color: #81A1C1;">NULL</span>) {
    fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] No 'data' element in JSON from API\n"</span>);
    <span style="color: #81A1C1;">return</span>;
  }

  <span style="color: #81A1C1;">if</span> (json_typeof(data) == JSON_OBJECT) {
    extract_and_print(data);
  } <span style="color: #81A1C1;">else</span> <span style="color: #81A1C1;">if</span> (json_typeof(data) == JSON_ARRAY) {
    <span style="color: #88C0D0;">json_array_foreach</span>(data, array_index, array_value) {
      extract_and_print(array_value);
    }
  }
  <span style="color: #81A1C1;">return</span>;
}

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * Pick out the parts of the managed object JSON structure that we</span>
<span style="color: #4c566a;"> * want and send them to the printing function.</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] json_t *mo; a JSON object from the SP REST API</span>
<span style="color: #4c566a;"> *                        representing a SP managed object</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> */</span>
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">extract_and_print</span>(<span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">mo</span>) {
  <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">name</span>, *<span style="color: #D8DEE9;">parent_name</span>, *<span style="color: #D8DEE9;">match_type</span>, *<span style="color: #D8DEE9;">match_value</span>, *<span style="color: #D8DEE9;">attributes</span>;
  <span style="color: #8FBCBB;">char</span> <span style="color: #D8DEE9;">is_child</span>[10];

  attributes = json_object_get(mo, <span style="color: #A3BE8C;">"attributes"</span>);
  <span style="color: #81A1C1;">if</span> (attributes != <span style="color: #81A1C1;">NULL</span> &amp;&amp; json_typeof(attributes) == JSON_OBJECT) {
    name = json_object_get(attributes, <span style="color: #A3BE8C;">"name"</span>);
    parent_name = json_object_get(attributes, <span style="color: #A3BE8C;">"parent_name"</span>);
    <span style="color: #81A1C1;">if</span> (parent_name != <span style="color: #81A1C1;">NULL</span>) {
      strlcpy(is_child, <span style="color: #A3BE8C;">"Yes"</span>, IS_CHILD_STRLEN);
    } <span style="color: #81A1C1;">else</span> {
      strlcpy(is_child, <span style="color: #A3BE8C;">""</span>, IS_CHILD_STRLEN);
    }
    match_type = json_object_get(attributes, <span style="color: #A3BE8C;">"match_type"</span>);
    match_value = json_object_get(attributes, <span style="color: #A3BE8C;">"match"</span>);

    format_mo(name, is_child, match_type, match_value);
  }
}

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * Print the name, child status, match type, and match value of a</span>
<span style="color: #4c566a;"> * managed object in a formatted way.</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] json_t *name; a Jansson json_t with the name of the MO</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] char *is_chile; a string that is "Child" or ""</span>
<span style="color: #4c566a;"> * representing whether or not the MO is a child MO</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] json_t *match_type; a Jansson json_t with the match</span>
<span style="color: #4c566a;"> * type setting for the MO</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] json_t *match_value; a Jansson json_t with the match</span>
<span style="color: #4c566a;"> * value for the MO</span>
<span style="color: #4c566a;"> */</span>
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">format_mo</span>(<span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">name</span>, <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">is_child</span>, <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">match_type</span>,
               <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">match_value</span>) {
  printf(<span style="color: #A3BE8C;">"| %25.25s | "</span>, json_string_value(name));
  printf(<span style="color: #A3BE8C;">"%6.6s | "</span>, is_child);
  printf(<span style="color: #A3BE8C;">"%15.15s | "</span>, json_string_value(match_type));
  printf(<span style="color: #A3BE8C;">"%33.33s | "</span>, json_string_value(match_value));
  printf(<span style="color: #A3BE8C;">"\n"</span>);
}

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * The callback function for storing data retrieved via</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">curl_easy_perform()</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * this is pretty much taken exactly from</span>
<span style="color: #4c566a;"> * https://curl.haxx.se/libcurl/c/getinmemory.html, as suggested by</span>
<span style="color: #4c566a;"> * the man pages for these two `CURLOPT_` parameters</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] void *content; a pointer to the cURL data structure</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] size_t size; size information of the retrieved data</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] size_t nmemb; size information of the retrieved data</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] void *userp; what the cURL docs say to have</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[out] size_t realsize; the size of the data successfully</span>
<span style="color: #4c566a;"> * stored</span>
<span style="color: #4c566a;"> */</span>
<span style="color: #81A1C1;">static</span> <span style="color: #8FBCBB;">size_t</span> <span style="color: #88C0D0;">storeCurlData</span>(<span style="color: #8FBCBB;">void</span> *<span style="color: #D8DEE9;">contents</span>, <span style="color: #8FBCBB;">size_t</span> <span style="color: #D8DEE9;">size</span>, <span style="color: #8FBCBB;">size_t</span> <span style="color: #D8DEE9;">nmemb</span>, <span style="color: #8FBCBB;">void</span> *<span style="color: #D8DEE9;">userp</span>) {
  <span style="color: #8FBCBB;">size_t</span> <span style="color: #D8DEE9;">realsize</span> = size * nmemb;
  <span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> *<span style="color: #D8DEE9;">mem</span> = (<span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> *)userp;

  <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Make space in our char struct element for the new contents. </span><span style="color: #4c566a;">*/</span>
  mem-&gt;memory = realloc(mem-&gt;memory, mem-&gt;size + realsize + 1);
  <span style="color: #81A1C1;">if</span> (mem-&gt;memory == <span style="color: #81A1C1;">NULL</span>) {
    fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] Not enough memory to store data "</span>
            <span style="color: #A3BE8C;">"from cURL (realloc returned NULL)\n"</span>);
    <span style="color: #81A1C1;">return</span> 0;
  }

  <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">   *  Put the data in `contents` into our char struct element to save</span>
<span style="color: #4c566a;">   * it for later, and update the size of the overall struct</span>
<span style="color: #4c566a;">   </span><span style="color: #4c566a;">*/</span>
  memcpy(&amp;(mem-&gt;memory[mem-&gt;size]), contents, realsize);
  mem-&gt;size += realsize;
  mem-&gt;memory[mem-&gt;size] = 0;

  <span style="color: #81A1C1;">return</span> realsize;
}

<span style="color: #4c566a;">/**</span>
<span style="color: #4c566a;"> * Make the HTTP request to the API endpoint.</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] curlMemoryStruct *chunk; the cURL memory for the</span>
<span style="color: #4c566a;"> * results</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] const char *url; the URL to retrieve</span>
<span style="color: #4c566a;"> * </span><span style="color: #81A1C1;">@param</span><span style="color: #4c566a;">[in] char *api_key; the API key string, including the</span>
<span style="color: #4c566a;"> * "X-Arbux-Token" component</span>
<span style="color: #4c566a;"> *</span>
<span style="color: #4c566a;"> */</span>
<span style="color: #8FBCBB;">void</span> <span style="color: #88C0D0;">do_curl</span>(<span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> *<span style="color: #D8DEE9;">chunk</span>, <span style="color: #81A1C1;">const</span> <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">url</span>, <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">api_key</span>) {
  <span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curl_slist</span> *<span style="color: #D8DEE9;">list</span> = <span style="color: #81A1C1;">NULL</span>;
  <span style="color: #8FBCBB;">CURLcode</span> <span style="color: #D8DEE9;">results</span>;
  <span style="color: #8FBCBB;">CURL</span> *<span style="color: #D8DEE9;">curl</span>;

  curl = curl_easy_init();

  <span style="color: #81A1C1;">if</span> (curl) {
    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Set the URL we want to retrieve. </span><span style="color: #4c566a;">*/</span>
    curl_easy_setopt(curl, CURLOPT_URL, url);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Add to the list that we'll use as headers. </span><span style="color: #4c566a;">*/</span>
    list = curl_slist_append(list, api_key);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Set the headers to be the things in the list we made. </span><span style="color: #4c566a;">*/</span>
    curl_easy_setopt(curl, CURLOPT_HTTPHEADER, list);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Point to an Arbor certificate file </span><span style="color: #4c566a;">*/</span>
    curl_easy_setopt(curl, CURLOPT_CAINFO,
                     <span style="color: #A3BE8C;">"./certfile"</span>);

    <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">     * Set the callback function and the data structure for the data,</span>
<span style="color: #4c566a;">     * this is pretty much taken exactly from</span>
<span style="color: #4c566a;">     * https://curl.haxx.se/libcurl/c/getinmemory.html, as suggested</span>
<span style="color: #4c566a;">     * by the man pages for these two `CURLOPT_` parameters</span>
<span style="color: #4c566a;">     </span><span style="color: #4c566a;">*/</span>
    curl_easy_setopt(curl, CURLOPT_WRITEFUNCTION, storeCurlData);
    curl_easy_setopt(curl, CURLOPT_WRITEDATA, (<span style="color: #8FBCBB;">void</span> *)chunk);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Do the HTTP GET. </span><span style="color: #4c566a;">*/</span>
    results = curl_easy_perform(curl);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Clean everything up. </span><span style="color: #4c566a;">*/</span>
    curl_slist_free_all(list);
    curl_easy_cleanup(curl);

    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">Print the curl return code integer if there is an error. </span><span style="color: #4c566a;">*/</span>
    <span style="color: #81A1C1;">if</span> (results != CURLE_OK) {
      fprintf(stderr,
              <span style="color: #A3BE8C;">"\n[ERROR] cURL return status: `%s' (%d)\n"</span>,
              curl_easy_strerror(results),
              results);
    }
  }

  <span style="color: #81A1C1;">return</span>;
}

<span style="color: #8FBCBB;">int</span> <span style="color: #88C0D0;">main</span>() {
  <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">rootOfJsonTree</span>, *<span style="color: #D8DEE9;">links</span>;
  <span style="color: #8FBCBB;">json_error_t</span> <span style="color: #D8DEE9;">error</span>;
  <span style="color: #81A1C1;">const</span> <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">url</span> =
      <span style="color: #A3BE8C;">"https://leader.example.com/api/sp/managed_objects/?perPage=15"</span>;
  <span style="color: #8FBCBB;">char</span> *<span style="color: #D8DEE9;">apikey</span> = <span style="color: #A3BE8C;">"X-Arbux-APIToken:eFvokphdyGHA_M4oLlLtfDnlIf9bpjFnn0mWlDqw"</span>;
  <span style="color: #81A1C1;">struct</span> <span style="color: #8FBCBB;">curlMemoryStruct</span> <span style="color: #D8DEE9;">dataFromCurl</span>;
  <span style="color: #8FBCBB;">json_t</span> *<span style="color: #D8DEE9;">meta</span>, *<span style="color: #D8DEE9;">api_version</span>, *<span style="color: #D8DEE9;">sp_version</span>;

  printf(<span style="color: #A3BE8C;">"| %25.25s | "</span>, <span style="color: #A3BE8C;">" Name "</span>);
  printf(<span style="color: #A3BE8C;">"%6.6s | "</span>, <span style="color: #A3BE8C;">"Child?"</span>);
  printf(<span style="color: #A3BE8C;">"%15.15s | "</span>, <span style="color: #A3BE8C;">" Match Type "</span>);
  printf(<span style="color: #A3BE8C;">"%33.33s | "</span>, <span style="color: #A3BE8C;">" Match Values "</span>);
  printf(<span style="color: #A3BE8C;">"\n"</span>);
  <span style="color: #81A1C1;">for</span> (<span style="color: #8FBCBB;">int</span> <span style="color: #D8DEE9;">i</span> = 0; i &lt; REPORT_WIDTH; i++) {
    printf(<span style="color: #A3BE8C;">"-"</span>);
  }
  printf(<span style="color: #A3BE8C;">"\n"</span>);

  <span style="color: #81A1C1;">while</span> (url != <span style="color: #81A1C1;">NULL</span>) {

    <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">     * The memory element will be increased as the data from curl is</span>
<span style="color: #4c566a;">     * retrieved, so 1 byte is sufficient for now.</span>
<span style="color: #4c566a;">     </span><span style="color: #4c566a;">*/</span>
    dataFromCurl.memory = malloc(1);
    <span style="color: #4c566a;">/* </span><span style="color: #4c566a;">We don't have any data at this point, so the size is 0. </span><span style="color: #4c566a;">*/</span>
    dataFromCurl.size = 0;

    do_curl(&amp;dataFromCurl, url, apikey);

    <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">     * Take the JSON returned from curl and parse it into a Jansson</span>
<span style="color: #4c566a;">     * data structure.</span>
<span style="color: #4c566a;">     </span><span style="color: #4c566a;">*/</span>
    <span style="color: #81A1C1;">if</span> (dataFromCurl.size &lt; 1) {
      fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] No data was returned from cURL, exiting.\n"</span>);
      exit(1);
    }
    rootOfJsonTree = json_loads(dataFromCurl.memory, 0, &amp;error);
    <span style="color: #81A1C1;">if</span> (rootOfJsonTree == <span style="color: #81A1C1;">NULL</span>) {
      fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] JSON decode error message: %s\n"</span>,
              error.text);
      exit(1);
    }
    <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">     * Do something with the results; in this case, just print them</span>
<span style="color: #4c566a;">     * out; storing them for later processing is also a good idea.</span>
<span style="color: #4c566a;">     </span><span style="color: #4c566a;">*/</span>
    print_mo_list(rootOfJsonTree);
    <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">     * Check for more data to get by looking for the 'next' key in the</span>
<span style="color: #4c566a;">     * 'links' section.</span>
<span style="color: #4c566a;">     </span><span style="color: #4c566a;">*/</span>
    links = json_object_get(rootOfJsonTree, <span style="color: #A3BE8C;">"links"</span>);
    <span style="color: #81A1C1;">if</span> (links == <span style="color: #81A1C1;">NULL</span>) {
      fprintf(stderr, <span style="color: #A3BE8C;">"[ERROR] The 'links' element in the "</span>
              <span style="color: #A3BE8C;">"returned JSON is null\n"</span>);
      url = <span style="color: #81A1C1;">NULL</span>;
    } <span style="color: #81A1C1;">else</span> {
      url = json_string_value(json_object_get(links, <span style="color: #A3BE8C;">"next"</span>));
    }
  }
  <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">   * Print a table footer and the version of the SP API that was</span>
<span style="color: #4c566a;">   * used.</span>
<span style="color: #4c566a;">   </span><span style="color: #4c566a;">*/</span>

  meta = json_object_get(rootOfJsonTree, <span style="color: #A3BE8C;">"meta"</span>);
  api_version = json_object_get(meta, <span style="color: #A3BE8C;">"api_version"</span>);
  sp_version = json_object_get(meta, <span style="color: #A3BE8C;">"sp_version"</span>);
  <span style="color: #81A1C1;">for</span> (<span style="color: #8FBCBB;">int</span> <span style="color: #D8DEE9;">i</span> = 0; i &lt; REPORT_WIDTH; i++) {
    printf(<span style="color: #A3BE8C;">"-"</span>);
  }
  printf(<span style="color: #A3BE8C;">"\n"</span>);
  printf(<span style="color: #A3BE8C;">"%80s SP%s/APIv%s\n"</span>,
         <span style="color: #A3BE8C;">"SP REST API version:"</span>, json_string_value(sp_version),
         json_string_value(api_version));
  <span style="color: #4c566a;">/*</span>
<span style="color: #4c566a;">   * Free (or at least decrement the references to) the json data</span>
<span style="color: #4c566a;">   * structure.</span>
<span style="color: #4c566a;">   </span><span style="color: #4c566a;">*/</span>
  json_decref(rootOfJsonTree);
  exit(0);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org94a5d57" class="outline-2">
<h2 id="org94a5d57"><span class="section-number-2">7</span> Appendices</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-orga6e892c" class="outline-3">
<h3 id="orga6e892c"><span class="section-number-3">7.1</span> License</h3>
<div class="outline-text-3" id="text-7-1">
<p>
This work is licensed under the Creative Commons
Attribution-ShareAlike 2.0 Generic License. To view a copy of this
license, visit <a href="http://creativecommons.org/licenses/by-sa/2.0/">http://creativecommons.org/licenses/by-sa/2.0/</a> or
send a letter to Creative Commons, PO Box 1866, Mountain View, CA
94042, USA.
</p>

<p>
The computer programs and code examples are licensed under The
Unlicense
</p>

<blockquote>
<p>
The computer programs and code examples in this work are free and
unencumbered software released into the public domain.
</p>

<p>
Anyone is free to copy, modify, publish, use, compile, sell, or
distribute this software, either in source code form or as a
compiled binary, for any purpose, commercial or non-commercial, and
by any means.
</p>

<p>
THE SOFTWARE IS PROVIDED &ldquo;AS IS&rdquo;, WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT.  IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF
CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</p>

<p>
In jurisdictions that recognize copyright laws, the author or
authors of this software dedicate any and all copyright interest in
the software to the public domain. We make this dedication for the
benefit of the public at large and to the detriment of our heirs
and successors. We intend this dedication to be an overt act of
relinquishment in perpetuity of all present and future rights to
this software under copyright law.
</p>

<p>
For more information, please refer to <a href="http://unlicense.org/">http://unlicense.org/</a>
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org3287bfe" class="outline-3">
<h3 id="org3287bfe"><span class="section-number-3">7.2</span> Versioning</h3>
<div class="outline-text-3" id="text-7-2">
<p>
The SP REST API version number is displayed in the <code>meta</code> section
of every API response.  In version 1 of the SP REST API the version
is stored by the key <code>sp_api_version</code>, in later versions it is
stored in the key <code>api_version</code>.  The <code>meta</code> object looks like:
</p>
<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"meta"</span>: {
        <span style="color: #81A1C1;">"sp_version"</span>: <span style="color: #A3BE8C;">"8.3"</span>,
        <span style="color: #81A1C1;">"api"</span>: <span style="color: #A3BE8C;">"SP"</span>,
        <span style="color: #81A1C1;">"api_version"</span>: <span style="color: #A3BE8C;">"3"</span>,
        <span style="color: #81A1C1;">"sp_build_id"</span>: <span style="color: #A3BE8C;">"HIT4"</span>
    }
}
</pre>
</div>

<p>
It is possible for the API version to remain the same across SP
versions, but that doesn&rsquo;t necessarily mean that the API hasn&rsquo;t
changed.  If keys are <b>added</b> to the API, but none of the existing
keys are changed or removed and none of the types of the values
change, the API version number will not change.  When referring to
what version of the API you are using, the most accurate way is to
combine the API version with the SP version.  In the example above
the version of the API is &ldquo;SP8.3 APIv3&rdquo;.
</p>

<p>
If you have written API clients that rely on a particular version,
you can refer to that version in the URL by inserting <code>/vX/</code> after
<code>/api/sp</code> where <code>X</code> is the version you want to use.  To see the
index for version 1 on an SP leader running SP8.3 you can request
the URL <code>https://spleader.example.com/api/sp/v1/</code> which will
return a meta section that looks like:
</p>

<div class="org-src-container">
<pre class="src src-json">{
    <span style="color: #81A1C1;">"meta"</span>: {
        <span style="color: #81A1C1;">"sp_build_id"</span>: <span style="color: #A3BE8C;">"HIT4"</span>,
        <span style="color: #81A1C1;">"sp_version"</span>: <span style="color: #A3BE8C;">"8.3"</span>,
        <span style="color: #81A1C1;">"api"</span>: <span style="color: #A3BE8C;">"SP"</span>,
        <span style="color: #81A1C1;">"api_version"</span>: <span style="color: #A3BE8C;">"1"</span>,
        <span style="color: #81A1C1;">"sp_api_version"</span>: <span style="color: #A3BE8C;">"1.0.0"</span>
    }
}
</pre>
</div>

<p>
This example is using version &ldquo;SP8.3 APIv1&rdquo; of the API, which is
different from SP8.1 APIv1 because the <code>api_version</code> key does not
exist in SP8.1 APIv1, but because that key is additive and won&rsquo;t
affect clients that are not looking for it the addition of that key
doesn&rsquo;t require an increase in version.
</p>

<p>
Because adding keys is not a change that will prevent a client
written for a previous version from working, it is possible that a
client written for SP8.3 APIv3 will see additional keys when the
server is SP8.4 APIv3.  This also means that writing a client for
an older API version may present keys that don&rsquo;t exist in
original.  For example the addition of the key <code>highly_secure</code> in
SP8.4 APIv4 may also appear in SP8.4 APIv3, but will not exist in
SP8.3 APIv3.  Use caution when writing to prior APIs.
</p>

<p>
The differences in each version are in the Deprecation Policy
section of the SP REST API Reference manual that is available from
the SP UI at the item &ldquo;REST API Documentation&rdquo; in the
&ldquo;Administration&rdquo; menu.
</p>
</div>
</div>

<div id="outline-container-org6921ad0" class="outline-3">
<h3 id="org6921ad0"><span class="section-number-3">7.3</span> Reference Manual</h3>
<div class="outline-text-3" id="text-7-3">
<p>
The SP REST API endpoint reference manual is available from the SP
web interface by going to the &ldquo;Administration&rdquo; menu and choosing
&ldquo;REST API Documentation&rdquo;.
</p>
</div>
</div>

<div id="outline-container-org63ebd39" class="outline-3">
<h3 id="org63ebd39"><span class="section-number-3">7.4</span> Reporting Errors to Arbor</h3>
<div class="outline-text-3" id="text-7-4">
<p>
While Arbor Networks strives to provide you with well-written and
well-tested software, it is possible that your application will
uncover mistakes that we missed.
</p>

<p>
In the case of the SP REST API, these mistakes will present
themselves as a HTTP response with the code <code>500 INTERNAL SERVER
   ERROR</code>.  In nearly all cases this will also print some information
to one of SP&rsquo;s log files.
</p>

<p>
Arbor values your reporting of these errors and to help us diagnose
and fix the problem, it is helpful if you include a few things with
your report to the Arbor Technical Assistance Center.  In order of
their general usefulness to us, these are:
</p>

<ol class="org-ol">
<li><p>
The API request that you made
</p>

<p>
Only the part of the URL from <code>/api/sp</code> onwards is required; we
do not need to have the name of your SP leader
</p></li>

<li><p>
The sections of the logs files with any additional errors
</p>

<p>
One or more of log files <code>syslog</code>, <code>www_access</code>, and <code>www_error</code>
in the directory <code>/base/var/log/</code> on SP will likely have a
Python traceback in them if you see an error with an HTTP status
code of 500; a copy of that will be very useful for us.
</p></li>

<li><p>
The <code>meta</code> information from any API request
</p>

<p>
Making a request to <code>https://spleader.example.com/api/sp/</code> and
sending us the results will contain the <code>meta</code> information that
we need.
</p></li>

<li>The expected results or results of a similar query that works</li>

<li><p>
The SP diagnostics package
</p>

<p>
A diagnostics package can be created from the SP command line by
typing <code>system diagnostics</code>
</p></li>
</ol>

<p>
The Arbor Technical Assistance Center can be reached at
<a href="http://support.arbornetworks.com">http://support.arbornetworks.com</a>
</p>
</div>
</div>

<div id="outline-container-org17cecff" class="outline-3">
<h3 id="org17cecff"><span class="section-number-3">7.5</span> Acknowledgments</h3>
<div class="outline-text-3" id="text-7-5">
<p>
Thanks to:
</p>

<p>
Andrea V, Andy C, David W, Grant L, Jen V, Todd S, Tony P.
</p>
</div>
</div>
<div id="outline-container-orgf624cd4" class="outline-3">
<h3 id="orgf624cd4"><span class="section-number-3">7.6</span> Contributing and other technical details</h3>
<div class="outline-text-3" id="text-7-6">
</div>
<div id="outline-container-org8b77b41" class="outline-4">
<h4 id="org8b77b41"><span class="section-number-4">7.6.1</span> Contributing</h4>
<div class="outline-text-4" id="text-7-6-1">
<p>
This document is intended to grow and change based on contributions
from customers, Arbor field engineers, Arbor development engineers,
and anyone else who wants to contribute.
</p>

<p>
The contribution guidelines are pretty loose, but include things
like:
</p>
<ul class="org-ul">
<li>the example should include both the source code and the
surrounding text explaining it; a patch or pull request or two
files or some other representation is fine</li>
<li>the example should try to minimize external dependencies,
unless the point of the example is to should how to use them</li>
<li>the example should work and be readable by someone who is
familiar with programming languages, either because it is a
readable language or because the program has a lot of comments</li>
</ul>

<p>
If you are contributing from within Arbor, you can use Reviewboard
to submit your contributions against the internal repository.
</p>

<p>
If you are contributing from outside of Arbor or just prefer
Github, you can fork the repository and send pull requests with
the changes.
</p>

<p>
If you don&rsquo;t want to deal with Git at all, you can email
<code>acaird@arbor.net</code> with the contribution and I&rsquo;ll probably get
around to it.
</p>
</div>
</div>
<div id="outline-container-org8b6728b" class="outline-4">
<h4 id="org8b6728b"><span class="section-number-4">7.6.2</span> Technical details</h4>
<div class="outline-text-4" id="text-7-6-2">
<p>
This document is written using the OrgMode markup and is rendered
into using Emacs and LaTeX and into HTML using Emacs.
</p>

<p>
It may be possible to render this document into other formats
using <code>pandoc</code>, but that is untested.
</p>
</div>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
<a href="http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven">http://roy.gbiv.com/untangled/2008/rest-apis-must-be-hypertext-driven</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.2" class="footnum" href="#fnr.2">2</a></sup> <div class="footpara"><p class="footpara">
<a href="https://www.google.com/chrome/">https://www.google.com/chrome/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.3" class="footnum" href="#fnr.3">3</a></sup> <div class="footpara"><p class="footpara">
<a href="https://www.gnu.org/software/sed/">https://www.gnu.org/software/sed/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.4" class="footnum" href="#fnr.4">4</a></sup> <div class="footpara"><p class="footpara">
<a href="https://www.gnu.org/software/gawk/">https://www.gnu.org/software/gawk/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.5" class="footnum" href="#fnr.5">5</a></sup> <div class="footpara"><p class="footpara">
<a href="https://matplotlib.org/">https://matplotlib.org/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.6" class="footnum" href="#fnr.6">6</a></sup> <div class="footpara"><p class="footpara">
<a href="https://arrow.readthedocs.io/en/latest/">https://arrow.readthedocs.io/en/latest/</a>
</p></div></div>

<div class="footdef"><sup><a id="fn.7" class="footnum" href="#fnr.7">7</a></sup> <div class="footpara"><p class="footpara">
<a href="https://github.com/fangyidong/json-simple">https://github.com/fangyidong/json-simple</a>
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="date">Date: 2017-07-14 Fri 00:00</p>
<p class="author">Author: Arbor Networks</p>
<p class="date">Created: 2018-01-25 Thu 16:04</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
